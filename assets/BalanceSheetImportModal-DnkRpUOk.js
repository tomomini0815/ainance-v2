import{I as F,r as b,j as e,F as A,X as H,U as X,S as Q,P as ie,q as ce,d as B,G as _,x as de}from"./index-CIKZNbWN.js";import{analyzePLDocumentWithVision as me,analyzeBSDocumentWithVision as xe}from"./geminiAIService-DZAAZO20.js";import{L as P}from"./loader-circle-oE64RS5e.js";import{A as Z}from"./arrow-right-FWvQseBp.js";import{A as ee}from"./arrow-left-PnCl6t8i.js";import{S as te}from"./save-CGQoR7vb.js";const J={async getByYear(s,m,l){const{data:x,error:o}=await F.from("yearly_settlements").select("*").eq("user_id",s).eq("business_type",m).eq("year",l).single();if(o){if(o.code==="PGRST116")return null;throw console.error("getYearlySettlement Error:",o),o}return x},async getAllByBusinessType(s,m){const{data:l,error:x}=await F.from("yearly_settlements").select("*").eq("user_id",s).eq("business_type",m).order("year",{ascending:!1});if(x)throw console.error("getAllYearlySettlements Error:",x),x;return l||[]},async save(s){console.log("--- yearlySettlementService.save Start ---",s);const{data:m,error:l}=await F.from("yearly_settlements").upsert({...s,updated_at:new Date().toISOString()},{onConflict:"user_id,business_type,year"}).select().single();if(l)throw console.error("saveYearlySettlement Error Full:",l),console.error("Error Details:",l.details),console.error("Error Hint:",l.hint),console.error("Error Code:",l.code),l;return console.log("saveYearlySettlement Success:",m),m},mapAiResultToSettlement(s,m,l,x={}){console.log("--- AI Result Mapping Start ---"),console.log("Raw AI Result:",JSON.stringify(s,null,2));const o=i=>{if(i==null||i==="")return 0;if(typeof i=="number")return i;let a=String(i).replace(/[$,¥円\s,()]/g,""),p=!1;(a.startsWith("△")||a.startsWith("▲")||a.startsWith("-"))&&(p=!0,a=a.substring(1));let g=1;a.includes("千万")?(g=1e7,a=a.replace("千万","")):a.includes("百万")?(g=1e6,a=a.replace("百万","")):a.includes("千")?(g=1e3,a=a.replace("千","")):a.includes("万")&&(g=1e4,a=a.replace("万",""));const y=parseFloat(a),j=isNaN(y)?0:y*g,S=p?-j:j;return Math.floor(S)},r=i=>{if(!(!s||typeof s!="object"))for(const a of i){if(s[a]!==void 0&&s[a]!==null)return s[a];const p=a.toLowerCase(),g=Object.keys(s).find(y=>y.toLowerCase()===p);if(g)return s[g]}},h=i=>Array.isArray(i)?i.map(a=>({category:String(a.category||a.name||a.項目||a.科目||"その他").trim(),amount:o(a.amount||a.value||a.price||a.金額)})).filter(a=>a.category&&a.amount!==0):[],u={user_id:m,business_type:l,year:o(r(["year","年度","決算年度","target_year"]))||new Date().getFullYear()-1,revenue:o(r(["revenue","sales","total_revenue","売上","売上高","収入金額","営業収益"])),cost_of_sales:o(r(["cost_of_sales","purchases","売上原価","仕入","仕入高","当期商品仕入高"])),operating_expenses:o(r(["operating_expenses","expenses","sga_expenses","販管費","販売費及び一般管理費","経費合計","営業費用"])),non_operating_income:o(r(["non_operating_income","営業外収益"])),non_operating_expenses:o(r(["non_operating_expenses","営業外費用","営業外支出"])),extraordinary_income:o(r(["extraordinary_income","特別利益","特別収益"])),extraordinary_loss:o(r(["extraordinary_loss","特別損失","特別支出"])),income_before_tax:o(r(["income_before_tax","税引前当期純利益","税金等調整前当期純利益"])),net_income:o(r(["net_income","profit","net_profit","当期純利益","利益"])),category_breakdown:h(s.category_breakdown||s.items||s.内訳||s.項目別||[]),metadata:{...x,confidence:s.confidence}};return console.log("Mapped Settlement Data:",u),console.log("--- AI Result Mapping End ---"),u}},K={async getByYear(s,m,l){const{data:x,error:o}=await F.from("yearly_balance_sheets").select("*").eq("user_id",s).eq("business_type",m).eq("year",l).single();if(o){if(o.code==="PGRST116")return null;throw console.error("getYearlyBalanceSheet Error:",o),o}return x},async getAllByBusinessType(s,m){const{data:l,error:x}=await F.from("yearly_balance_sheets").select("*").eq("user_id",s).eq("business_type",m).order("year",{ascending:!1});if(x)throw console.error("getAllYearlyBalanceSheets Error:",x),x;return l||[]},async save(s){console.log("--- yearlyBalanceSheetService.save Start ---",s);const{data:m,error:l}=await F.from("yearly_balance_sheets").upsert({...s,updated_at:new Date().toISOString()},{onConflict:"user_id,business_type,year"}).select().single();if(l)throw console.error("saveYearlyBalanceSheet Error Full:",l),console.error("Error Details:",l.details),console.error("Error Hint:",l.hint),console.error("Error Code:",l.code),l;return console.log("saveYearlyBalanceSheet Success:",m),m},mapAiResultToBS(s,m,l,x={}){console.log("--- BS Result Mapping Start ---");const o=u=>{if(u==null||u==="")return 0;if(typeof u=="number")return u;let i=String(u).replace(/[$,¥円\s,()]/g,""),a=!1;(i.startsWith("△")||i.startsWith("▲")||i.startsWith("-"))&&(a=!0,i=i.substring(1));let p=1;i.includes("千万")?p=1e7:i.includes("百万")?p=1e6:i.includes("千")?p=1e3:i.includes("万")&&(p=1e4);const g=parseFloat(i.replace(/[千万万円]/g,"")),y=isNaN(g)?0:g*p;return Math.floor(a?-y:y)},r=u=>{if(!(!s||typeof s!="object"))for(const i of u){if(s[i]!==void 0&&s[i]!==null)return s[i];const a=i.toLowerCase(),p=Object.keys(s).find(g=>g.toLowerCase()===a);if(p)return s[p]}},h={user_id:m,business_type:l,year:o(r(["year","年度","決算年度"]))||new Date().getFullYear()-1,assets_current_cash:o(r(["assets_current_cash","現金及び預金","現金預金"])),assets_current_total:o(r(["assets_current_total","流動資産合計"])),assets_total:o(r(["assets_total","資産の部合計","資産合計"])),liabilities_total:o(r(["liabilities_total","負債の部合計","負債合計"])),net_assets_capital:o(r(["net_assets_capital","資本金"])),net_assets_retained_earnings:o(r(["net_assets_retained_earnings","繰越利益剰余金"])),net_assets_retained_earnings_total:o(r(["net_assets_retained_earnings_total","利益剰余金合計","その他利益剰余金合計"])),net_assets_shareholders_equity:o(r(["net_assets_shareholders_equity","株主資本合計"])),net_assets_total:o(r(["net_assets_total","純資産の部合計","純資産合計"])),liabilities_and_net_assets_total:o(r(["liabilities_and_net_assets_total","負債及び純資産の部合計","負債純資産合計"])),metadata:{...x,confidence:s.confidence}};return console.log("Mapped BS Data:",h),h}},se={async uploadFinancialDocument(s,m,l,x){try{const o=m.name.split(".").pop(),r=`${l}_${x}_${Date.now()}.${o}`,h=`${s}/${r}`;console.log("Uploading file to:",h);const{data:u,error:i}=await F.storage.from("financial_documents").upload(h,m,{cacheControl:"3600",upsert:!1});if(i)throw console.error("Storage Upload Error:",i),i;return console.log("File uploaded successfully:",u.path),u.path}catch(o){throw console.error("uploadFinancialDocument Error:",o),o}},async getSignedUrl(s){try{if(!s)return null;const{data:m,error:l}=await F.storage.from("financial_documents").createSignedUrl(s,3600);return l?(console.error("Get Signed URL Error:",l),null):m.signedUrl}catch(m){return console.error("getSignedUrl Error:",m),null}}},_e=({isOpen:s,onClose:m,userId:l,businessType:x,onImportSuccess:o})=>{const[r,h]=b.useState(1),[u,i]=b.useState(!1),[a,p]=b.useState(!1),[g,y]=b.useState(!1),[j,S]=b.useState(null),z=b.useRef(null),[c,v]=b.useState({user_id:l,business_type:x,year:new Date().getFullYear()-1,revenue:0,cost_of_sales:0,operating_expenses:0,non_operating_income:0,non_operating_expenses:0,extraordinary_income:0,extraordinary_loss:0,income_before_tax:0,net_income:0,category_breakdown:[],metadata:{},document_path:void 0});if(b.useEffect(()=>{s&&(h(1),S(null),i(!1),p(!1),v({user_id:l,business_type:x,year:new Date().getFullYear()-1,revenue:0,cost_of_sales:0,operating_expenses:0,non_operating_income:0,non_operating_expenses:0,extraordinary_income:0,extraordinary_loss:0,income_before_tax:0,net_income:0,category_breakdown:[],metadata:{},document_path:void 0}))},[s,l,x]),!s)return null;const E=async t=>{if(!t)return;const n=t.type.startsWith("image/"),d=t.type==="application/pdf";if(!n&&!d){_.error("画像ファイル（JPG/PNG）またはPDFファイルのみ対応しています");return}S(t),i(!0);try{const f=new FileReader;f.onloadend=async()=>{const C=f.result,D=await me(C);if(D){const I=J.mapAiResultToSettlement(D,l,x,{fileName:t.name});v(I),h(2),_.success("解析が完了しました。内容を確認してください。")}else _.error("解析に失敗しました。手動で入力してください。"),h(2);i(!1)},f.readAsDataURL(t)}catch(f){console.error("File Analysis Error:",f),_.error("解析中にエラーが発生しました"),i(!1),h(2)}},Y=t=>{var d;const n=(d=t.target.files)==null?void 0:d[0];n&&E(n)},$=t=>{t.preventDefault(),t.stopPropagation(),!u&&r===1&&y(!0)},q=t=>{t.preventDefault(),t.stopPropagation(),y(!1)},L=t=>{var n;if(t.preventDefault(),t.stopPropagation(),y(!1),!u&&r===1){const d=(n=t.dataTransfer.files)==null?void 0:n[0];d&&E(d)}},N=async()=>{p(!0);try{if(!c.year||c.year<2e3||c.year>2100){_.error("有効な年度を入力してください"),p(!1);return}let t;if(j)try{_.loading("ファイルをアップロード中...",{id:"upload-toast"}),t=await se.uploadFinancialDocument(l,j,c.year,"pl"),t&&_.success("ファイルのアップロード完了",{id:"upload-toast"})}catch(d){console.error("File Upload Error:",d),_.error("ファイルのアップロードに失敗しました",{id:"upload-toast"})}const n={...c,document_path:t||c.document_path};await J.save(n),o(),h(3),p(!1)}catch(t){console.error("Save Error:",t),_.error("保存に失敗しました"),p(!1)}},U=()=>{S(null),v({...c,year:new Date().getFullYear()-1}),h(2)},M=()=>{h(1),S(null),v({...c,year:new Date().getFullYear()-1,revenue:0,cost_of_sales:0,operating_expenses:0,non_operating_income:0,non_operating_expenses:0,extraordinary_income:0,extraordinary_loss:0,income_before_tax:0,net_income:0,category_breakdown:[],document_path:void 0})},k=(t,n)=>{v(d=>({...d,[t]:n}))},V=()=>{v(t=>({...t,category_breakdown:[...t.category_breakdown,{category:"",amount:0,percentage:0}]}))},w=(t,n,d)=>{v(f=>{const C=[...f.category_breakdown];return C[t]={...C[t],[n]:d},{...f,category_breakdown:C}})},G=t=>{v(n=>({...n,category_breakdown:n.category_breakdown.filter((d,f)=>f!==t)}))},W=()=>e.jsx("div",{className:"flex items-center justify-center mb-8",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`
                        flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm
                        ${r>=t?"bg-primary text-white":"bg-surface-highlight text-text-muted"}
                        transition-colors duration-300
                    `,children:r>t?e.jsx(B,{className:"w-5 h-5"}):t}),e.jsxs("span",{className:`ml-2 text-sm font-medium ${r>=t?"text-text-main":"text-text-muted"}`,children:[t===1&&"アップロード",t===2&&"データ確認",t===3&&"完了"]}),t<3&&e.jsx("div",{className:`w-12 h-0.5 mx-4 ${r>t?"bg-primary":"bg-surface-highlight"}`})]},t))});return e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-surface border border-border rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl",onDragOver:$,onDragLeave:q,onDrop:L,children:[e.jsxs("div",{className:"px-6 py-4 border-b border-border flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-text-main flex items-center",children:[e.jsx(A,{className:"w-5 h-5 mr-2 text-primary"}),"前年度決算データのインポート"]}),e.jsx("button",{onClick:m,className:"text-text-muted hover:text-text-main transition-colors",children:e.jsx(H,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[W(),r===1&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full min-h-[400px]",children:[e.jsxs("div",{onClick:()=>{var t;return(t=z.current)==null?void 0:t.click()},className:`
                                    w-full max-w-2xl text-center p-12 rounded-2xl border-2 border-dashed cursor-pointer transition-all duration-300
                                    ${g?"border-primary bg-primary/10 scale-[1.02]":"border-border hover:border-primary/50 hover:bg-surface-highlight"}
                                `,children:[e.jsx("input",{type:"file",ref:z,className:"hidden",accept:"image/*,.pdf",onChange:Y}),e.jsx("div",{className:"bg-primary/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6",children:u?e.jsx(P,{className:"w-10 h-10 text-primary animate-spin"}):e.jsx(X,{className:"w-10 h-10 text-primary"})}),e.jsx("h3",{className:"text-xl font-bold text-text-main mb-2",children:u?"AI解析中...":"決算書をアップロード"}),e.jsx("p",{className:"text-text-muted mb-6",children:u?"画像を解析してデータを抽出しています":"PDFまたは画像ファイル（JPG/PNG）をドラッグ＆ドロップ"}),!u&&e.jsx("button",{className:"btn-primary px-8 py-3 rounded-full shadow-lg hover:shadow-primary/25",children:"ファイルを選択"})]}),e.jsxs("div",{className:"mt-8 flex items-center w-full max-w-2xl",children:[e.jsx("div",{className:"h-px bg-border flex-1"}),e.jsx("span",{className:"px-4 text-text-muted text-sm",children:"または"}),e.jsx("div",{className:"h-px bg-border flex-1"})]}),e.jsxs("button",{onClick:U,className:"mt-8 flex items-center text-text-muted hover:text-primary transition-colors font-medium group",children:["手動で入力する",e.jsx(Z,{className:"w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform"})]})]}),r===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-surface-highlight/30 rounded-lg p-4 mb-6 border border-border/50",children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-main mb-2 flex items-center",children:[e.jsx(Q,{className:"w-4 h-4 text-primary mr-2"}),"データ確認・修正"]}),e.jsx("p",{className:"text-sm text-text-muted",children:j?"AI解析によって抽出されたデータです。誤りがないか確認し、必要に応じて修正してください。":"手動でデータを入力してください。"}),j&&e.jsxs("div",{className:"mt-3 flex items-center text-xs text-text-muted bg-surface/50 p-2 rounded border border-border",children:[e.jsx(A,{className:"w-3 h-3 mr-2"}),"参照ファイル: ",j.name]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"対象年度"}),e.jsx("input",{type:"number",value:c.year,onChange:t=>k("year",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"売上高"}),e.jsx("input",{type:"number",value:c.revenue,onChange:t=>k("revenue",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"売上原価"}),e.jsx("input",{type:"number",value:c.cost_of_sales,onChange:t=>k("cost_of_sales",parseInt(t.target.value)),className:"input-field"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"販売費及び一般管理費"}),e.jsx("input",{type:"number",value:c.operating_expenses,onChange:t=>k("operating_expenses",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"営業外収益"}),e.jsx("input",{type:"number",value:c.non_operating_income,onChange:t=>k("non_operating_income",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"営業外費用"}),e.jsx("input",{type:"number",value:c.non_operating_expenses,onChange:t=>k("non_operating_expenses",parseInt(t.target.value)),className:"input-field"})]})]})]}),e.jsxs("div",{className:"bg-surface-highlight/10 rounded-xl p-5 border border-border mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-text-main flex items-center",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-purple-500 mr-2"}),"主要カテゴリ別内訳（任意）"]}),e.jsxs("button",{onClick:V,className:"text-xs flex items-center text-primary hover:text-primary-light transition-colors",children:[e.jsx(ie,{className:"w-3 h-3 mr-1"}),"カテゴリを追加"]})]}),e.jsxs("div",{className:"space-y-3",children:[c.category_breakdown.map((t,n)=>e.jsxs("div",{className:"flex items-center gap-3 bg-surface-highlight/20 p-3 rounded-lg border border-border/50 group",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",placeholder:"カテゴリ名（例: 商品売上）",value:t.category,onChange:d=>w(n,"category",d.target.value),className:"w-full bg-transparent border-none p-0 text-sm focus:ring-0 text-text-main placeholder-text-muted/50"})}),e.jsxs("div",{className:"w-32 relative",children:[e.jsx("span",{className:"absolute left-2 top-1/2 -translate-y-1/2 text-text-muted text-xs",children:"¥"}),e.jsx("input",{type:"number",placeholder:"金額",value:t.amount,onChange:d=>w(n,"amount",parseInt(d.target.value)),className:"w-full bg-surface-highlight/50 border border-border rounded-md pl-6 pr-2 py-1 text-right text-sm font-mono focus:ring-1 focus:ring-primary"})]}),e.jsx("button",{onClick:()=>G(n),className:"w-6 h-6 flex items-center justify-center text-text-muted hover:text-red-500 hover:bg-red-500/10 rounded opacity-0 group-hover:opacity-100 transition-all",children:e.jsx(ce,{className:"w-4 h-4"})})]},n)),c.category_breakdown.length===0&&e.jsx("p",{className:"text-xs text-text-muted text-center py-4 border-2 border-dashed border-border/50 rounded-lg",children:"内訳を登録すると、統計比較がより詳細になります。"})]})]}),e.jsx("div",{className:"border-t border-border pt-6 mt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"特別利益"}),e.jsx("input",{type:"number",value:c.extraordinary_income,onChange:t=>k("extraordinary_income",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"特別損失"}),e.jsx("input",{type:"number",value:c.extraordinary_loss,onChange:t=>k("extraordinary_loss",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-primary mb-1",children:"当期純利益"}),e.jsx("input",{type:"number",value:c.net_income,onChange:t=>k("net_income",parseInt(t.target.value)),className:"input-field border-primary/50 bg-primary/5 font-bold"})]})]})})]}),r===3&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full py-12",children:[e.jsx("div",{className:"w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mb-6",children:e.jsx(B,{className:"w-10 h-10 text-green-500"})}),e.jsx("h3",{className:"text-2xl font-bold text-text-main mb-2",children:"インポート完了"}),e.jsxs("p",{className:"text-text-muted mb-8 text-center max-w-md",children:["前年度データの保存が完了しました。",e.jsx("br",{}),"経営分析の比較データとして利用されます。"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:m,className:"btn-ghost",children:"閉じる"}),e.jsx("button",{onClick:M,className:"btn-primary",children:"続けてインポートする"})]})]})]}),r===2&&e.jsxs("div",{className:"px-6 py-4 border-t border-border flex items-center justify-between bg-surface-highlight/30",children:[e.jsxs("button",{onClick:()=>h(1),className:"flex items-center text-text-muted hover:text-text-main transition-colors",children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("button",{onClick:N,disabled:a,className:"btn-primary min-w-[140px]",children:a?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"保存して完了"]})})]})]})})},ye=({isOpen:s,onClose:m,userId:l,businessType:x,onImportSuccess:o})=>{const[r,h]=b.useState(1),[u,i]=b.useState(!1),[a,p]=b.useState(!1),[g,y]=b.useState(!1),[j,S]=b.useState(null),z=b.useRef(null),[c,v]=b.useState({user_id:l,business_type:x,year:new Date().getFullYear()-1,assets_current_cash:0,assets_current_total:0,assets_total:0,liabilities_total:0,net_assets_capital:0,net_assets_retained_earnings:0,net_assets_retained_earnings_total:0,net_assets_shareholders_equity:0,net_assets_total:0,liabilities_and_net_assets_total:0,metadata:{},document_path:void 0});if(b.useEffect(()=>{s&&(h(1),S(null),i(!1),p(!1),v({user_id:l,business_type:x,year:new Date().getFullYear()-1,assets_current_cash:0,assets_current_total:0,assets_total:0,liabilities_total:0,net_assets_capital:0,net_assets_retained_earnings:0,net_assets_retained_earnings_total:0,net_assets_shareholders_equity:0,net_assets_total:0,liabilities_and_net_assets_total:0,metadata:{},document_path:void 0}))},[s,l,x]),!s)return null;const E=async t=>{if(!t)return;const n=t.type.startsWith("image/"),d=t.type==="application/pdf";if(!n&&!d){_.error("画像またはPDFファイルを選択してください");return}S(t),i(!0);try{const f=new FileReader;f.onloadend=async()=>{const C=f.result,D=await xe(C);if(D){const I=K.mapAiResultToBS(D,l,x,{fileName:t.name});v(I),h(2),_.success("解析が完了しました。内容を確認してください。")}else _.error("解析に失敗しました。数値を直接入力してください。"),h(2);i(!1)},f.readAsDataURL(t)}catch(f){console.error("BS Analysis Error:",f),_.error("解析中にエラーが発生しました"),i(!1),h(2)}},Y=t=>{var d;const n=(d=t.target.files)==null?void 0:d[0];n&&E(n)},$=t=>{t.preventDefault(),t.stopPropagation(),!u&&r===1&&y(!0)},q=t=>{t.preventDefault(),t.stopPropagation(),y(!1)},L=t=>{var n;if(t.preventDefault(),t.stopPropagation(),y(!1),!u&&r===1){const d=(n=t.dataTransfer.files)==null?void 0:n[0];d&&E(d)}},N=(t,n)=>{let d=typeof n=="string"?parseInt(n)||0:n;v(f=>({...f,[t]:d}))},U=async()=>{p(!0);try{let t;if(j)try{_.loading("ファイルをアップロード中...",{id:"upload-toast"}),t=await se.uploadFinancialDocument(l,j,c.year,"bs"),t&&_.success("ファイルのアップロード完了",{id:"upload-toast"})}catch(d){console.error("File Upload Error:",d),_.error("ファイルのアップロードに失敗しました",{id:"upload-toast"})}const n={...c,document_path:t||c.document_path};await K.save(n),o(),h(3),p(!1)}catch(t){console.error("Save BS Error:",t),_.error("保存に失敗しました"),p(!1)}},M=()=>{S(null),v({...c,year:new Date().getFullYear()-1}),h(2)},k=()=>{h(1),S(null),v({user_id:l,business_type:x,year:new Date().getFullYear()-1,assets_current_cash:0,assets_current_total:0,assets_total:0,liabilities_total:0,net_assets_capital:0,net_assets_retained_earnings:0,net_assets_retained_earnings_total:0,net_assets_shareholders_equity:0,net_assets_total:0,liabilities_and_net_assets_total:0,metadata:{},document_path:void 0})},V=t=>{const n=t<0,d=Math.abs(t);return(n?"△":"")+d.toLocaleString()},w=({label:t,value:n,onChange:d,indent:f=!1,indentPlus:C=!1,isBold:D=!1,isTotal:I=!1})=>{const[re,R]=b.useState(!1),[O,T]=b.useState(n.toString());b.useEffect(()=>{T(n.toString())},[n]);const ae=()=>{R(!1),d(parseInt(O)||0)},ne=()=>{T(n.toString()),R(!0)},le=V(n);return e.jsxs("div",{className:`flex justify-between items-end border-b ${I?"border-zinc-800 border-b-2":"border-zinc-200"} py-1.5 group transition-colors hover:bg-zinc-50 dark:hover:bg-zinc-900/50`,children:[e.jsx("div",{className:`${f?"pl-4":C?"pl-8":""} ${D?"font-bold":"text-zinc-700 dark:text-zinc-300"} text-sm`,children:t}),e.jsx("div",{className:"w-36 text-right relative",children:re?e.jsx("input",{type:"number",value:O,onChange:oe=>T(oe.target.value),onBlur:ae,autoFocus:!0,className:"w-full bg-white dark:bg-zinc-800 border-b-2 border-primary text-right outline-none font-mono py-0.5 px-1 rounded-t-sm shadow-sm"}):e.jsx("div",{onClick:ne,className:`w-full cursor-text text-right font-mono text-sm ${D?"font-bold text-zinc-900 dark:text-zinc-50":"text-zinc-800 dark:text-zinc-200"} ${n<0?"text-error":""} py-0.5 px-1 hover:bg-zinc-200/50 dark:hover:bg-zinc-700/50 rounded transition-colors`,children:le})})]})},G=c.assets_total!==c.liabilities_and_net_assets_total,W=()=>e.jsx("div",{className:"flex items-center justify-center mb-8",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`
                        flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm
                        ${r>=t?"bg-primary text-white":"bg-surface-highlight text-text-muted"}
                        transition-colors duration-300
                    `,children:r>t?e.jsx(B,{className:"w-5 h-5"}):t}),e.jsxs("span",{className:`ml-2 text-sm font-medium ${r>=t?"text-text-main":"text-text-muted"}`,children:[t===1&&"アップロード",t===2&&"データ確認",t===3&&"完了"]}),t<3&&e.jsx("div",{className:`w-12 h-0.5 mx-4 ${r>t?"bg-primary":"bg-surface-highlight"}`})]},t))});return e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-surface border border-border rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl",onDragOver:$,onDragLeave:q,onDrop:L,children:[e.jsxs("div",{className:"px-6 py-4 border-b border-border flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-text-main flex items-center",children:[e.jsx(A,{className:"w-5 h-5 mr-2 text-primary"}),"貸借対照表（BS）のインポート"]}),e.jsx("button",{onClick:m,className:"text-text-muted hover:text-text-main transition-colors",children:e.jsx(H,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-border scrollbar-track-transparent",children:[W(),r===1&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full min-h-[400px]",children:[e.jsxs("div",{onClick:()=>{var t;return(t=z.current)==null?void 0:t.click()},className:`
                                    w-full max-w-2xl text-center p-12 rounded-2xl border-2 border-dashed cursor-pointer transition-all duration-300
                                    ${g?"border-primary bg-primary/10 scale-[1.02]":"border-border hover:border-primary/50 hover:bg-surface-highlight"}
                                `,children:[e.jsx("input",{type:"file",ref:z,onChange:Y,className:"hidden",accept:"image/*,.pdf"}),e.jsx("div",{className:"bg-primary/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6",children:u?e.jsx(P,{className:"w-10 h-10 text-primary animate-spin"}):e.jsx(X,{className:"w-10 h-10 text-primary"})}),e.jsx("h3",{className:"text-xl font-bold text-text-main mb-2",children:u?"AI解析中...":"貸借対照表をアップロード"}),e.jsx("p",{className:"text-text-muted mb-6",children:u?"画像を解析してデータを抽出しています":"PDFまたは画像ファイル（JPG/PNG）をドラッグ＆ドロップ"}),!u&&e.jsx("button",{className:"btn-primary px-8 py-3 rounded-full shadow-lg hover:shadow-primary/25",children:"ファイルを選択"})]}),e.jsxs("div",{className:"mt-8 flex items-center w-full max-w-2xl",children:[e.jsx("div",{className:"h-px bg-border flex-1"}),e.jsx("span",{className:"px-4 text-text-muted text-sm",children:"または"}),e.jsx("div",{className:"h-px bg-border flex-1"})]}),e.jsxs("button",{onClick:M,className:"mt-8 flex items-center text-text-muted hover:text-primary transition-colors font-medium group",children:["手動で入力する",e.jsx(Z,{className:"w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform"})]})]}),r===2&&e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"bg-surface-highlight/30 rounded-lg p-4 mb-6 border border-border/50",children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-main mb-2 flex items-center",children:[e.jsx(Q,{className:"w-4 h-4 text-primary mr-2"}),"データ確認・修正"]}),e.jsx("p",{className:"text-sm text-text-muted",children:j?"AI解析によって抽出されたデータです。内容を確認してください。":"手動でデータを入力してください。"}),j&&e.jsxs("div",{className:"mt-3 flex items-center text-xs text-text-muted bg-surface/50 p-2 rounded border border-border",children:[e.jsx(A,{className:"w-3 h-3 mr-2"}),"参照ファイル: ",j.name]})]}),e.jsxs("div",{className:"font-serif bg-white dark:bg-zinc-950 p-8 rounded-xl shadow-inner border border-border/50 text-zinc-900 dark:text-zinc-100",children:[e.jsx("h2",{className:"text-2xl text-center mb-2 font-bold",children:"貸借対照表"}),e.jsxs("div",{className:"text-center text-sm mb-8 flex items-center justify-center gap-2",children:[e.jsx("input",{type:"number",value:c.year,onChange:t=>N("year",t.target.value),className:"w-20 bg-transparent border-b border-zinc-300 text-center font-bold outline-none"}),e.jsx("span",{children:"年12月31日 現在"})]}),e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold border-b-2 border-zinc-500 mb-4 pb-1",children:"資産の部"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"pl-4 text-xs font-bold text-zinc-500 mb-1",children:"【流動資産】"}),e.jsx(w,{label:"現金 及び 預金",value:c.assets_current_cash,onChange:t=>N("assets_current_cash",t),indent:!0}),e.jsx(w,{label:"流動資産合計",value:c.assets_current_total,onChange:t=>N("assets_current_total",t),indent:!0}),e.jsx(w,{label:"資産の部合計",value:c.assets_total,onChange:t=>N("assets_total",t),isBold:!0,isTotal:!0})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold border-b-2 border-zinc-500 mb-4 pb-1",children:"負債の部"}),e.jsx(w,{label:"負債の部合計",value:c.liabilities_total,onChange:t=>N("liabilities_total",t)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold border-b-2 border-zinc-500 mb-4 pb-1",children:"純資産の部"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"pl-4 text-xs font-bold text-zinc-500 mb-1",children:"【株主資本】"}),e.jsx(w,{label:"資 本 金",value:c.net_assets_capital,onChange:t=>N("net_assets_capital",t),indent:!0}),e.jsx("div",{className:"pl-4 text-xs text-zinc-500 py-1",children:"その他利益剰余金"}),e.jsx(w,{label:"繰越利益剰余金",value:c.net_assets_retained_earnings,onChange:t=>N("net_assets_retained_earnings",t),indentPlus:!0}),e.jsx(w,{label:"利益剰余金合計",value:c.net_assets_retained_earnings_total,onChange:t=>N("net_assets_retained_earnings_total",t),indent:!0}),e.jsx(w,{label:"株主資本合計",value:c.net_assets_shareholders_equity,onChange:t=>N("net_assets_shareholders_equity",t),indent:!0,isBold:!0}),e.jsx(w,{label:"純資産の部合計",value:c.net_assets_total,onChange:t=>N("net_assets_total",t),isBold:!0}),e.jsx(w,{label:"負債及び純資産の部合計",value:c.liabilities_and_net_assets_total,onChange:t=>N("liabilities_and_net_assets_total",t),isBold:!0,isTotal:!0})]})]})]}),G&&e.jsxs("div",{className:"mt-6 p-3 bg-red-500/10 border border-red-500/20 rounded-lg flex items-center gap-2 text-red-600 dark:text-red-400 text-xs font-bold",children:[e.jsx(de,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:["資産合計と負債・純資産合計が一致していません（差額: ¥",(c.assets_total-c.liabilities_and_net_assets_total).toLocaleString(),"）"]})]})]})]}),r===3&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full py-12",children:[e.jsx("div",{className:"w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mb-6",children:e.jsx(B,{className:"w-10 h-10 text-green-500"})}),e.jsx("h3",{className:"text-2xl font-bold text-text-main mb-2",children:"インポート完了"}),e.jsxs("p",{className:"text-text-muted mb-8 text-center max-w-md",children:["貸借対照表データの保存が完了しました。",e.jsx("br",{}),"経営分析の比較データとして利用されます。"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:m,className:"btn-ghost",children:"閉じる"}),e.jsx("button",{onClick:k,className:"btn-primary",children:"続けてインポートする"})]})]})]}),r===2&&e.jsxs("div",{className:"px-6 py-4 border-t border-border flex items-center justify-between bg-surface-highlight/30",children:[e.jsxs("button",{onClick:()=>h(1),className:"flex items-center text-text-muted hover:text-text-main transition-colors",children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("button",{onClick:U,disabled:a,className:"btn-primary min-w-[140px]",children:a?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"保存して完了"]})})]})]})})};export{ye as B,_e as P,K as a,se as s,J as y};
