<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFåº§æ¨™ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚¿ãƒ¼ - Visual Calibration Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .pdf-panel {
            flex: 1;
            overflow: auto;
            position: relative;
            padding: 20px;
            background: #16213e;
        }

        .sidebar {
            width: 450px;
            background: #0f3460;
            padding: 20px;
            overflow-y: auto;
        }

        h1 {
            color: #e94560;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        h2 {
            color: #0abde3;
            margin: 15px 0 10px;
            font-size: 1em;
            border-bottom: 1px solid #2a4a6a;
            padding-bottom: 5px;
        }

        .canvas-wrapper {
            position: relative;
            display: inline-block;
            cursor: crosshair;
        }

        #pdfCanvas {
            border: 2px solid #e94560;
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.3);
        }

        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .coords-display {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(233, 69, 96, 0.95);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.5em;
            font-weight: bold;
            z-index: 1000;
            font-family: monospace;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background: #1a1a2e;
            color: #fff;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 0;
            width: 100%;
            transition: all 0.2s;
        }

        button:hover {
            transform: scale(1.02);
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-secondary {
            background: #0abde3;
            color: #1a1a2e;
        }

        .btn-success {
            background: #10ac84;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: #1a1a2e;
        }

        .field-list {
            max-height: 250px;
            overflow-y: auto;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 10px;
        }

        .field-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            background: #2a3a5a;
            font-size: 0.85em;
        }

        .field-item.selected {
            background: #e9456033;
            border: 1px solid #e94560;
        }

        .field-item .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .field-item .dot.digit {
            background: #e94560;
        }

        .field-item .dot.text {
            background: #10ac84;
        }

        .field-item .coords {
            margin-left: auto;
            color: #888;
            font-family: monospace;
        }

        #output {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.75em;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .instructions {
            background: rgba(10, 189, 227, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.85em;
            line-height: 1.6;
        }

        .offset-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .offset-controls input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #1a1a2e;
            color: #fff;
            text-align: center;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 0.85em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-item .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <div class="coords-display" id="coordsDisplay">X: ---, Y: ---</div>

    <div class="container">
        <div class="pdf-panel">
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="pdfCanvas"></canvas>
                <canvas id="overlayCanvas"></canvas>
            </div>
        </div>

        <div class="sidebar">
            <h1>ğŸ“ PDFåº§æ¨™ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>

            <div class="instructions">
                <strong>ä½¿ã„æ–¹:</strong><br>
                1. PDFã‚’èª­ã¿è¾¼ã‚€<br>
                2. ã€Œå…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºã€ã§èµ¤/ç·‘ã®ç‚¹ã‚’ç¢ºèª<br>
                3. ç‚¹ãŒãšã‚Œã¦ã„ãŸã‚‰ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤ã‚’èª¿æ•´<br>
                4. ã€Œä¿®æ­£åº§æ¨™ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ã§ã‚³ãƒ¼ãƒ‰å–å¾—
            </div>

            <div class="input-group">
                <label>PDFãƒ•ã‚¡ã‚¤ãƒ«:</label>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>

            <button class="btn-warning" id="showAllFields">ğŸ‘ï¸ å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºï¼ˆç‚¹ã‚’æç”»ï¼‰</button>
            <button class="btn-secondary" id="toggleGrid">ğŸ“ ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºåˆ‡æ›¿</button>

            <h2>ğŸ”§ åº§æ¨™ã‚ªãƒ•ã‚»ãƒƒãƒˆèª¿æ•´</h2>
            <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">
                ç‚¹ãŒãšã‚Œã¦ã„ã‚‹å ´åˆã€ã“ã“ã§å…¨ä½“èª¿æ•´ã§ãã¾ã™
            </p>
            <div class="offset-controls">
                <div>
                    <label style="font-size: 0.8em;">X ã‚ªãƒ•ã‚»ãƒƒãƒˆ</label>
                    <input type="number" id="offsetX" value="0" step="1">
                </div>
                <div>
                    <label style="font-size: 0.8em;">Y ã‚ªãƒ•ã‚»ãƒƒãƒˆ</label>
                    <input type="number" id="offsetY" value="0" step="1">
                </div>
            </div>
            <button class="btn-primary" id="applyOffset">ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨ã—ã¦å†æç”»</button>

            <h2>ğŸ“‹ ç™»éŒ²ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</h2>
            <div class="legend">
                <div class="legend-item">
                    <div class="dot" style="background:#e94560"></div> æ•°å­—ãƒœãƒƒã‚¯ã‚¹
                </div>
                <div class="legend-item">
                    <div class="dot" style="background:#10ac84"></div> ãƒ†ã‚­ã‚¹ãƒˆ
                </div>
            </div>
            <div class="field-list" id="fieldList"></div>

            <h2>ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
            <button class="btn-success" id="exportCoords">ğŸ“‹ ä¿®æ­£åº§æ¨™ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <div id="output">PDFã‚’èª­ã¿è¾¼ã‚“ã§ã€Œå…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pageNum = 1;
        let scale = 1.5;
        let pdfWidth = 0;
        let pdfHeight = 0;
        let showGrid = false;
        let offsetX = 0;
        let offsetY = 0;

        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const overlayCtx = overlayCanvas.getContext('2d');

        // ===== ç™»éŒ²ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆç¾åœ¨ã®æ¨å®šåº§æ¨™ï¼‰ =====
        // ã“ã‚Œã‚‰ã®ç‚¹ãŒPDFä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™
        const DIGIT_BOX_FIELDS = [
            // Left Column
            { id: 'æ‰€å¾—é‡‘é¡_row1', x: 256, y: 628, description: 'Row 1: æ‰€å¾—é‡‘é¡' },
            { id: 'æ³•äººç¨é¡_row2', x: 256, y: 608, description: 'Row 2: æ³•äººç¨é¡' },
            { id: 'ç‰¹åˆ¥æ§é™¤é¡_row3', x: 256, y: 588, description: 'Row 3: ç‰¹åˆ¥æ§é™¤é¡' },
            { id: 'ç¨é¡æ§é™¤_row4', x: 256, y: 568, description: 'Row 4: ç¨é¡æ§é™¤' },
            { id: 'åˆ©å­ç¨_row5', x: 256, y: 548, description: 'Row 5: åˆ©å­ç¨' },
            { id: 'æ§é™¤ç¨é¡_row6', x: 256, y: 528, description: 'Row 6: æ§é™¤ç¨é¡' },
            { id: 'ç•™ä¿é‡‘é¡_row7', x: 256, y: 508, description: 'Row 7: ç•™ä¿é‡‘é¡' },
            { id: 'åŒä¸Šç¨é¡_row8', x: 256, y: 488, description: 'Row 8: åŒä¸Šç¨é¡' },
            { id: 'æ³•äººç¨é¡è¨ˆ1_row9', x: 256, y: 468, description: 'Row 9: æ³•äººç¨é¡è¨ˆ' },
            { id: 'row10', x: 256, y: 448, description: 'Row 10' },
            { id: 'row11', x: 256, y: 428, description: 'Row 11' },
            { id: 'row12', x: 256, y: 408, description: 'Row 12' },
            { id: 'å·®å¼•æ³•äººç¨é¡_row13', x: 256, y: 388, description: 'Row 13: å·®å¼•æ³•äººç¨é¡' },
            { id: 'ä¸­é–“ç”³å‘Š_row14', x: 256, y: 368, description: 'Row 14: ä¸­é–“ç”³å‘Š' },
            { id: 'row15', x: 256, y: 348, description: 'Row 15' },
            { id: 'row16', x: 256, y: 328, description: 'Row 16' },
            { id: 'row17', x: 256, y: 308, description: 'Row 17' },
            { id: 'æ‰€å¾—åˆè¨ˆ_row18', x: 256, y: 288, description: 'Row 18: æ‰€å¾—åˆè¨ˆ (ã“ã“ã«0ãŒå…¥ã‚‹)' },
            { id: 'row19', x: 256, y: 268, description: 'Row 19' },
            { id: 'row20', x: 256, y: 248, description: 'Row 20' },
            { id: 'row21', x: 256, y: 228, description: 'Row 21' },
            { id: 'row22', x: 256, y: 208, description: 'Row 22' },
            { id: 'row23', x: 256, y: 188, description: 'Row 23' },
            { id: 'row24', x: 256, y: 168, description: 'Row 24' },
            { id: 'row25', x: 256, y: 148, description: 'Row 25' },
            { id: 'row26', x: 256, y: 128, description: 'Row 26' },
            { id: 'row27', x: 256, y: 108, description: 'Row 27' },
            { id: 'æ³•äººç¨é¡è¨ˆ_row28', x: 256, y: 88, description: 'Row 28: æ³•äººç¨é¡è¨ˆ (141940ãŒå…¥ã‚‹)' },

            // Right Column
            { id: 'å³_row16', x: 526, y: 568, description: 'å³åˆ— Row 16' },
            { id: 'å³_row17', x: 526, y: 548, description: 'å³åˆ— Row 17' },
            { id: 'å³_row18', x: 526, y: 528, description: 'å³åˆ— Row 18' },
            { id: 'å³_row19', x: 526, y: 508, description: 'å³åˆ— Row 19' },
            { id: 'å³_row20', x: 526, y: 488, description: 'å³åˆ— Row 20' },
            { id: 'å³_row21', x: 526, y: 468, description: 'å³åˆ— Row 21' },
            { id: 'å³_row22', x: 526, y: 448, description: 'å³åˆ— Row 22' },
        ];

        const TEXT_FIELDS = [
            { id: 'ç¨å‹™ç½²å', x: 95, y: 805, description: 'ç¨å‹™ç½²åï¼ˆã€‡ã€‡ç¨å‹™ç½²é•·æ®¿ï¼‰' },
            { id: 'æ³•äººå', x: 68, y: 780, description: 'æ³•äººå' },
            { id: 'æ³•äººç•ªå·', x: 360, y: 820, description: 'æ³•äººç•ªå·ï¼ˆ13æ¡ï¼‰' },
            { id: 'äº‹æ¥­å¹´åº¦_è‡ª', x: 68, y: 742, description: 'äº‹æ¥­å¹´åº¦ï¼ˆè‡ªï¼‰' },
            { id: 'äº‹æ¥­å¹´åº¦_è‡³', x: 68, y: 727, description: 'äº‹æ¥­å¹´åº¦ï¼ˆè‡³ï¼‰' },
            { id: 'ç´ç¨åœ°', x: 68, y: 695, description: 'ç´ç¨åœ°' },
            { id: 'é›»è©±ç•ªå·', x: 240, y: 695, description: 'é›»è©±ç•ªå·' },
            { id: 'ä»£è¡¨è€…æ°å', x: 68, y: 665, description: 'ä»£è¡¨è€…æ°å' },
        ];

        // Load PDF
        document.getElementById('pdfFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            renderPage(pageNum);
            renderFieldList();
        });

        // Render page
        async function renderPage(num) {
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale });

            pdfWidth = page.getViewport({ scale: 1 }).width;
            pdfHeight = page.getViewport({ scale: 1 }).height;

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            overlayCanvas.width = viewport.width;
            overlayCanvas.height = viewport.height;

            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;
        }

        // Convert PDF coords to canvas coords
        function pdfToCanvas(x, y) {
            return {
                x: (x + offsetX) * scale,
                y: overlayCanvas.height - ((y + offsetY) * scale)
            };
        }

        // Draw all field markers
        function drawAllFields() {
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

            // Draw digit box fields (red)
            DIGIT_BOX_FIELDS.forEach((field, i) => {
                const pos = pdfToCanvas(field.x, field.y);

                // Draw dot
                overlayCtx.beginPath();
                overlayCtx.arc(pos.x, pos.y, 8, 0, 2 * Math.PI);
                overlayCtx.fillStyle = '#e94560';
                overlayCtx.fill();
                overlayCtx.strokeStyle = '#fff';
                overlayCtx.lineWidth = 2;
                overlayCtx.stroke();

                // Draw number
                overlayCtx.fillStyle = '#fff';
                overlayCtx.font = 'bold 10px sans-serif';
                overlayCtx.textAlign = 'center';
                overlayCtx.fillText(String(i + 1), pos.x, pos.y + 3);

                // Draw crosshair
                overlayCtx.strokeStyle = 'rgba(233, 69, 96, 0.5)';
                overlayCtx.lineWidth = 1;
                overlayCtx.beginPath();
                overlayCtx.moveTo(pos.x - 15, pos.y);
                overlayCtx.lineTo(pos.x + 15, pos.y);
                overlayCtx.moveTo(pos.x, pos.y - 15);
                overlayCtx.lineTo(pos.x, pos.y + 15);
                overlayCtx.stroke();
            });

            // Draw text fields (green)
            TEXT_FIELDS.forEach((field, i) => {
                const pos = pdfToCanvas(field.x, field.y);

                // Draw dot
                overlayCtx.beginPath();
                overlayCtx.arc(pos.x, pos.y, 8, 0, 2 * Math.PI);
                overlayCtx.fillStyle = '#10ac84';
                overlayCtx.fill();
                overlayCtx.strokeStyle = '#fff';
                overlayCtx.lineWidth = 2;
                overlayCtx.stroke();

                // Draw label
                overlayCtx.fillStyle = '#10ac84';
                overlayCtx.font = 'bold 9px sans-serif';
                overlayCtx.textAlign = 'left';
                overlayCtx.fillText(field.id, pos.x + 12, pos.y + 3);
            });

            if (showGrid) drawGrid();
        }

        // Draw coordinate grid
        function drawGrid() {
            const step = 50;

            for (let y = 0; y <= pdfHeight; y += step) {
                const canvasY = overlayCanvas.height - (y * scale);
                overlayCtx.beginPath();
                overlayCtx.strokeStyle = y % 100 === 0 ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)';
                overlayCtx.lineWidth = y % 100 === 0 ? 1 : 0.5;
                overlayCtx.moveTo(0, canvasY);
                overlayCtx.lineTo(overlayCanvas.width, canvasY);
                overlayCtx.stroke();

                if (y % 100 === 0) {
                    overlayCtx.fillStyle = 'rgba(255,255,255,0.7)';
                    overlayCtx.font = '10px monospace';
                    overlayCtx.fillText(`Y=${y}`, 5, canvasY - 3);
                }
            }

            for (let x = 0; x <= pdfWidth; x += step) {
                const canvasX = x * scale;
                overlayCtx.beginPath();
                overlayCtx.strokeStyle = x % 100 === 0 ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)';
                overlayCtx.lineWidth = x % 100 === 0 ? 1 : 0.5;
                overlayCtx.moveTo(canvasX, 0);
                overlayCtx.lineTo(canvasX, overlayCanvas.height);
                overlayCtx.stroke();

                if (x % 100 === 0) {
                    overlayCtx.fillStyle = 'rgba(255,255,255,0.7)';
                    overlayCtx.font = '10px monospace';
                    overlayCtx.fillText(`X=${x}`, canvasX + 3, 12);
                }
            }
        }

        // Render field list
        function renderFieldList() {
            const list = document.getElementById('fieldList');
            let html = '';

            DIGIT_BOX_FIELDS.forEach((field, i) => {
                html += `<div class="field-item">
                    <div class="dot digit"></div>
                    <span>${i + 1}. ${field.description}</span>
                    <span class="coords">(${field.x}, ${field.y})</span>
                </div>`;
            });

            TEXT_FIELDS.forEach((field) => {
                html += `<div class="field-item">
                    <div class="dot text"></div>
                    <span>${field.id}</span>
                    <span class="coords">(${field.x}, ${field.y})</span>
                </div>`;
            });

            list.innerHTML = html;
        }

        // Mouse move
        document.getElementById('canvasWrapper').addEventListener('mousemove', (e) => {
            if (!pdfDoc) return;
            const rect = canvas.getBoundingClientRect();
            const canvasX = e.clientX - rect.left;
            const canvasY = e.clientY - rect.top;
            const pdfX = canvasX / scale;
            const pdfY = pdfHeight - (canvasY / scale);
            document.getElementById('coordsDisplay').textContent =
                `X: ${pdfX.toFixed(1)}, Y: ${pdfY.toFixed(1)}`;
        });

        // Show all fields
        document.getElementById('showAllFields').addEventListener('click', () => {
            if (!pdfDoc) {
                alert('PDFã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }
            drawAllFields();
        });

        // Toggle grid
        document.getElementById('toggleGrid').addEventListener('click', () => {
            showGrid = !showGrid;
            if (pdfDoc) drawAllFields();
        });

        // Apply offset
        document.getElementById('applyOffset').addEventListener('click', () => {
            offsetX = parseFloat(document.getElementById('offsetX').value) || 0;
            offsetY = parseFloat(document.getElementById('offsetY').value) || 0;
            if (pdfDoc) drawAllFields();
        });

        // Export
        document.getElementById('exportCoords').addEventListener('click', () => {
            let output = '// ===== BEPPYO1 DIGIT BOX FIELDS =====\n';
            output += '// Generated with offset: X=' + offsetX + ', Y=' + offsetY + '\n\n';
            output += 'export const BEPPYO1_FIELDS: { [key: string]: DigitBoxConfig } = {\n';

            DIGIT_BOX_FIELDS.forEach(field => {
                output += `    '${field.id}': {\n`;
                output += `        anchorX: ${field.x + offsetX},\n`;
                output += `        anchorY: ${field.y + offsetY},\n`;
                output += `        boxWidth: 16,\n`;
                output += `        boxSpacing: 16,\n`;
                output += `        fontSize: 10,\n`;
                output += `        maxDigits: 12\n`;
                output += `    },\n`;
            });

            output += '};\n\n';
            output += '// ===== BEPPYO1 TEXT FIELDS =====\n';
            output += 'export const BEPPYO1_TEXT_FIELDS: { [key: string]: TextFieldConfig } = {\n';

            TEXT_FIELDS.forEach(field => {
                output += `    '${field.id}': { x: ${field.x + offsetX}, y: ${field.y + offsetY}, fontSize: 9 },\n`;
            });

            output += '};\n';

            document.getElementById('output').textContent = output;
        });

        renderFieldList();
    </script>
</body>

</html>