import{r as h,j as e,P as I,T as L,i as q,k as G,s as R,a as V,b as z,d as J,L as K,F as k}from"./index-ANsWalRW.js";import{C as Q}from"./calculator-CeXj6_6n.js";import{I as E}from"./info-VDCyy0ci.js";import{C as W}from"./clock-D5R1C44l.js";import{T as X}from"./triangle-alert-Cat07P4v.js";import{C as M}from"./circle-check-big-7dW2Outk.js";import{c as Z}from"./TaxFilingService-DDB1LB_S.js";import{e as ee,d as F,p as Y,f as se}from"./pdfAutoFillService-Cx6bfSiv.js";import{A as te}from"./arrow-left-CzwRZ0lz.js";import{C as P}from"./circle-alert-MEFdEpQ1.js";import{S as re}from"./save-bpZG0GMV.js";import{D as O}from"./download-B8WM_aIE.js";const b=[];for(let t=0;t<256;++t)b.push((t+256).toString(16).slice(1));function ae(t,r=0){return(b[t[r+0]]+b[t[r+1]]+b[t[r+2]]+b[t[r+3]]+"-"+b[t[r+4]]+b[t[r+5]]+"-"+b[t[r+6]]+b[t[r+7]]+"-"+b[t[r+8]]+b[t[r+9]]+"-"+b[t[r+10]]+b[t[r+11]]+b[t[r+12]]+b[t[r+13]]+b[t[r+14]]+b[t[r+15]]).toLowerCase()}let A;const ne=new Uint8Array(16);function ie(){if(!A){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");A=crypto.getRandomValues.bind(crypto)}return A(ne)}const le=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),$={randomUUID:le};function de(t,r,i){var o;t=t||{};const a=t.random??((o=t.rng)==null?void 0:o.call(t))??ie();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,ae(a)}function ce(t,r,i){return $.randomUUID&&!t?$.randomUUID():de(t)}const oe=[{category:"交際費",description:"損金不算入額"},{category:"寄附金",description:"損金不算入額"},{category:"減価償却超過額",description:"償却限度超過額"},{category:"役員給与",description:"損金不算入額"},{category:"租税公課",description:"損金不算入額"}],xe=[{category:"受取配当等",description:"益金不算入額"},{category:"所得税額控除",description:"控除額"},{category:"前期確定償却不足額",description:"当期認容額"}];function me({adjustments:t,onChange:r,netIncome:i}){const[a,o]=h.useState(!1),[l,c]=h.useState(!1),p=(n,s)=>{const m={id:ce(),category:(s==null?void 0:s.category)||"",description:(s==null?void 0:s.description)||"",amount:0};r({...t,[n]:[...t[n],m]}),n==="additions"&&o(!1),n==="deductions"&&c(!1)},x=(n,s,m)=>{r({...t,[n]:t[n].map(g=>g.id===s?{...g,...m}:g)})},v=(n,s)=>{r({...t,[n]:t[n].filter(m=>m.id!==s)})},f=t.additions.reduce((n,s)=>n+s.amount,0),j=t.deductions.reduce((n,s)=>n+s.amount,0),N=i+f-j,u=n=>`¥${n.toLocaleString()}`;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-slate-800/50 border border-slate-600/50 rounded-xl p-5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Q,{className:"w-5 h-5 text-blue-400"}),e.jsx("h3",{className:"font-semibold text-white",children:"所得金額の計算"})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-400",children:"当期純利益"}),e.jsx("span",{className:"font-medium text-white",children:u(i)})]}),e.jsxs("div",{className:"flex justify-between text-blue-400",children:[e.jsx("span",{children:"+ 加算合計"}),e.jsx("span",{className:"font-medium",children:u(f)})]}),e.jsxs("div",{className:"flex justify-between text-red-400",children:[e.jsx("span",{children:"- 減算合計"}),e.jsx("span",{className:"font-medium",children:u(j)})]}),e.jsxs("div",{className:"border-t border-slate-600 pt-2 mt-2 flex justify-between text-lg",children:[e.jsx("span",{className:"font-semibold text-white",children:"所得金額"}),e.jsx("span",{className:"font-bold text-blue-400",children:u(N)})]})]})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-xl p-5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h4",{className:"font-medium text-white",children:"加算項目"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>o(!a),className:"btn-ghost text-sm flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4"}),"追加"]}),a&&e.jsx("div",{className:"absolute right-0 mt-2 w-56 bg-slate-800 border border-slate-600 rounded-lg shadow-xl z-10",children:e.jsxs("div",{className:"p-2 space-y-1",children:[oe.map((n,s)=>e.jsx("button",{onClick:()=>p("additions",n),className:"w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-slate-700 rounded",children:n.category},s)),e.jsx("div",{className:"border-t border-slate-600 mt-1 pt-1",children:e.jsx("button",{onClick:()=>p("additions"),className:"w-full text-left px-3 py-2 text-sm text-blue-400 hover:bg-slate-700 rounded",children:"+ その他の項目"})})]})})]})]}),e.jsxs("div",{className:"space-y-3",children:[t.additions.map(n=>e.jsxs("div",{className:"bg-slate-800/30 rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("input",{type:"text",placeholder:"項目（例：交際費）",value:n.category,onChange:s=>x("additions",n.id,{category:s.target.value}),className:"input-base"}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",children:"¥"}),e.jsx("input",{type:"number",placeholder:"金額",value:n.amount||"",onChange:s=>x("additions",n.id,{amount:Number(s.target.value)}),className:"input-base pl-8"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"説明（例：損金不算入額）",value:n.description,onChange:s=>x("additions",n.id,{description:s.target.value}),className:"input-base flex-1"}),e.jsx("button",{onClick:()=>v("additions",n.id),className:"p-2 text-red-400 hover:bg-red-400/10 rounded transition-colors",children:e.jsx(L,{className:"w-4 h-4"})})]})]},n.id)),t.additions.length===0&&e.jsx("p",{className:"text-center text-slate-500 py-4",children:"加算項目がありません"})]})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-xl p-5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h4",{className:"font-medium text-white",children:"減算項目"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>c(!l),className:"btn-ghost text-sm flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4"}),"追加"]}),l&&e.jsx("div",{className:"absolute right-0 mt-2 w-56 bg-slate-800 border border-slate-600 rounded-lg shadow-xl z-10",children:e.jsxs("div",{className:"p-2 space-y-1",children:[xe.map((n,s)=>e.jsx("button",{onClick:()=>p("deductions",n),className:"w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-slate-700 rounded",children:n.category},s)),e.jsx("div",{className:"border-t border-slate-600 mt-1 pt-1",children:e.jsx("button",{onClick:()=>p("deductions"),className:"w-full text-left px-3 py-2 text-sm text-blue-400 hover:bg-slate-700 rounded",children:"+ その他の項目"})})]})})]})]}),e.jsxs("div",{className:"space-y-3",children:[t.deductions.map(n=>e.jsxs("div",{className:"bg-slate-800/30 rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("input",{type:"text",placeholder:"項目（例：受取配当）",value:n.category,onChange:s=>x("deductions",n.id,{category:s.target.value}),className:"input-base"}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",children:"¥"}),e.jsx("input",{type:"number",placeholder:"金額",value:n.amount||"",onChange:s=>x("deductions",n.id,{amount:Number(s.target.value)}),className:"input-base pl-8"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"説明（例：益金不算入額）",value:n.description,onChange:s=>x("deductions",n.id,{description:s.target.value}),className:"input-base flex-1"}),e.jsx("button",{onClick:()=>v("deductions",n.id),className:"p-2 text-red-400 hover:bg-red-400/10 rounded transition-colors",children:e.jsx(L,{className:"w-4 h-4"})})]})]},n.id)),t.deductions.length===0&&e.jsx("p",{className:"text-center text-slate-500 py-4",children:"減算項目がありません"})]})]})]})}function he({earnings:t,onChange:r,priorYearEarnings:i,currentNetIncome:a,corporateTaxAmount:o}){const[l,c]=h.useState(0),[p,x]=h.useState(0),[v,f]=h.useState(0),[j,N]=h.useState(0);h.useEffect(()=>{if(i){const s={profitReserve:{beginning:i.profitReserve.ending,increase:p,decrease:0,ending:0},otherReserve:{beginning:i.otherReserve.ending,increase:v,decrease:j,ending:0},retainedEarnings:{beginning:i.retainedEarnings.ending,increase:a-o,decrease:l+p+v,ending:0}};s.profitReserve.ending=s.profitReserve.beginning+s.profitReserve.increase-s.profitReserve.decrease,s.otherReserve.ending=s.otherReserve.beginning+s.otherReserve.increase-s.otherReserve.decrease,s.retainedEarnings.ending=s.retainedEarnings.beginning+s.retainedEarnings.increase-s.retainedEarnings.decrease,r(s)}},[i,a,o,l,p,v,j]);const u=s=>`¥${s.toLocaleString()}`,n=({label:s,item:m,highlight:g=!1})=>e.jsxs("div",{className:`grid grid-cols-5 gap-3 p-3 rounded-lg ${g?"bg-blue-500/10 border border-blue-500/30":"bg-slate-800/30"}`,children:[e.jsx("div",{className:"font-medium text-slate-300",children:s}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-slate-400",children:"期首"}),e.jsx("div",{className:"font-medium text-white",children:u(m.beginning)})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm text-green-400 flex items-center justify-end gap-1",children:[e.jsx(q,{className:"w-3 h-3"}),"増加"]}),e.jsx("div",{className:"font-medium text-green-400",children:u(m.increase)})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm text-red-400 flex items-center justify-end gap-1",children:[e.jsx(G,{className:"w-3 h-3"}),"減少"]}),e.jsx("div",{className:"font-medium text-red-400",children:u(m.decrease)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-slate-400",children:"期末"}),e.jsx("div",{className:"font-bold text-blue-400",children:u(m.ending)})]})]});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(E,{className:"w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-slate-300",children:[e.jsx("p",{className:"font-medium mb-1",children:"別表五(一) - 利益積立金額の計算"}),e.jsx("p",{className:"text-slate-400",children:"前期データが自動的に引き継がれます。配当や積立金の金額を入力してください。"})]})]}),i?e.jsxs("div",{className:"bg-slate-800/50 border border-slate-600/50 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-1",children:"前期データから自動引継ぎ"}),e.jsx("div",{className:"text-green-400 font-medium",children:"✓ 前期の期末残高を期首残高として設定済み"})]}):e.jsxs("div",{className:"bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4",children:[e.jsx("div",{className:"text-yellow-400 font-medium",children:"前期データなし"}),e.jsx("div",{className:"text-sm text-slate-400 mt-1",children:"初年度または前期データが未入力です"})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-xl p-5 space-y-4",children:[e.jsx("h4",{className:"font-medium text-white mb-4",children:"当期の変動入力"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-2",children:"配当金支払額"}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",children:"¥"}),e.jsx("input",{type:"number",value:l||"",onChange:s=>c(Number(s.target.value)),className:"input-base pl-8",placeholder:"0"})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"株主への配当金"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-2",children:"利益準備金繰入額"}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",children:"¥"}),e.jsx("input",{type:"number",value:p||"",onChange:s=>x(Number(s.target.value)),className:"input-base pl-8",placeholder:"0"})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"配当の1/10を積立（会社法）"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-2",children:"別途積立金繰入額"}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",children:"¥"}),e.jsx("input",{type:"number",value:v||"",onChange:s=>f(Number(s.target.value)),className:"input-base pl-8",placeholder:"0"})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"任意積立金の積立"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-2",children:"別途積立金取崩額"}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",children:"¥"}),e.jsx("input",{type:"number",value:j||"",onChange:s=>N(Number(s.target.value)),className:"input-base pl-8",placeholder:"0"})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"任意積立金の取崩"})]})]})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-xl p-5",children:[e.jsx("h4",{className:"font-medium text-white mb-4",children:"利益積立金の明細"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(n,{label:"1. 利益準備金",item:t.profitReserve}),e.jsx(n,{label:"2. 別途積立金",item:t.otherReserve}),e.jsx(n,{label:"3. 繰越利益剰余金",item:t.retainedEarnings,highlight:!0})]})]}),e.jsxs("div",{className:"bg-slate-800/30 border border-slate-600/30 rounded-lg p-4 text-sm",children:[e.jsx("div",{className:"font-medium text-slate-300 mb-2",children:"繰越利益剰余金の計算式"}),e.jsxs("div",{className:"space-y-1 text-slate-400 font-mono text-xs",children:[e.jsxs("div",{children:["期首残高: ",u(t.retainedEarnings.beginning)]}),e.jsxs("div",{children:["+ 当期純利益 - 法人税等: ",u(a-o)]}),e.jsxs("div",{children:["- 配当金: ",u(l)]}),e.jsxs("div",{children:["- 各種積立金: ",u(p+v)]}),e.jsxs("div",{className:"border-t border-slate-600 pt-1 mt-1 font-bold text-blue-400",children:["= 期末残高: ",u(t.retainedEarnings.ending)]})]})]})]})}function ue(t,r,i){const a=r.reduce((l,c)=>l+c.amount,0),o=i.reduce((l,c)=>l+c.amount,0);return t+a-o}function pe(t){return t>=2018?t+10:t+9}function be(t,r){if(t<=0)return{corporateTax:0,localCorporateTax:0};let i=.23;if(r)if(t<=8e6)i=.15;else{const c=(t-8e6)*.232,p=Math.floor(12e5+c),x=Math.floor(p*.104);return{corporateTax:p,localCorporateTax:x}}const a=Math.floor(t*i),o=Math.floor(a*.104);return{corporateTax:a,localCorporateTax:o}}function ge(t=0){return t<=1e8}function ve({lossCarryovers:t,onChange:r,currentFiscalYear:i,currentTaxableIncome:a}){const[o,l]=h.useState(i-1),[c,p]=h.useState(0),x=s=>`¥${s.toLocaleString()}`,v=()=>{if(c<=0)return;const s=pe(o),m={lossYear:o,lossAmount:c,expiryYear:s,deductionHistory:[],remainingBalance:c};r([...t,m].sort((g,_)=>g.lossYear-_.lossYear)),p(0)},f=s=>{r(t.filter(m=>m.lossYear!==s))},j=t.filter(s=>s.remainingBalance>0&&s.expiryYear>=i),N=j.reduce((s,m)=>s+m.remainingBalance,0),u=t.filter(s=>s.remainingBalance>0&&s.expiryYear===i),n=t.filter(s=>s.remainingBalance>0&&s.expiryYear<i);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(E,{className:"w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-slate-300",children:[e.jsx("p",{className:"font-medium mb-1",children:"別表七(一) - 欠損金の繰越控除"}),e.jsx("p",{className:"text-slate-400",children:"過去の赤字（欠損金）を最大10年間繰り越して、当期の黒字から控除できます。"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-slate-800/50 border border-slate-600/50 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-1",children:"繰越可能な欠損金"}),e.jsx("div",{className:"text-2xl font-bold text-blue-400",children:x(N)}),e.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:[j.length,"件"]})]}),e.jsxs("div",{className:"bg-slate-800/50 border border-slate-600/50 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-1",children:"当期の課税所得"}),e.jsx("div",{className:"text-2xl font-bold text-green-400",children:x(a)})]}),e.jsxs("div",{className:"bg-slate-800/50 border border-slate-600/50 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-1",children:"控除可能額（概算）"}),e.jsx("div",{className:"text-2xl font-bold text-yellow-400",children:x(Math.min(N,a))})]})]}),u.length>0&&e.jsxs("div",{className:"bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(W,{className:"w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium text-yellow-400 mb-1",children:"今期が繰越期限の欠損金があります"}),e.jsx("div",{className:"text-slate-300",children:u.map(s=>e.jsxs("div",{children:[s.lossYear,"年度: ",x(s.remainingBalance)]},s.lossYear))})]})]}),n.length>0&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(X,{className:"w-5 h-5 text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium text-red-400 mb-1",children:"繰越期限切れの欠損金があります"}),e.jsx("div",{className:"text-slate-300",children:"これらは控除できません。削除してください。"})]})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-xl p-5",children:[e.jsx("h4",{className:"font-medium text-white mb-4",children:"欠損金繰越一覧"}),t.length>0?e.jsx("div",{className:"space-y-3",children:t.map(s=>{const m=s.expiryYear<i,g=s.expiryYear===i,_=s.expiryYear-i;return e.jsxs("div",{className:`rounded-lg p-4 border ${m?"bg-red-500/10 border-red-500/30":g?"bg-yellow-500/10 border-yellow-500/30":"bg-slate-800/30 border-slate-700"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-white",children:[s.lossYear,"年度発生の欠損金"]}),e.jsxs("div",{className:"text-sm text-slate-400 mt-1",children:["繰越期限: ",s.expiryYear,"年度まで",!m&&e.jsxs("span",{className:`ml-2 ${g?"text-yellow-400":"text-slate-500"}`,children:["（残り",_,"年）"]})]})]}),e.jsx("button",{onClick:()=>f(s.lossYear),className:"text-red-400 hover:text-red-300 text-sm",children:"削除"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-slate-400",children:"発生額"}),e.jsx("div",{className:"font-medium text-white",children:x(s.lossAmount)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-slate-400",children:"累計控除額"}),e.jsx("div",{className:"font-medium text-green-400",children:x(s.deductionHistory.reduce((y,w)=>y+w.deductedAmount,0))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-slate-400",children:"残高"}),e.jsx("div",{className:`font-bold ${s.remainingBalance>0?"text-blue-400":"text-slate-500"}`,children:x(s.remainingBalance)})]})]}),s.deductionHistory.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-700",children:[e.jsx("div",{className:"text-xs text-slate-400 mb-2",children:"控除履歴"}),e.jsx("div",{className:"space-y-1 text-xs",children:s.deductionHistory.map((y,w)=>e.jsxs("div",{className:"flex justify-between text-slate-300",children:[e.jsxs("span",{children:[y.fiscalYear,"年度"]}),e.jsx("span",{className:"font-mono",children:x(y.deductedAmount)})]},w))})]})]},s.lossYear)})}):e.jsxs("div",{className:"text-center py-8 text-slate-500",children:[e.jsx(M,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"繰越欠損金はありません"}),e.jsx("p",{className:"text-sm mt-1",children:"過去に赤字があった場合は下記から追加してください"})]})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-xl p-5",children:[e.jsx("h4",{className:"font-medium text-white mb-4",children:"過去の欠損金を追加"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-2",children:"発生年度"}),e.jsx("input",{type:"number",value:o,onChange:s=>l(Number(s.target.value)),className:"input-base",placeholder:"2023"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-2",children:"欠損金額"}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",children:"¥"}),e.jsx("input",{type:"number",value:c||"",onChange:s=>p(Number(s.target.value)),className:"input-base pl-8",placeholder:"0"})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:v,disabled:c<=0,className:"btn-primary w-full disabled:opacity-50 disabled:cursor-not-allowed",children:"追加"})})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-2",children:"※ 繰越期限は自動計算されます（2018年度以降: 10年、それ以前: 9年）"})]})]})}async function je(t,r,i,a){try{const{data:o,error:l}=await R.from("corporate_tax_filings").upsert({user_id:t,business_type_id:r,fiscal_year:i,net_income:a.netIncome,tax_adjustments_additions:a.taxAdjustmentsAdditions,tax_adjustments_deductions:a.taxAdjustmentsDeductions,taxable_income:a.taxableIncome,corporate_tax_amount:a.corporateTaxAmount,local_corporate_tax_amount:a.localCorporateTaxAmount,filing_date:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"user_id,business_type_id,fiscal_year"}).select().single();return l?(console.error("Tax filing save error:",l),{success:!1,error:l.message}):{success:!0,filingId:o.id}}catch(o){return console.error("Tax filing save exception:",o),{success:!1,error:String(o)}}}async function fe(t,r){try{const{error:i}=await R.from("retained_earnings_history").upsert({filing_id:t,profit_reserve_beginning:r.profitReserve.beginning,profit_reserve_increase:r.profitReserve.increase,profit_reserve_decrease:r.profitReserve.decrease,profit_reserve_ending:r.profitReserve.ending,other_reserve_beginning:r.otherReserve.beginning,other_reserve_increase:r.otherReserve.increase,other_reserve_decrease:r.otherReserve.decrease,other_reserve_ending:r.otherReserve.ending,retained_earnings_beginning:r.retainedEarnings.beginning,retained_earnings_increase:r.retainedEarnings.increase,retained_earnings_decrease:r.retainedEarnings.decrease,retained_earnings_ending:r.retainedEarnings.ending});return i?(console.error("Retained earnings save error:",i),{success:!1,error:i.message}):{success:!0}}catch(i){return console.error("Retained earnings save exception:",i),{success:!1,error:String(i)}}}async function Ne(t,r,i){try{const a=i-1,{data:o}=await R.from("corporate_tax_filings").select("id").eq("user_id",t).eq("business_type_id",r).eq("fiscal_year",a).single();if(!o)return null;const{data:l,error:c}=await R.from("retained_earnings_history").select("*").eq("filing_id",o.id).single();return c||!l?null:{profitReserve:{beginning:l.profit_reserve_beginning,increase:l.profit_reserve_increase,decrease:l.profit_reserve_decrease,ending:l.profit_reserve_ending},otherReserve:{beginning:l.other_reserve_beginning,increase:l.other_reserve_increase,decrease:l.other_reserve_decrease,ending:l.other_reserve_ending},retainedEarnings:{beginning:l.retained_earnings_beginning,increase:l.retained_earnings_increase,decrease:l.retained_earnings_decrease,ending:l.retained_earnings_ending}}}catch(a){return console.error("Get prior retained earnings error:",a),null}}async function ye(t,r,i){try{const{error:a}=await R.from("loss_carryover_history").upsert({user_id:t,business_type_id:r,loss_year:i.lossYear,loss_amount:i.lossAmount,expiry_year:i.expiryYear,deduction_history:i.deductionHistory,remaining_balance:i.remainingBalance,updated_at:new Date().toISOString()},{onConflict:"user_id,business_type_id,loss_year"});return a?(console.error("Loss carryover save error:",a),{success:!1,error:a.message}):{success:!0}}catch(a){return console.error("Loss carryover save exception:",a),{success:!1,error:String(a)}}}async function we(t,r,i){try{const{data:a,error:o}=await R.from("loss_carryover_history").select("*").eq("user_id",t).eq("business_type_id",r).gt("remaining_balance",0).lte("loss_year",i).gte("expiry_year",i).order("loss_year",{ascending:!0});return o||!a?[]:a.map(l=>({lossYear:l.loss_year,lossAmount:l.loss_amount,expiryYear:l.expiry_year,deductionHistory:l.deduction_history||[],remainingBalance:l.remaining_balance}))}catch(a){return console.error("Get active loss carryovers error:",a),[]}}const Ye=()=>{const{user:t}=V(),{currentBusinessType:r}=z(),{transactions:i}=J(t==null?void 0:t.id,r==null?void 0:r.business_type),[a,o]=h.useState("beppyo4"),l=new Date().getFullYear(),[c,p]=h.useState(l-1),[x,v]=h.useState({additions:[],deductions:[]}),[f,j]=h.useState({profitReserve:{beginning:0,increase:0,decrease:0,ending:0},otherReserve:{beginning:0,increase:0,decrease:0,ending:0},retainedEarnings:{beginning:0,increase:0,decrease:0,ending:0}}),[N,u]=h.useState([]),[n,s]=h.useState(null),[m,g]=h.useState(!1),[_,y]=h.useState("idle");h.useEffect(()=>{t&&r&&(async()=>{try{const d=await Ne(t.id,r.id,c);s(d);const C=await we(t.id,r.id,c);u(C)}catch(d){console.error("前期データの読み込みエラー:",d)}})()},[t,r,c]);const w=h.useMemo(()=>Z(i,c,"corporation",[]),[i,c]),T=h.useMemo(()=>ue(w.netIncome,x.additions,x.deductions),[w.netIncome,x]),S=h.useMemo(()=>{const d=(r==null?void 0:r.capital)||0;return be(T,ge(d))},[T,r]),U=async()=>{if(!(!t||!r)){y("saving");try{const d=await je(t.id,r.id,c,{netIncome:w.netIncome,taxAdjustmentsAdditions:x.additions,taxAdjustmentsDeductions:x.deductions,taxableIncome:T,corporateTaxAmount:S.corporateTax,localCorporateTaxAmount:S.localCorporateTax});if(!d.success||!d.filingId)throw new Error(d.error||"Filing save failed");await fe(d.filingId,f);for(const C of N)await ye(t.id,r.id,C);y("success"),setTimeout(()=>y("idle"),3e3)}catch(d){console.error("保存エラー:",d),y("error"),setTimeout(()=>y("idle"),3e3)}}},B=async()=>{try{g(!0);const d=await ee({fiscalYear:c,businessType:"corporation",companyName:(r==null?void 0:r.company_name)||"会社名",retainedEarnings:f.retainedEarnings}),C=`別表五_${c}年度.pdf`;F(d,C),Y(d)}catch(d){console.error("PDF生成エラー:",d),alert("PDF生成に失敗しました")}finally{g(!1)}},H=async()=>{try{g(!0);const d=await se({fiscalYear:c,businessType:"corporation",companyName:(r==null?void 0:r.company_name)||"会社名",lossCarryover:N}),C=`別表七_${c}年度.pdf`;F(d,C),Y(d)}catch(d){console.error("PDF生成エラー:",d),alert("PDF生成に失敗しました")}finally{g(!1)}},D=d=>`¥${d.toLocaleString()}`;return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(K,{to:"/dashboard",className:"flex items-center text-primary hover:text-primary-hover mb-4",children:[e.jsx(te,{className:"h-5 w-5 mr-2"}),"ダッシュボードに戻る"]}),e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"法人税申告"}),e.jsx("p",{className:"text-slate-400",children:"別表四・五・七のデータ入力と管理"})]}),e.jsx("div",{className:"bg-surface border border-border rounded-xl p-5 mb-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"申告年度"}),e.jsx("select",{value:c,onChange:d=>p(Number(d.target.value)),className:"input-base w-full sm:w-auto",children:Array.from({length:5},(d,C)=>l-1-C).map(d=>e.jsxs("option",{value:d,children:[d,"年度（",d,"年4月〜",d+1,"年3月）"]},d))})]}),e.jsx("button",{onClick:U,disabled:_==="saving",className:`btn-primary flex items-center gap-2 ${_==="saving"?"opacity-50 cursor-not-allowed":""}`,children:_==="saving"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"保存中..."]}):_==="success"?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"w-5 h-5"}),"保存完了"]}):_==="error"?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-5 h-5"}),"保存失敗"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-5 h-5"}),"すべて保存"]})})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-surface border border-border rounded-xl p-5",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-1",children:"当期純利益"}),e.jsx("div",{className:"text-2xl font-bold text-white",children:D(w.netIncome)})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-xl p-5",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-1",children:"課税所得"}),e.jsx("div",{className:"text-2xl font-bold text-blue-400",children:D(T)})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-xl p-5",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-1",children:"法人税等（概算）"}),e.jsx("div",{className:"text-2xl font-bold text-green-400",children:D(S.corporateTax+S.localCorporateTax)})]})]}),n&&e.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-6 flex items-start gap-3",children:[e.jsx(E,{className:"w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-slate-300",children:[e.jsx("p",{className:"font-medium mb-1",children:"前期データを読み込みました"}),e.jsxs("p",{className:"text-slate-400",children:[c-1,"年度の利益積立金データが自動的に引き継がれています"]})]})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-xl overflow-hidden mb-6",children:[e.jsxs("div",{className:"flex border-b border-border",children:[e.jsxs("button",{onClick:()=>o("beppyo4"),className:`flex-1 px-6 py-4 text-sm font-medium transition-colors ${a==="beppyo4"?"bg-primary text-white border-b-2 border-primary":"text-slate-400 hover:text-white hover:bg-surface-highlight"}`,children:[e.jsx(k,{className:"w-5 h-5 inline-block mr-2"}),"別表四（所得調整）"]}),e.jsxs("button",{onClick:()=>o("beppyo5"),className:`flex-1 px-6 py-4 text-sm font-medium transition-colors ${a==="beppyo5"?"bg-primary text-white border-b-2 border-primary":"text-slate-400 hover:text-white hover:bg-surface-highlight"}`,children:[e.jsx(k,{className:"w-5 h-5 inline-block mr-2"}),"別表五（利益積立金）"]}),e.jsxs("button",{onClick:()=>o("beppyo7"),className:`flex-1 px-6 py-4 text-sm font-medium transition-colors ${a==="beppyo7"?"bg-primary text-white border-b-2 border-primary":"text-slate-400 hover:text-white hover:bg-surface-highlight"}`,children:[e.jsx(k,{className:"w-5 h-5 inline-block mr-2"}),"別表七（欠損金）"]})]}),e.jsxs("div",{className:"p-6",children:[a==="beppyo4"&&e.jsx(me,{adjustments:x,onChange:v,netIncome:w.netIncome}),a==="beppyo5"&&e.jsxs(e.Fragment,{children:[e.jsx(he,{earnings:f,onChange:j,priorYearEarnings:n,currentNetIncome:w.netIncome,corporateTaxAmount:S.corporateTax}),e.jsx("div",{className:"mt-6",children:e.jsxs("button",{onClick:B,disabled:m,className:"btn-primary flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5"}),m?"PDF生成中...":"別表五PDFをダウンロード"]})})]}),a==="beppyo7"&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{lossCarryovers:N,onChange:u,currentFiscalYear:c,currentTaxableIncome:T}),e.jsx("div",{className:"mt-6",children:e.jsxs("button",{onClick:H,disabled:m,className:"btn-primary flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5"}),m?"PDF生成中...":"別表七PDFをダウンロード"]})})]})]})]}),e.jsx("div",{className:"bg-slate-800/30 border border-slate-600/30 rounded-xl p-5",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(P,{className:"w-5 h-5 text-slate-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-slate-400",children:[e.jsx("p",{className:"font-medium text-slate-300 mb-2",children:"ご注意"}),e.jsxs("ul",{className:"space-y-1 list-disc list-inside",children:[e.jsx("li",{children:"データは年度ごとに自動保存されます"}),e.jsx("li",{children:"前期データは自動的に引き継がれます"}),e.jsx("li",{children:"計算結果は概算です。正確な税額は税理士にご確認ください"})]})]})]})})]})})};export{Ye as default};
