import{c as k,r,j as e,X as le,z as ce,d as de}from"./index-0N2qkU5h.js";import{T as y}from"./triangle-alert-CbHWtBss.js";import{Z}from"./zap-soyB5S57.js";import{R as q}from"./rotate-ccw-Cx_Bs456.js";import{L as he}from"./loader-circle-CnHauDqv.js";import{C as ue}from"./camera-CUdoNujY.js";import{C as me}from"./circle-check-CEvWwcs3.js";/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 18a6 6 0 0 0 0-12v12z",key:"j4l70d"}]],pe=k("contrast",xe);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]],fe=k("rotate-cw",ge);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["path",{d:"M10.513 4.856 13.12 2.17a.5.5 0 0 1 .86.46l-1.377 4.317",key:"193nxd"}],["path",{d:"M15.656 10H20a1 1 0 0 1 .78 1.63l-1.72 1.773",key:"27a7lr"}],["path",{d:"M16.273 16.273 10.88 21.83a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14H4a1 1 0 0 1-.78-1.63l4.507-4.643",key:"1e0qe9"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],we=k("zap-off",be),Te=({onCapture:H,onClose:C})=>{const l=r.useRef(null),w=r.useRef(null),j=r.useRef(null),[d,M]=r.useState(null),[c,S]=r.useState(null),[p,z]=r.useState(!1),[I,U]=r.useState(null),[g,V]=r.useState("auto"),[je,ve]=r.useState(1),[h,P]=r.useState(!0),[R,Ne]=r.useState(!1),[ye,D]=r.useState([]),[m,W]=r.useState(null),[X,T]=r.useState(!1),[f,$]=r.useState(100),[b,F]=r.useState(100),[u,v]=r.useState(0),E=async()=>{try{const s={video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080},focusMode:"continuous",exposureMode:"continuous"}},t=await navigator.mediaDevices.getUserMedia(s);M(t),l.current&&(l.current.srcObject=t);const a=t.getVideoTracks()[0];a.getCapabilities().torch&&A(a,g)}catch(s){console.error("Camera error:",s),U("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")}};r.useEffect(()=>(E(),()=>{d&&d.getTracks().forEach(s=>{s.stop()})}),[]);const A=async(s,t)=>{try{s.getCapabilities().torch&&await s.applyConstraints({advanced:[{torch:t==="on"}]})}catch(a){console.warn("Flash mode not supported:",a)}},G=()=>{const s=["off","on","auto"],t=s.indexOf(g),a=s[(t+1)%s.length];if(V(a),d){const n=d.getVideoTracks()[0];A(n,a)}};r.useEffect(()=>{if(!l.current||c||!h)return;const s=setInterval(()=>{J()},500);return()=>clearInterval(s)},[l.current,c,h]);const J=r.useCallback(()=>{if(!l.current||!j.current)return;const s=l.current,t=j.current;t.width=320,t.height=240;const a=t.getContext("2d");if(!a)return;a.drawImage(s,0,0,t.width,t.height);const n=a.getImageData(0,0,t.width,t.height),i=K(n);W(i),h&&i.brightness>60&&i.brightness<200&&i.contrast>40&&i.sharpness>30&&i.hasReceipt&&setTimeout(()=>B(),300)},[h]),K=s=>{const t=s.data;let a=0,n=0;for(let o=0;o<t.length;o+=4){const N=t[o],ne=t[o+1],oe=t[o+2],Q=(N+ne+oe)/3;if(a+=Q,o>s.width*4*4){const ie=(t[o-s.width*4]+t[o-s.width*4+1]+t[o-s.width*4+2])/3;n+=Math.abs(Q-ie)}}const i=a/(t.length/4),ae=n/(t.length/4);let _=0;for(let o=0;o<t.length;o+=4){const N=(t[o]+t[o+1]+t[o+2])/3;_+=Math.pow(N-i,2)}const O=Math.sqrt(_/(t.length/4)),re=i>100&&O>40;return{brightness:i,contrast:O,sharpness:ae,hasReceipt:re}},B=r.useCallback(()=>{if(l.current&&w.current&&!p){z(!0),T(!0);const s=l.current,t=w.current;t.width=s.videoWidth,t.height=s.videoHeight,console.log(`ğŸ“¸ æ’®å½±è§£åƒåº¦: ${t.width}x${t.height}`);const a=t.getContext("2d");if(a){a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(s,0,0);const n=t.toDataURL("image/jpeg",.98);console.log(`ğŸ’¾ ç”»åƒã‚µã‚¤ã‚º: ${(n.length/1024/1024).toFixed(2)}MB`),"vibrate"in navigator&&navigator.vibrate(50),setTimeout(()=>{S(n),R&&D(i=>[...i,n]),T(!1)},300)}z(!1)}},[R,p]),Y=()=>{S(null),$(100),F(100),v(0),d&&d.getTracks().forEach(s=>s.stop()),M(null),setTimeout(()=>{E()},100)},ee=s=>{const t=document.createElement("canvas"),a=new Image;a.src=s,t.width=a.width,t.height=a.height;const n=t.getContext("2d");return n?(u!==0&&(n.translate(t.width/2,t.height/2),n.rotate(u*Math.PI/180),n.translate(-t.width/2,-t.height/2)),n.filter=`brightness(${f}%) contrast(${b}%)`,n.drawImage(a,0,0),t.toDataURL("image/jpeg",.95)):s},te=()=>{if(c){const s=ee(c);fetch(s).then(t=>t.blob()).then(t=>H(t))}},L=async s=>{if(!d||c)return;const t=d.getVideoTracks()[0],a=t.getCapabilities();if(a.focusMode&&a.focusMode.includes("manual"))try{await t.applyConstraints({advanced:[{focusMode:"manual"}]})}catch(n){console.warn("Manual focus not supported:",n)}},se=()=>{if(!m)return null;const{brightness:s,contrast:t,hasReceipt:a}=m;return s<40||s>220?{icon:y,text:"æ˜ã‚‹ã•ãŒä¸é©åˆ‡ã§ã™",color:"text-yellow-400"}:t<30?{icon:y,text:"ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãŒä½ã„ã§ã™",color:"text-yellow-400"}:a?{icon:me,text:"æ’®å½±æº–å‚™å®Œäº†ï¼",color:"text-green-400"}:{icon:ue,text:"ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ¤œå‡ºä¸­...",color:"text-blue-400"}};if(I)return e.jsx("div",{className:"fixed inset-0 bg-black z-50 flex items-center justify-center text-white p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(y,{className:"w-16 h-16 mx-auto mb-4 text-red-500"}),e.jsx("p",{className:"mb-4 text-lg",children:I}),e.jsx("button",{onClick:C,className:"px-6 py-3 bg-white/20 rounded-full hover:bg-white/30 transition-colors",children:"é–‰ã˜ã‚‹"})]})});const x=se();return e.jsxs("div",{className:"fixed inset-0 bg-black z-50 flex flex-col",children:[e.jsxs("div",{className:"absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/70 to-transparent",children:[e.jsx("button",{onClick:C,className:"p-3 text-white/90 hover:text-white rounded-full bg-black/30 backdrop-blur-md transition-all hover:bg-black/50",children:e.jsx(le,{size:24})}),!c&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>P(!h),className:`px-4 py-2 rounded-full text-xs font-medium transition-all backdrop-blur-md ${h?"bg-primary/80 text-white":"bg-black/30 text-white/70"}`,children:["è‡ªå‹•æ’®å½±: ",h?"ON":"OFF"]}),e.jsx("button",{onClick:G,className:"p-3 text-white/90 hover:text-white rounded-full bg-black/30 backdrop-blur-md transition-all hover:bg-black/50",children:g==="on"?e.jsx(Z,{size:20,className:"text-yellow-400"}):g==="off"?e.jsx(we,{size:20}):e.jsx(Z,{size:20,className:"text-blue-400"})})]})]}),e.jsxs("div",{className:"flex-1 relative overflow-hidden bg-black",children:[c?e.jsxs("div",{className:"relative w-full h-full flex items-center justify-center",children:[e.jsx("img",{src:c,alt:"Captured",className:"max-w-full max-h-full object-contain",style:{filter:`brightness(${f}%) contrast(${b}%)`,transform:`rotate(${u}deg)`}}),e.jsx("div",{className:"absolute bottom-24 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent",children:e.jsxs("div",{className:"max-w-md mx-auto space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ce,{size:20,className:"text-white"}),e.jsx("input",{type:"range",min:"50",max:"150",value:f,onChange:s=>$(Number(s.target.value)),className:"flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer"}),e.jsxs("span",{className:"text-white text-sm w-12",children:[f,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(pe,{size:20,className:"text-white"}),e.jsx("input",{type:"range",min:"50",max:"150",value:b,onChange:s=>F(Number(s.target.value)),className:"flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer"}),e.jsxs("span",{className:"text-white text-sm w-12",children:[b,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-3 justify-center",children:[e.jsx("button",{onClick:()=>v((u-90)%360),className:"p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors",children:e.jsx(q,{size:20,className:"text-white"})}),e.jsxs("span",{className:"text-white text-sm",children:[u,"Â°"]}),e.jsx("button",{onClick:()=>v((u+90)%360),className:"p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors",children:e.jsx(fe,{size:20,className:"text-white"})})]})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:l,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover",onClick:L,onTouchStart:L}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"relative",style:{width:"85%",paddingBottom:"113.33%"},children:e.jsxs("div",{className:"absolute inset-0 border-4 border-primary/60 rounded-lg shadow-2xl",style:{boxShadow:"0 0 0 9999px rgba(0, 0, 0, 0.6)"},children:[e.jsx("div",{className:"absolute -top-1 -left-1 w-16 h-16 border-t-[6px] border-l-[6px] border-primary rounded-tl-xl shadow-lg shadow-primary/50"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-16 h-16 border-t-[6px] border-r-[6px] border-primary rounded-tr-xl shadow-lg shadow-primary/50"}),e.jsx("div",{className:"absolute -bottom-1 -left-1 w-16 h-16 border-b-[6px] border-l-[6px] border-primary rounded-bl-xl shadow-lg shadow-primary/50"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-16 h-16 border-b-[6px] border-r-[6px] border-primary rounded-br-xl shadow-lg shadow-primary/50"}),e.jsx("div",{className:"absolute top-1/2 left-4 right-4 h-px bg-primary/40"}),e.jsx("div",{className:"absolute left-1/2 top-4 bottom-4 w-px bg-primary/40"}),x&&e.jsx("div",{className:"absolute top-4 left-0 right-0 flex justify-center",children:e.jsxs("div",{className:"px-4 py-2 bg-black/70 backdrop-blur-md rounded-full flex items-center gap-2",children:[e.jsx(x.icon,{size:16,className:x.color}),e.jsx("span",{className:`text-xs font-medium ${x.color}`,children:x.text})]})}),X&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"bg-black/70 backdrop-blur-md rounded-2xl p-6 flex flex-col items-center gap-3",children:[e.jsx(he,{size:32,className:"text-primary animate-spin"}),e.jsx("span",{className:"text-white text-sm",children:"ç”»åƒã‚’è§£æä¸­..."})]})}),e.jsxs("div",{className:"absolute -bottom-16 left-0 right-0 text-center",children:[e.jsx("p",{className:"text-white/90 text-sm font-medium drop-shadow-lg mb-2",children:"ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„"}),e.jsx("p",{className:"text-white/70 text-xs drop-shadow-lg",children:"ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹èª¿æ•´"})]})]})})})]}),e.jsx("canvas",{ref:w,className:"hidden"}),e.jsx("canvas",{ref:j,className:"hidden"})]}),e.jsx("div",{className:"p-6 bg-black flex justify-center items-center gap-8 pb-safe",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:Y,className:"flex flex-col items-center gap-2 text-white/80 hover:text-white transition-colors active:scale-95",children:[e.jsx("div",{className:"p-4 rounded-full bg-white/10 hover:bg-white/20 transition-colors",children:e.jsx(q,{size:24})}),e.jsx("span",{className:"text-xs font-medium",children:"æ’®ã‚Šç›´ã™"})]}),e.jsxs("button",{onClick:te,className:"flex flex-col items-center gap-2 text-primary hover:text-primary/80 transition-all active:scale-95",children:[e.jsx("div",{className:"p-5 rounded-full bg-primary/20 border-4 border-primary shadow-lg shadow-primary/30 hover:shadow-primary/50",children:e.jsx(de,{size:36})}),e.jsx("span",{className:"text-xs font-bold",children:"ã“ã®ç”»åƒã‚’ä½¿ç”¨"})]})]}):e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsxs("button",{onClick:B,disabled:p,className:"relative w-20 h-20 rounded-full border-4 border-white flex items-center justify-center group active:scale-95 transition-all disabled:opacity-50 shadow-2xl",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-white group-hover:bg-gray-200 transition-colors"}),p&&e.jsx("div",{className:"absolute inset-0 rounded-full bg-white/30 animate-ping"})]}),h&&(m==null?void 0:m.hasReceipt)&&e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-green-400 text-xs font-medium animate-pulse",children:"è‡ªå‹•æ’®å½±å¾…æ©Ÿä¸­..."})})]})})]})};export{Te as R};
