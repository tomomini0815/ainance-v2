import{c as q,a as R,e as Z,r as i,j as e,L as K,P as O,i as W,F as X,p as ee,G as x,q as se,T as te,x as re}from"./index-BcSqN67S.js";import{P as ae,y as L,a as B,s as le}from"./PreviousYearImportModal-BqgBtYWD.js";import{B as ne}from"./BalanceSheetImportModal-CVR9vFqv.js";import{A as oe}from"./arrow-left-DdT9VhUy.js";import{F as ce}from"./funnel-BjfJP7iF.js";import{D as $}from"./download-CFylH2lV.js";import{C as de}from"./clock-DuF-3X6J.js";import{C as ie}from"./circle-check-big-C7FRUb5z.js";import"./geminiAIService-DQoIspWT.js";import"./loader-circle-zlJjn_E2.js";import"./arrow-right-BEJ899Mp.js";import"./scale-BUeyyMAu.js";import"./save-BCLCohis.js";/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]],me=q("file-check",xe);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]],he=q("panels-top-left",pe),Pe=()=>{const{user:l}=R(),{currentBusinessType:p}=Z(),[C,E]=i.useState([]),[H,I]=i.useState(!0),[z,g]=i.useState(!1),[Y,w]=i.useState(!1),[J,D]=i.useState(null),[v,Q]=i.useState(""),m=(p==null?void 0:p.business_type)||"individual",a=m==="corporation",U=a?"法人":"個人事業主",j=async()=>{if(l!=null&&l.id){I(!0);try{const[s,t]=await Promise.all([L.getAllByBusinessType(l.id,m),B.getAllByBusinessType(l.id,m)]),n=Array.from(new Set([...s.map(r=>r.year),...t.map(r=>r.year)])).sort((r,o)=>o-r),c=n.map(r=>{const o=s.find(d=>d.year===r),S=t.find(d=>d.year===r),_=n.filter(d=>d<=r).reduce((d,y)=>{const u=s.find(f=>f.year===y),b=t.find(f=>f.year===y),k=(b==null?void 0:b.net_assets_retained_earnings)??(u==null?void 0:u.net_income)??0;return d+k},0);return{year:r,pl:o,bs:S,cumulativeProfit:_}});E(c)}catch(s){console.error("Error fetching history:",s),x.error("データの取得に失敗しました")}finally{I(!1)}}};i.useEffect(()=>{j()},[l==null?void 0:l.id,m]);const V=async s=>{if(window.confirm(`${s.year}年度の全データを削除してもよろしいですか？`))try{s.pl&&await L.delete(s.pl.id),s.bs&&await B.delete(s.bs.id),x.success(`${s.year}年度のデータを削除しました`),j()}catch(t){console.error("Delete error:",t),x.error("削除に失敗しました")}},G=async s=>{var c,r;const n=(((c=s.pl)==null?void 0:c.status)||((r=s.bs)==null?void 0:r.status)||"draft")==="confirmed"?"draft":"confirmed";try{const o=[];s.pl&&o.push(L.updateStatus(s.pl.id,n)),s.bs&&o.push(B.updateStatus(s.bs.id,n)),await Promise.all(o),x.success(`ステータスを${n==="confirmed"?"確定":"下書き"}に変更しました`),j()}catch(o){console.error("Status update error:",o),x.error("ステータスの更新に失敗しました")}},M=async s=>{if(s)try{const t=await le.getSignedUrl(s);t?window.open(t,"_blank"):x.error("ファイルの取得に失敗しました")}catch(t){console.error("Download error:",t),x.error("ダウンロード中にエラーが発生しました")}},h=s=>s===void 0?"-":new Intl.NumberFormat("ja-JP",{style:"currency",currency:"JPY"}).format(s),P=i.useMemo(()=>{if(!v)return C;const s=v.toLowerCase();return C.filter(t=>{var n,c;return t.year.toString().includes(s)||((n=t.pl)==null?void 0:n.revenue.toString().includes(s))||((c=t.pl)==null?void 0:c.net_income.toString().includes(s))})},[C,v]);return e.jsx("div",{className:"min-h-screen bg-background text-text-main",children:e.jsxs("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(K,{to:m==="corporation"?"/corporate-tax":"/tax-filing-wizard",className:"p-2 rounded-lg hover:bg-surface-highlight transition-colors",children:e.jsx(oe,{className:"w-6 h-6 text-text-muted hover:text-text-main"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(he,{className:"w-7 h-7 text-primary"}),a?"過去決算データ・引継ぎ管理":"過去の申告データ・引継ぎ管理"]}),e.jsxs("p",{className:"text-text-muted mt-1",children:[U,"としての過去の",a?"決算履歴":"申告履歴","を確認・管理できます"]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>w(!0),className:"flex items-center gap-2 px-4 py-2 bg-surface border border-primary/20 text-primary rounded-xl hover:bg-primary/5 transition-all font-bold",children:[e.jsx(O,{className:"w-5 h-5"}),a?"貸借対照表(B/S)追加":"貸借対照表を追加"]}),e.jsxs("button",{onClick:()=>g(!0),className:"flex items-center gap-2 px-5 py-2.5 bg-primary text-white rounded-xl hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 font-bold",children:[e.jsx(O,{className:"w-5 h-5"}),a?"損益計算書(P/L)追加":"収支データを追加"]})]})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-2xl p-4 mb-6 flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(W,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-text-muted"}),e.jsx("input",{type:"text",placeholder:"年度や金額で検索...",value:v,onChange:s=>Q(s.target.value),className:"w-full pl-10 pr-4 py-2 bg-background border border-border rounded-xl focus:ring-2 focus:ring-primary outline-none text-sm"})]}),e.jsxs("button",{className:"flex items-center gap-2 px-3 py-2 bg-surface-highlight rounded-xl text-sm font-medium hover:bg-border transition-colors border border-border",children:[e.jsx(ce,{className:"w-4 h-4"}),"フィルター"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-sm text-text-muted mr-2",children:["全 ",P.length," 年度分"]})})]}),e.jsx("div",{className:"bg-surface border border-border rounded-2xl overflow-hidden shadow-sm",children:H?e.jsxs("div",{className:"p-12 text-center group",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-text-muted",children:"読み込み中..."})]}):P.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("div",{className:"bg-surface-highlight w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(X,{className:"w-10 h-10 text-text-muted"})}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"履歴がありません"}),e.jsxs("p",{className:"text-text-muted mb-6",children:["過去の",a?"決算書":"申告・決算書","をアップロードするか、手動で入力して",e.jsx("br",{}),"前期からの数値引き継ぎや経営分析を可能にしましょう。"]}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx("button",{onClick:()=>g(!0),className:"btn-primary px-8 py-3 rounded-xl font-bold",children:a?"P/Lを登録":"収支データを登録"}),e.jsx("button",{onClick:()=>w(!0),className:"btn-ghost px-8 py-3 rounded-xl font-bold border border-border",children:a?"B/Sを登録":"貸借対照表を登録"})]})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"bg-surface-highlight/50 border-b border-border",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 text-xs font-bold text-text-muted uppercase tracking-wider",children:"年度"}),e.jsx("th",{className:"px-6 py-4 text-xs font-bold text-text-muted uppercase tracking-wider",children:a?"損益 (P/L)":"収支・決算 (P/L)"}),e.jsx("th",{className:"px-6 py-4 text-xs font-bold text-text-muted uppercase tracking-wider",children:a?"貸借 (B/S)":"貸借対照表 (B/S)"}),e.jsx("th",{className:"px-6 py-4 text-xs font-bold text-text-muted uppercase tracking-wider",children:"書類"}),e.jsx("th",{className:"px-6 py-4 text-xs font-bold text-text-muted uppercase tracking-wider",children:"状態"}),e.jsx("th",{className:"px-6 py-4 text-xs font-bold text-text-muted uppercase tracking-wider text-right",children:"操作"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:P.map(s=>{var t,n,c,r,o,S,_,d,y,u,b,k,f,F,A,T;return e.jsxs("tr",{className:"hover:bg-surface-highlight/30 transition-colors group",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary font-bold",children:s.year.toString().slice(-2)}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-bold text-text-main",children:[s.year,"年度"]}),e.jsxs("div",{className:"text-xs text-text-muted",children:[a?"P/L":"収支",": ",s.pl?"あり":"なし"," | ",a?"B/S":"貸借",": ",s.bs?"あり":"なし"]})]})]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-xs text-text-muted mb-1",children:["売上: ",h((t=s.pl)==null?void 0:t.revenue)]}),e.jsxs("div",{className:`font-bold ${s.pl&&s.pl.net_income>=0?"text-success":"text-red-500"}`,children:["利益: ",h((n=s.pl)==null?void 0:n.net_income)]})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-xs text-text-muted mb-1",children:["資産: ",h(((c=s.bs)==null?void 0:c.assets_total)||((o=(r=s.pl)==null?void 0:r.balance_sheet)==null?void 0:o.assets_total))]}),e.jsxs("div",{className:"font-bold text-text-main text-sm",children:["純資産: ",(S=s.bs)!=null&&S.net_assets_total?h(s.bs.net_assets_total):(d=(_=s.pl)==null?void 0:_.balance_sheet)!=null&&d.net_assets_total?h(s.pl.balance_sheet.net_assets_total):e.jsxs("span",{className:"text-text-muted italic flex items-center gap-1",title:"資本金 + 過去累計利益（推定）",children:[h(((p==null?void 0:p.capital_amount)||0)+s.cumulativeProfit),e.jsx("span",{className:"text-[10px] text-primary bg-primary/10 px-1 rounded",children:"推定"})]})]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[((y=s.pl)==null?void 0:y.document_path)&&e.jsxs("button",{onClick:()=>{var N;return M((N=s.pl)==null?void 0:N.document_path)},className:"flex items-center gap-1.5 text-xs text-primary hover:underline",children:[e.jsx($,{className:"w-3 h-3"})," ",a?"P/L書類":"収支決算書"]}),((u=s.bs)==null?void 0:u.document_path)&&e.jsxs("button",{onClick:()=>{var N;return M((N=s.bs)==null?void 0:N.document_path)},className:"flex items-center gap-1.5 text-xs text-secondary hover:underline",children:[e.jsx($,{className:"w-3 h-3"})," ",a?"B/S書類":"貸借対照表"]}),!((b=s.pl)!=null&&b.document_path)&&!((k=s.bs)!=null&&k.document_path)&&e.jsx("span",{className:"text-xs text-text-muted",children:"書類なし"})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("button",{onClick:()=>G(s),className:`
                                                        flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold transition-all
                                                        ${((f=s.pl)==null?void 0:f.status)==="confirmed"||((F=s.bs)==null?void 0:F.status)==="confirmed"?"bg-success/10 text-success border border-success/20":"bg-amber-500/10 text-amber-500 border border-amber-500/20"}
                                                    `,children:((A=s.pl)==null?void 0:A.status)==="confirmed"||((T=s.bs)==null?void 0:T.status)==="confirmed"?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-3 h-3"})," 確定済"]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-3 h-3"})," 下書き"]})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsxs("button",{onClick:()=>{s.pl?(D(s.pl),g(!0)):s.bs&&x.error("B/Sデータの編集は現在個別に対応予定です")},className:"px-3 py-1.5 bg-primary/10 text-primary rounded-lg hover:bg-primary hover:text-white transition-all shadow-sm flex items-center gap-1.5 text-xs font-bold whitespace-nowrap",title:"編集",children:[e.jsx(ee,{className:"w-3.5 h-3.5"}),"編集"]}),e.jsxs("button",{onClick:()=>V(s),className:"px-3 py-1.5 bg-rose-500/10 text-rose-500 rounded-lg hover:bg-rose-500 hover:text-white transition-all shadow-sm flex items-center gap-1.5 text-xs font-bold whitespace-nowrap",title:"削除",children:[e.jsx(se,{className:"w-3.5 h-3.5"}),"削除"]})]})})]},s.year)})})]})})}),e.jsxs("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-primary/5 to-secondary/5 border border-primary/10 rounded-2xl p-6",children:[e.jsx(te,{className:"w-8 h-8 text-primary mb-4"}),e.jsx("h4",{className:"font-bold mb-2",children:"引継ぎのメリット"}),e.jsx("p",{className:"text-sm text-text-muted leading-relaxed",children:"前期の数値を登録すると、今期の収支との比較分析が可能になり、経営の健全性をより深く理解できます。"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-success/5 to-primary/5 border border-success/10 rounded-2xl p-6",children:[e.jsx(ie,{className:"w-8 h-8 text-success mb-4"}),e.jsx("h4",{className:"font-bold mb-2",children:"自動転記の連携"}),e.jsxs("p",{className:"text-sm text-text-muted leading-relaxed",children:[a?"決算書PDF":"申告・決算書PDF","からAIが自動で数値を抽出するため、手入力の手間を最小限に抑えられます。"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-amber-500/5 to-red-500/5 border border-amber-500/10 rounded-2xl p-6",children:[e.jsx(re,{className:"w-8 h-8 text-amber-500 mb-4"}),e.jsx("h4",{className:"font-bold mb-2",children:"正確な申告準備"}),e.jsx("p",{className:"text-sm text-text-muted leading-relaxed",children:"貸借対照表の期末残高が翌期首残高として正しく引き継がれているか確認するのにも役立ちます。"})]})]}),e.jsx(ae,{isOpen:z,onClose:()=>{g(!1),D(null)},userId:(l==null?void 0:l.id)||"",businessType:m,onImportSuccess:()=>{j(),g(!1)},initialData:J}),e.jsx(ne,{isOpen:Y,onClose:()=>w(!1),userId:(l==null?void 0:l.id)||"",businessType:m,onImportSuccess:()=>{j(),w(!1)}})]})})};export{Pe as default};
