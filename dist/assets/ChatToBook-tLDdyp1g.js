import{c as q,r as d,s as $,d as re,h as se,u as ae,j as e,L as ne,g as U}from"./index-DbpAXpfG.js";import{A as oe}from"./arrow-left-CmCthLBJ.js";import{S as ce}from"./square-BEWS89CH.js";import{S as ie}from"./send-Bb6zFuDR.js";import{C as P}from"./circle-check-big-C3mejhXj.js";import{S as le}from"./save-3EDGNv8l.js";import{P as de}from"./pen-line-DgQ2exrv.js";/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],M=q("circle",xe);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],ue=q("mic",me),pe=m=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(m),he=(m,u)=>{const[S,T]=d.useState([]),[w,b]=d.useState(!1),p=d.useCallback(()=>u==="corporation"?"corporation_transactions":"individual_transactions",[u]),D=d.useCallback(async()=>{if(!m||!u){b(!1);return}b(!0);const l=p();try{const{data:n,error:i}=await $.from(l).select("*").eq("creator",m).order("date",{ascending:!1});if(i)throw i;T(n||[]),b(!1)}catch(n){console.error(`取引データの取得に失敗しました: ${n}`),T([]),b(!1)}},[m,u,p]),g=async l=>{if(console.log("createTransaction - 開始:",l),!m||!u)return console.log("createTransaction - ユーザーIDまたはビジネスタイプがありません:",{userId:m,businessType:u}),{data:null,error:new Error("ユーザーIDと業態形態が必要です")};try{pe(l.creator)||(console.warn("無効なcreator IDが検出されました。匿名ユーザーとして処理します。"),l.creator="00000000-0000-0000-0000-000000000000");const n={...l,creator:l.creator||"00000000-0000-0000-0000-000000000000"},i=p();console.log("createTransaction - テーブル名:",i),console.log("createTransaction - 保存するデータ:",n);const{data:j,error:N}=await $.from(i).insert(n).select().single();if(console.log("createTransaction - Supabaseからの応答:",{data:j,error:N}),N)throw N;const h=j;return T(f=>[h,...f]),console.log("createTransaction - 新しい取引をローカル状態に追加しました:",h),{data:h,error:null}}catch(n){return console.error("取引の作成に失敗しました:",n),n.message&&n.message.includes("Failed to fetch")?{data:null,error:new Error("ネットワークエラーが発生しました。インターネット接続を確認してください。")}:{data:null,error:n}}},k=async(l,n)=>{if(!m||!u)return{data:null,error:new Error("ユーザーIDと業態形態が必要です")};try{const i=p(),{data:j,error:N}=await $.from(i).update(n).eq("id",l).select().single();if(N)throw N;const h=j;return T(f=>f.map(I=>I.id===l?h:I)),{data:h,error:null}}catch(i){return console.error("取引の更新に失敗しました:",i),{data:null,error:i}}},E=async l=>{if(!m||!u)return{error:new Error("ユーザーIDと業態形態が必要です")};try{const n=p(),{error:i}=await $.from(n).delete().eq("id",l);if(i)throw i;return T(j=>j.filter(N=>N.id!==l)),{error:null}}catch(n){return console.error("取引の削除に失敗しました:",n),{error:n}}};return d.useEffect(()=>{D()},[D]),{transactions:S,loading:w,fetchTransactions:D,createTransaction:g,updateTransaction:k,deleteTransaction:E}},ve=()=>{const[m,u]=d.useState(!1),[S,T]=d.useState(""),[w,b]=d.useState([]),[p,D]=d.useState(null),[g,k]=d.useState({}),[E,l]=d.useState(!1),[n,i]=d.useState([]),[j,N]=d.useState([]),h=d.useRef(null),{user:f}=re(),{currentBusinessType:I}=se(f==null?void 0:f.id),{transactions:L,createTransaction:O,updateTransaction:W,deleteTransaction:B,fetchTransactions:_}=he(f==null?void 0:f.id,I==null?void 0:I.business_type),F=ae();d.useEffect(()=>{if(!("webkitSpeechRecognition"in window)){console.log("Web Speech API is not supported in this browser.");return}const t=new window.webkitSpeechRecognition;return t.continuous=!1,t.interimResults=!0,t.lang="ja-JP",t.onresult=r=>{for(let s=r.resultIndex;s<r.results.length;s++){const c=r.results[s][0].transcript;r.results[s].isFinal&&T(a=>a+c+" ")}},t.onerror=r=>{console.error("音声認識エラー:",r.error),u(!1)},t.onend=()=>{u(!1)},h.current=t,()=>{h.current&&h.current.stop()}},[]),d.useEffect(()=>{b(t=>{const r=L.map(a=>a.id),s=t.filter(a=>!r.includes(a.id)&&!j.includes(a.id));return[...L.filter(a=>!j.includes(a.id)).map(a=>({id:a.id,date:a.date,description:a.description||a.item||"",amount:a.amount,category:a.category,type:a.type,created_at:a.created_at,updated_at:a.updated_at})),...s]})},[L,j]);const H=()=>{h.current&&(h.current.start(),u(!0))},J=()=>{h.current&&(h.current.stop(),u(!1))},K=t=>{const r=/(\d+(?:万)?(?:千)?(?:円)?)/g,s=t.match(r),c=[{keywords:["売上"],category:"業務委託収入",type:"income",priority:10},{keywords:["給与"],category:"給与",type:"income",priority:9},{keywords:["消耗品","文具","コピー","オフィス用品"],category:"消耗品費",type:"expense",priority:10},{keywords:["接待","会食","食事","ディナー","ランチ"],category:"接待交際費",type:"expense",priority:9},{keywords:["交通費","電車","バス","タクシー"],category:"旅費交通費",type:"expense",priority:7},{keywords:["食費","ランチ","ディナー","コーヒー"],category:"食費",type:"expense",priority:6},{keywords:["通信費","電話料金"],category:"通信費",type:"expense",priority:5},{keywords:["光熱費","電気","ガス","水道"],category:"水道光熱費",type:"expense",priority:5},{keywords:["修繕","修理"],category:"修繕費",type:"expense",priority:4},{keywords:["保険"],category:"保険料",type:"expense",priority:4},{keywords:["手数料"],category:"支払手数料",type:"expense",priority:4},{keywords:["新聞","図書"],category:"新聞図書費",type:"expense",priority:3},{keywords:["外注"],category:"外注費",type:"expense",priority:3},{keywords:["税金"],category:"租税公課",type:"expense",priority:3},{keywords:["広告","宣伝"],category:"広告宣伝費",type:"expense",priority:2},{keywords:["地代","家賃"],category:"地代家賃",type:"expense",priority:2},{keywords:["費用","費"],category:"雑費",type:"expense",priority:1}];let a="雑費",x="expense",o=0;for(const v of c)for(const C of v.keywords)t.includes(C)&&v.priority>o&&(a=v.category,x=v.type,o=v.priority);let y=0;if(s&&s.length>0){const v=s[0];if(v.includes("万")){const C=parseFloat(v.replace("万",""));y=isNaN(C)?0:C*1e4}else if(v.includes("千")){const C=parseFloat(v.replace("千",""));y=isNaN(C)?0:C*1e3}else y=parseFloat(v.replace(/[^\d]/g,""))||0}return{date:new Date().toISOString().split("T")[0],description:t,amount:y,category:a,type:x}},V=()=>{S.trim()&&(l(!0),setTimeout(()=>{const t=K(S),s={id:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){const a=Math.random()*16|0;return(c=="x"?a:a&3|8).toString(16)}),...t};b(c=>[s,...c]),T(""),l(!1)},1e3))},z=t=>{D(t.id),k(t)},G=async()=>{if(p&&g)try{const t=await W(p,{date:g.date||"",item:g.description||"",amount:g.amount||0,category:g.category||"未分類",type:g.type||"expense"});if(t.error)throw t.error;b(r=>r.map(s=>s.id===p?{...s,...g}:s)),D(null),k({})}catch(t){console.error("取引の更新に失敗しました:",t),alert("取引の更新に失敗しました: "+t.message)}},Q=async t=>{try{const r=await B(t);if(r.error)throw r.error;b(s=>s.filter(c=>c.id!==t)),i(s=>s.filter(c=>c!==t))}catch(r){console.error("取引の削除に失敗しました:",r),alert("取引の削除に失敗しました: "+r.message)}},A=async t=>{console.log("saveTransactionToDB - 取引データ:",t);try{const r=t.id,{id:s,...c}=t,a=c.description.replace(/(\d+(?:万)?(?:千)?(?:円)?)/g,"").trim();console.log("saveTransactionToDB - 保存するデータ:",c);const x=await O({...c,item:a,type:c.type,creator:(f==null?void 0:f.id)||"00000000-0000-0000-0000-000000000000"});return console.log("saveTransactionToDB - 保存結果:",x),x.data?{id:x.data.id,tempId:r}:(console.error("saveTransactionToDB - 保存失敗:",x.error),null)}catch(r){return console.error("saveTransactionToDB - エラー:",r),null}},X=async t=>{try{console.log("recordTransaction - 開始:",t);const r=await A(t);console.log("recordTransaction - 保存された取引:",r),r&&(b(s=>s.filter(c=>c.id!==t.id)),N(s=>[...s,r.tempId]),console.log("recordTransaction - ローカルリストから削除し、承認された取引のIDを追加しました")),await _(),console.log("recordTransaction - データ再取得完了"),alert("取引が正常に記録されました")}catch(r){if(console.error("取引の記録に失敗しました:",r),r.message.includes("認証セッションが切れました")){alert("認証セッションが切れました。ログインページにリダイレクトします。"),F("/login");return}alert("取引の記録に失敗しました: "+r.message)}},Y=async()=>{const t=w.filter(r=>n.includes(r.id));if(console.log("bulkRecordTransactions - 選択された取引:",t),t.length===0){alert("記録する取引を選択してください");return}try{const r=t.map(o=>A(o)),s=await Promise.allSettled(r);console.log("bulkRecordTransactions - 保存結果:",s);const c=s.filter(o=>o.status==="fulfilled").length,a=s.filter(o=>o.status==="rejected").length;s.forEach((o,y)=>{if(o.status==="rejected"&&(console.error(`取引記録失敗 (${y+1}):`,o.reason),o.reason.message.includes("認証セッションが切れました"))){alert("認証セッションが切れました。ログインページにリダイレクトします。"),F("/login");return}}),a>0?alert(`${c}件の取引が正常に記録されましたが、${a}件の取引の記録に失敗しました。詳細はコンソールを確認してください。`):alert(`${c}件の取引が正常に記録されました`);const x=s.filter(o=>o.status==="fulfilled").map(o=>{var y;return(y=o.value)==null?void 0:y.tempId}).filter(o=>o!==void 0);console.log("bulkRecordTransactions - 成功した取引tempId:",x),console.log("bulkRecordTransactions - 選択された取引ID:",t.map(o=>o.id)),b(o=>o.filter(y=>!t.some(R=>R.id===y.id))),i(o=>o.filter(y=>!t.some(R=>R.id===y))),N(o=>[...o,...x]),await _(),console.log("bulkRecordTransactions - データ再取得完了"),window.dispatchEvent(new CustomEvent("transactionRecorded"))}catch(r){console.error("取引の一括記録中にエラーが発生しました:",r),alert("取引の一括記録に失敗しました: "+r.message)}},Z=async()=>{if(n.length===0){alert("削除する取引を選択してください");return}if(window.confirm(`${n.length}件の取引を削除してもよろしいですか？`))try{const t=n.map(a=>B(a)),r=await Promise.allSettled(t),s=r.filter(a=>a.status==="fulfilled").length,c=r.filter(a=>a.status==="rejected").length;r.forEach((a,x)=>{a.status==="rejected"&&console.error(`取引削除失敗 (${x+1}):`,a.reason)}),c>0?alert(`${s}件の取引が正常に削除されましたが、${c}件の取引の削除に失敗しました。詳細はコンソールを確認してください。`):alert(`${s}件の取引が正常に削除されました`),b(a=>a.filter(x=>!n.includes(x.id))),i([]),await _()}catch(t){console.error("取引の一括削除中にエラーが発生しました:",t),alert("取引の一括削除に失敗しました: "+t.message)}},ee=t=>{i(r=>r.includes(t)?r.filter(s=>s!==t):[...r,t])},te=()=>{n.length===w.length&&w.length>0?i([]):i(w.map(t=>t.id))};return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(ne,{to:"/dashboard",className:"mr-4",children:e.jsx(oe,{className:"w-6 h-6 text-text-muted hover:text-text-main"})}),e.jsx("h1",{className:"text-2xl font-bold text-text-main",children:"CHAT-TO-BOOK"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-surface rounded-xl shadow-sm border border-border p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-text-main mb-4",children:"音声入力"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("button",{onClick:m?J:H,className:`flex items-center justify-center w-16 h-16 rounded-full ${m?"bg-red-500 hover:bg-red-600":"bg-primary hover:bg-primary/90"} text-white transition-colors shadow-lg shadow-primary/25`,children:m?e.jsx(ce,{className:"w-8 h-8"}):e.jsx(ue,{className:"w-8 h-8"})})}),e.jsx("div",{className:"text-center mb-4",children:e.jsx("p",{className:"text-sm text-text-muted",children:m?"音声認識中...":"マイクボタンをクリックして開始"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-text-muted mb-2",children:"認識テキスト"}),e.jsx("textarea",{value:S,onChange:t=>T(t.target.value),rows:4,className:"w-full px-3 py-2 bg-background border border-border rounded-md text-text-main focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"音声認識されたテキストがここに表示されます..."})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:V,disabled:!S.trim()||E,className:`flex items-center px-4 py-2 rounded-md transition-colors ${!S.trim()||E?"bg-surface-highlight text-text-muted cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700"}`,children:E?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"処理中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"取引に変換"]})})})]}),e.jsxs("div",{className:"bg-surface rounded-xl shadow-sm border border-border p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-text-main mb-4",children:"取引一覧"}),e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("p",{className:"text-sm text-text-muted",children:[w.length,"件の取引"]}),n.length>0&&e.jsxs("span",{className:"text-sm text-primary",children:[n.length,"件選択中"]})]}),e.jsx("div",{className:"flex space-x-2",children:n.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:Z,className:"flex items-center px-3 py-1 bg-red-500 text-white rounded-md text-sm hover:bg-red-600 transition-colors",children:[e.jsx(U,{className:"w-4 h-4 mr-1"}),"一括削除 (",n.length,")"]}),e.jsxs("button",{onClick:Y,className:"flex items-center px-3 py-1 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 transition-colors",children:[e.jsx(P,{className:"w-4 h-4 mr-1"}),"一括承認 (",n.length,")"]})]})})]}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-surface-highlight",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:e.jsx("button",{onClick:te,className:"flex items-center",children:n.length===w.length&&w.length>0?e.jsx(P,{className:"w-4 h-4 text-primary"}):e.jsx(M,{className:"w-4 h-4 text-text-muted"})})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"日付"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"説明"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"金額"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"カテゴリ"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"操作"})]})}),e.jsx("tbody",{className:"bg-surface divide-y divide-border",children:w.filter(t=>!j.includes(t.id)).map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("button",{onClick:()=>ee(t.id),className:"flex items-center",children:n.includes(t.id)?e.jsx(P,{className:"w-5 h-5 text-primary"}):e.jsx(M,{className:"w-5 h-5 text-text-muted"})})}),e.jsx("td",{className:"px-4 py-3 text-sm text-text-main",children:p===t.id?e.jsx("input",{type:"date",value:g.date||t.date,onChange:r=>k(s=>({...s,date:r.target.value})),className:"w-full px-2 py-1 bg-background border border-border rounded text-sm text-text-main"}):t.date}),e.jsx("td",{className:"px-4 py-3 text-sm text-text-main max-w-xs",children:p===t.id?e.jsx("input",{type:"text",value:g.description||t.description,onChange:r=>k(s=>({...s,description:r.target.value})),className:"w-full px-2 py-1 bg-background border border-border rounded text-sm text-text-main"}):t.description}),e.jsx("td",{className:"px-4 py-3 text-sm text-text-main",children:p===t.id?e.jsx("input",{type:"number",value:g.amount||t.amount,onChange:r=>k(s=>({...s,amount:Number(r.target.value)})),className:"w-full px-2 py-1 bg-background border border-border rounded text-sm text-text-main"}):e.jsxs("span",{className:t.type==="income"?"text-green-500":"text-red-500",children:[t.type==="income"?"+":"-","¥",t.amount.toLocaleString()]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-text-main",children:p===t.id?e.jsxs("select",{value:g.category||t.category,onChange:r=>k(s=>({...s,category:r.target.value})),className:"w-full px-2 py-1 bg-background border border-border rounded text-sm text-text-main",children:[e.jsx("option",{value:"売上",children:"売上"}),e.jsx("option",{value:"給与",children:"給与"}),e.jsx("option",{value:"交通費",children:"交通費"}),e.jsx("option",{value:"食費",children:"食費"}),e.jsx("option",{value:"消耗品費",children:"消耗品費"}),e.jsx("option",{value:"接待交際費",children:"接待交際費"}),e.jsx("option",{value:"通信費",children:"通信費"}),e.jsx("option",{value:"水道光熱費",children:"水道光熱費"}),e.jsx("option",{value:"雑費",children:"雑費"}),e.jsx("option",{value:"未分類",children:"未分類"})]}):t.category}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium",children:p===t.id?e.jsx("button",{onClick:G,className:"text-green-500 hover:text-green-600 mr-2",children:e.jsx(le,{className:"w-4 h-4"})}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>X(t),className:"text-green-500 hover:text-green-600 mr-2",children:e.jsx(P,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>z(t),className:"text-primary hover:text-primary/80 mr-2",children:e.jsx(de,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>Q(t.id),className:"text-red-500 hover:text-red-600",children:e.jsx(U,{className:"w-4 h-4"})})]})})]},t.id))})]}),w.filter(t=>!j.includes(t.id)).length===0&&e.jsxs("div",{className:"text-center py-8 text-text-muted",children:[e.jsx("p",{children:"まだ取引がありません"}),e.jsx("p",{className:"text-sm mt-2",children:"音声入力で取引を追加してください"})]})]})]})]}),e.jsxs("div",{className:"bg-surface rounded-xl shadow-sm border border-border p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-text-main mb-4",children:"使い方"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"border border-border rounded-lg p-4",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center mb-3",children:e.jsx("span",{className:"text-primary font-bold",children:"1"})}),e.jsx("h3",{className:"font-medium text-text-main mb-2",children:"音声入力開始"}),e.jsx("p",{className:"text-sm text-text-muted",children:"マイクボタンをクリックして、取引内容を話してください。"})]}),e.jsxs("div",{className:"border border-border rounded-lg p-4",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center mb-3",children:e.jsx("span",{className:"text-primary font-bold",children:"2"})}),e.jsx("h3",{className:"font-medium text-text-main mb-2",children:"テキスト確認"}),e.jsx("p",{className:"text-sm text-text-muted",children:"認識されたテキストを確認・編集してください。"})]}),e.jsxs("div",{className:"border border-border rounded-lg p-4",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center mb-3",children:e.jsx("span",{className:"text-primary font-bold",children:"3"})}),e.jsx("h3",{className:"font-medium text-text-main mb-2",children:"取引に変換"}),e.jsx("p",{className:"text-sm text-text-muted",children:"「取引に変換」ボタンをクリックして、取引を登録してください。"})]})]})]})]})})};export{ve as default};
