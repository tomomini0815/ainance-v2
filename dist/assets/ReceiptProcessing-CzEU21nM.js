import{c as W,j as e,r as N,R as ye,F as ue,X as se,S as we,C as ge}from"./index-9K-405_8.js";import{U as ie}from"./upload-Bci8jpA2.js";import{C as be}from"./camera-D-PLNDYh.js";import{S as je}from"./save-C2Lmhjug.js";import{C as Ne}from"./copy-Dtb_t3RJ.js";import{S as ve}from"./share-2-D_Eneu1A.js";import{A as Ce}from"./arrow-right-Cr-vKHxg.js";import{C as Se}from"./circle-check-big-B6da5yIn.js";import{R as ke}from"./refresh-cw-BWiblGzR.js";import{E as fe}from"./eye-DJp6_7jp.js";/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]],Re=W("file-image",Ie);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],Ae=W("image",Pe);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],ce=W("rotate-ccw",Me);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],pe=W("triangle-alert",Te);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],Ee=W("zoom-in",De);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],Oe=W("zoom-out",_e),$e=({onUpload:I})=>e.jsxs("label",{className:"border-2 border-dashed border-border rounded-lg p-6 text-center cursor-pointer hover:border-primary hover:bg-surface-highlight transition-colors block",children:[e.jsx("input",{type:"file",accept:"image/*,application/pdf",multiple:!0,onChange:I,className:"hidden"}),e.jsx(ie,{className:"w-8 h-8 text-text-muted mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-text-main",children:"ファイルを選択"}),e.jsx("p",{className:"text-xs text-text-muted",children:"PNG, JPG, PDF対応"})]});class Fe{parseReceipt(n){console.log("レシート解析を開始。OCRテキスト:",n);const c={store_name:this.extractStoreName(n),date:this.extractDate(n),total_amount:this.extractTotal(n),tax_rate:this.extractTaxRate(n),raw_text:n,confidence:{store_name:this.calculateConfidence("store_name",n),date:this.calculateConfidence("date",n),total_amount:this.calculateConfidence("total_amount",n),tax_rate:this.calculateConfidence("tax_rate",n)},items:this.extractItems(n),items_count:this.extractItemsCount(n)};return console.log("レシート解析結果:",c),c}extractTotal(n){console.log("合計金額抽出を開始");const c=[/合計[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/計[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/Total[^\d]*(?:¥|￥)?[\d,]+\.?\d*/,/お買上金額[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/お会計[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/合\s*計[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/総合計[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/[合計金額合計][^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/お支払総額[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/お支払い金額[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/支払金額[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/お支払[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/,/[Tt]otal\s*:?\s*(?:¥|￥)?[\d,]+\.?\d*/,/[Ss]ubtotal\s*:?\s*(?:¥|￥)?[\d,]+\.?\d*/,/ご購入金額[^\d]*(?:¥|￥)?[\d,]+\.?\d*円?/];let l=0;for(const h of c){const a=n.match(h);if(a){console.log("合計金額のパターンマッチ:",a[0]);const x=a[0].match(/(?:¥|￥)?([\d,]+\.?\d*)円?/);if(x){console.log("金額部分の抽出:",x[1]);const u=x[1].replace(/,/g,""),m=parseFloat(u);!isNaN(m)&&m>l&&(l=m)}}}if(l>0)return console.log("合計金額抽出成功:",l),Math.round(l);const s=n.match(/(?:¥|￥)?([\d,]+\.?\d*)円?/g);if(s&&s.length>0){console.log("数字マッチ:",s);const h=s.map(a=>{const x=a.replace(/[^0-9.]/g,"");return parseFloat(x)}).filter(a=>!isNaN(a)).sort((a,x)=>x-a);if(h.length>0)return console.log("ソートされた数字:",h),console.log("最大の数字を合計金額として採用:",h[0]),Math.round(h[0])}const o=n.match(/[\d,]+\.?\d*/g);if(o&&o.length>0){console.log("すべての数字:",o);const h=o.map(a=>parseFloat(a.replace(/,/g,""))).filter(a=>!isNaN(a)).sort((a,x)=>x-a);if(h.length>0)return console.log("すべての数字から最大値を採用:",h[0]),Math.round(h[0])}return console.log("合計金額の抽出に失敗"),0}extractDate(n){console.log("日付抽出を開始");const c=[/(\d{4})[/年\-\.](\d{1,2})[/月\-\.](\d{1,2})\s*日?/,/(\d{2})[/年\-\.](\d{1,2})[/月\-\.](\d{1,2})\s*日?/,/(\d{4})\s*年\s*(\d{1,2})\s*月\s*(\d{1,2})\s*日/,/(\d{1,2})[/\-\.](\d{1,2})[/\-\.](\d{4})/,/(\d{4})[/\-\.](\d{1,2})[/\-\.](\d{1,2})\s*T\d{2}:\d{2}:\d{2}/,/(\d{4})[/年\-\.](\d{1,2})[/月\-\.](\d{1,2})\s*\d{1,2}:\d{2}/,/(\d{1,2})月(\d{1,2})日(\d{4})年/,/(\d{1,2})\/(\d{1,2})\/(\d{2})/,/(\d{1,2})[-\.](\d{1,2})[-\.](\d{2})/,/[Dd]ate\s*:?\s*(\d{4})[/\-\.](\d{1,2})[/\-\.](\d{1,2})/,/[Dd]ate\s*:?\s*(\d{1,2})[/\-\.](\d{1,2})[/\-\.](\d{4})/];for(const s of c){const o=n.match(s);if(o){console.log("日付のパターンマッチ:",o);let h,a,x;s.toString().includes("(\\d{1,2})[/\\-\\.](\\d{1,2})[/\\-\\.](\\d{4})")||s.toString().includes("(\\d{1,2})月(\\d{1,2})日(\\d{4})年")?(a=o[1].padStart(2,"0"),x=o[2].padStart(2,"0"),h=o[3]):s.toString().includes("(\\d{1,2})\\/(\\d{1,2})\\/(\\d{2})")||s.toString().includes("(\\d{1,2})[-\\.](\\d{1,2})[-\\.](\\d{2})")?(a=o[1].padStart(2,"0"),x=o[2].padStart(2,"0"),h=`20${o[3]}`):(h=o[1],a=o[2].padStart(2,"0"),x=o[3].padStart(2,"0")),h.length===2&&(h=`20${h}`);const u=`${h}-${a}-${x}`;return console.log("日付抽出成功:",u),u}}const l=n.match(/\d{4}[/\-\.年]\d{1,2}[/\-\.月]\d{1,2}/);if(l){const o=l[0].replace(/[年月]/g,"/").replace(/日/g,"").split(/[/\-\.]/);if(o.length===3){const h=o[0],a=o[1].padStart(2,"0"),x=o[2].padStart(2,"0"),u=`${h}-${a}-${x}`;return console.log("代替方法で日付抽出成功:",u),u}}return console.log("日付の抽出に失敗"),""}extractTaxRate(n){console.log("税率抽出を開始");const c=[/税率?\s*(\d+(?:\.\d+)?)%/,/消費税\s*(\d+(?:\.\d+)?)%/,/内消費税\s*(\d+(?:\.\d+)?)%/,/税\s*(\d+(?:\.\d+)?)\s*%/,/(\d+(?:\.\d+)?)%\s*消費税/,/(\d+(?:\.\d+)?)%\s*税/,/(\d+(?:\.\d+)?)%\s*内税/,/(\d+(?:\.\d+)?)%\s*外税/,/[Tt]ax\s*:?\s*(\d+(?:\.\d+)?)%/,/[Rr]ate\s*:?\s*(\d+(?:\.\d+)?)%/,/(\d+(?:\.\d+)?)\s*%\s*[Ii]ncl?\./];for(const l of c){const s=n.match(l);if(s){console.log("税率のパターンマッチ:",s[1]);const o=parseFloat(s[1]);if(!isNaN(o))return console.log("税率抽出成功:",o),o}}return n.includes("8%")||n.includes("0.08")?(console.log("8%の税率を推定"),8):n.includes("10%")||n.includes("0.10")?(console.log("10%の税率を推定"),10):n.includes("内税")||n.includes("税込")?(console.log("内税表示を検出。一般的な税率10%を推定"),10):(console.log("税率の抽出に失敗"),0)}extractStoreName(n){console.log("店舗名抽出を開始");const c=n.split(`
`);console.log("テキスト行数:",c.length);for(let l=0;l<Math.min(20,c.length);l++){const s=c[l].trim();if(console.log(`行${l}:`,s),s&&!s.includes("合計")&&!s.includes("計")&&!s.includes("税率")&&!s.includes("消費税")&&!s.includes("小計")&&!s.includes("預かり")&&!s.includes("お釣り")&&!s.includes("合計")&&!s.includes("レシート")&&!s.includes("領収書")&&!s.includes("売上票")&&!s.includes("No.")&&!s.includes("TEL")&&!s.includes("電話")&&!/^\d+[)%]/.test(s)&&!/^[¥￥]/.test(s)&&!/^\d{4}[/\-\.年]\d{1,2}[/\-\.月]\d{1,2}/.test(s)&&!/^(\d{1,2}:\d{2}|\d{1,2}時\d{1,2}分)/.test(s)&&s.length>1&&(console.log("店舗名候補:",s),!["様","御社","御中","宛","宛先"].some(h=>s.startsWith(h))))return s}for(let l=0;l<Math.min(5,c.length);l++){const s=c[l].trim();if(s&&!/^\d/.test(s)&&s.length>2)return console.log("最終候補として店舗名を返す:",s),s}return console.log("店舗名の抽出に失敗"),""}calculateConfidence(n,c){switch(console.log("信頼度計算を開始。フィールド:",n),n){case"store_name":const l=this.extractStoreName(c);return l&&l.length>1?.9:.1;case"date":const s=this.extractDate(c);return s&&s.length>=8?.95:.2;case"total_amount":return this.extractTotal(c)>0?.9:.3;case"tax_rate":const h=this.extractTaxRate(c);return h>0?.85:h===0?.5:.1;default:return .5}}extractItems(n){console.log("商品アイテム抽出を開始");const c=[],l=n.split(`
`),s=[/(.+?)\s+([0-9,]+)円/,/(.+?)\s+¥([0-9,]+)/,/(.+?)\s+￥([0-9,]+)/,/(.+?)\s+([0-9,]+)\s*円/];for(const o of l)if(!(o.includes("合計")||o.includes("小計")||o.includes("税")||o.includes("/")||o.includes("-")||o.includes(":")))for(const h of s){const a=o.match(h);if(a){const x=a[1].trim(),u=parseInt(a[2].replace(/,/g,""));if(x.length>1&&x.length<50&&u>0&&u<1e5){c.push({name:x,price:u,quantity:1});break}}}return console.log("商品アイテム抽出結果:",c),c}extractItemsCount(n){console.log("アイテム数抽出を開始");const l=this.extractItems(n).length;return console.log("アイテム数:",l),l}}class Le{async adaptiveBinarization(n){return new Promise(c=>{const l=new Image;l.onload=()=>{const s=document.createElement("canvas"),o=s.getContext("2d");if(!o){c(n);return}s.width=l.width,s.height=l.height,o.drawImage(l,0,0);const h=o.getImageData(0,0,s.width,s.height),a=h.data;for(let m=0;m<a.length;m+=4){const y=.299*a[m]+.587*a[m+1]+.114*a[m+2];a[m]=a[m+1]=a[m+2]=y}const x=15,u=10;for(let m=0;m<s.height;m++)for(let y=0;y<s.width;y++){let g=0,b=0;for(let S=-x;S<=x;S++)for(let R=-x;R<=x;R++){const p=y+R,$=m+S;if(p>=0&&p<s.width&&$>=0&&$<s.height){const q=($*s.width+p)*4;g+=a[q],b++}}const j=g/b,C=(m*s.width+y)*4,A=j-u,E=a[C]>A?255:0;a[C]=a[C+1]=a[C+2]=E}o.putImageData(h,0,0),c(s.toDataURL("image/jpeg",.95))},l.src=n})}async deskewImage(n){return new Promise(c=>{const l=new Image;l.onload=()=>{const s=document.createElement("canvas"),o=s.getContext("2d");if(!o){c(n);return}s.width=l.width,s.height=l.height,o.drawImage(l,0,0);const h=this.detectSkewAngle(s);if(Math.abs(h)<2){c(n);return}const a=document.createElement("canvas"),x=a.getContext("2d");if(!x){c(n);return}const u=h*Math.PI/180,m=Math.abs(Math.cos(u)),y=Math.abs(Math.sin(u));a.width=s.width*m+s.height*y,a.height=s.width*y+s.height*m,x.translate(a.width/2,a.height/2),x.rotate(-u),x.drawImage(s,-s.width/2,-s.height/2),c(a.toDataURL("image/jpeg",.95))},l.src=n})}detectSkewAngle(n){const c=n.getContext("2d");if(!c)return 0;const s=c.getImageData(0,0,n.width,n.height).data,o=[];for(let u=1;u<n.height-1;u++)for(let m=1;m<n.width-1;m++){(u*n.width+m)*4;const y=-s[((u-1)*n.width+(m-1))*4]+s[((u-1)*n.width+(m+1))*4]+-2*s[(u*n.width+(m-1))*4]+2*s[(u*n.width+(m+1))*4]+-s[((u+1)*n.width+(m-1))*4]+s[((u+1)*n.width+(m+1))*4],g=-s[((u-1)*n.width+(m-1))*4]+-2*s[((u-1)*n.width+m)*4]+-s[((u-1)*n.width+(m+1))*4]+s[((u+1)*n.width+(m-1))*4]+2*s[((u+1)*n.width+m)*4]+s[((u+1)*n.width+(m+1))*4];if(Math.sqrt(y*y+g*g)>100){const j=Math.atan2(g,y)*(180/Math.PI);o.push(j)}}if(o.length===0)return 0;const h={};for(const u of o){const m=Math.round(u);h[m]=(h[m]||0)+1}let a=0,x=0;for(const[u,m]of Object.entries(h))m>a&&(a=m,x=parseInt(u));return x}async enhanceContrast(n){return new Promise(c=>{const l=new Image;l.onload=()=>{const s=document.createElement("canvas"),o=s.getContext("2d");if(!o){c(n);return}s.width=l.width,s.height=l.height,o.drawImage(l,0,0);const h=o.getImageData(0,0,s.width,s.height),a=h.data,x=new Array(256).fill(0);for(let g=0;g<a.length;g+=4){const b=Math.round(.299*a[g]+.587*a[g+1]+.114*a[g+2]);x[b]++}const u=new Array(256).fill(0);u[0]=x[0];for(let g=1;g<256;g++)u[g]=u[g-1]+x[g];const m=s.width*s.height,y=u.map(g=>Math.round(g/m*255));for(let g=0;g<a.length;g+=4){const b=Math.round(.299*a[g]+.587*a[g+1]+.114*a[g+2]),j=y[b];a[g]=a[g+1]=a[g+2]=j}o.putImageData(h,0,0),c(s.toDataURL("image/jpeg",.95))},l.src=n})}async removeNoise(n){return new Promise(c=>{const l=new Image;l.onload=async()=>{const s=document.createElement("canvas"),o=s.getContext("2d");if(!o){c(n);return}s.width=l.width,s.height=l.height,o.drawImage(l,0,0);const h=await this.gaussianBlur(s,1.5),a=await this.medianFilter(h,3);c(a)},l.src=n})}async gaussianBlur(n,c){return new Promise(l=>{const s=n.getContext("2d");if(!s){l(n.toDataURL("image/jpeg",.95));return}const h=s.getImageData(0,0,n.width,n.height).data,a=Math.ceil(c*3)*2+1,x=[];let u=0;for(let b=0;b<a;b++){const j=b-Math.floor(a/2),C=Math.exp(-(j*j)/(2*c*c));x.push(C),u+=C}for(let b=0;b<x.length;b++)x[b]/=u;const m=new Uint8ClampedArray(h);for(let b=0;b<n.height;b++)for(let j=0;j<n.width;j++)for(let C=0;C<3;C++){let A=0;for(let S=0;S<a;S++){const R=j+S-Math.floor(a/2);if(R>=0&&R<n.width){const p=(b*n.width+R)*4+C;A+=h[p]*x[S]}}const E=(b*n.width+j)*4+C;m[E]=A}const y=new Uint8ClampedArray(m);for(let b=0;b<n.height;b++)for(let j=0;j<n.width;j++)for(let C=0;C<3;C++){let A=0;for(let S=0;S<a;S++){const R=b+S-Math.floor(a/2);if(R>=0&&R<n.height){const p=(R*n.width+j)*4+C;A+=m[p]*x[S]}}const E=(b*n.width+j)*4+C;y[E]=A}for(let b=0;b<h.length;b+=4)y[b+3]=h[b+3];const g=new ImageData(y,n.width,n.height);s.putImageData(g,0,0),l(n.toDataURL("image/jpeg",.95))})}async medianFilter(n,c){return new Promise(l=>{const s=new Image;s.onload=()=>{const o=document.createElement("canvas"),h=o.getContext("2d");if(!h){l(n);return}o.width=s.width,o.height=s.height,h.drawImage(s,0,0);const x=h.getImageData(0,0,o.width,o.height).data,u=new Uint8ClampedArray(x),m=Math.floor(c/2);for(let g=0;g<o.height;g++)for(let b=0;b<o.width;b++)for(let j=0;j<3;j++){const C=[];for(let S=-m;S<=m;S++)for(let R=-m;R<=m;R++){const p=g+S,$=b+R;if(p>=0&&p<o.height&&$>=0&&$<o.width){const q=(p*o.width+$)*4+j;C.push(x[q])}}C.sort((S,R)=>S-R);const A=C[Math.floor(C.length/2)],E=(g*o.width+b)*4+j;u[E]=A}const y=new ImageData(u,o.width,o.height);h.putImageData(y,0,0),l(o.toDataURL("image/jpeg",.95))},s.src=n})}async sharpenText(n){return new Promise(c=>{const l=new Image;l.onload=async()=>{const s=document.createElement("canvas"),o=s.getContext("2d");if(!o){c(n);return}s.width=l.width,s.height=l.height,o.drawImage(l,0,0);const h=await this.gaussianBlur(s,1),a=new Image;a.onload=()=>{const x=document.createElement("canvas"),u=x.getContext("2d");if(!u){c(n);return}x.width=s.width,x.height=s.height,u.drawImage(a,0,0);const m=o.getImageData(0,0,s.width,s.height),y=u.getImageData(0,0,s.width,s.height),g=1.5;for(let b=0;b<m.data.length;b+=4)for(let j=0;j<3;j++){const C=m.data[b+j],A=y.data[b+j],E=C-A,S=C+E*g;m.data[b+j]=Math.max(0,Math.min(255,S))}o.putImageData(m,0,0),c(s.toDataURL("image/jpeg",.95))},a.src=h},l.src=n})}async processImage(n,c={}){let l=n;return c.deskew!==!1&&(console.log("傾き補正を実行中..."),l=await this.deskewImage(l)),c.removeNoise!==!1&&(console.log("ノイズ除去を実行中..."),l=await this.removeNoise(l)),c.enhanceContrast!==!1&&(console.log("コントラスト強化を実行中..."),l=await this.enhanceContrast(l)),c.sharpen!==!1&&(console.log("シャープ化を実行中..."),l=await this.sharpenText(l)),c.binarize!==!1&&(console.log("適応的二値化を実行中..."),l=await this.adaptiveBinarization(l)),l}}const ze=I=>{const[n,c]=N.useState(!1),[l,s]=N.useState(!1),[o,h]=N.useState(null),[a,x]=N.useState(null),[u,m]=N.useState(!1),[y,g]=N.useState(null),[b,j]=N.useState(1),[C,A]=N.useState(!1),[E,S]=N.useState(0),[R,p]=N.useState([]),[$,q]=N.useState(!1),[Q,de]=N.useState(0),[ne,me]=N.useState(!1),O=N.useRef(null),G=N.useRef(null),F=N.useRef(null),T=N.useRef(null);N.useRef(null),N.useRef(null);const X=new Le,J={CAMERA_PERMISSION:"カメラの使用許可が必要です",OCR_FAILED:"レシートの読み取りに失敗しました",NO_DATA_FOUND:"必要な情報が見つかりませんでした",INVALID_IMAGE:"画像が不鮮明です。再度撮影してください"},Z=async()=>{if(console.log("カメラ起動ボタンがクリックされました"),console.log("現在のプロトコル:",location.protocol),console.log("現在のホスト名:",location.hostname),location.protocol!=="https:"&&location.hostname!=="localhost"&&location.hostname!=="127.0.0.1"){if(console.log("HTTPS環境での警告を表示します"),!window.confirm("モバイル端末でカメラ機能を使用するにはHTTPS環境が必要です。現在のHTTP環境ではカメラが動作しない可能性があります。テストを続行しますか？")){console.log("ユーザーが警告をキャンセルしました");return}console.log("ユーザーが警告を確認しました")}s(!0),console.log("カメラ使用許可モーダルを表示しました")},ae=async()=>{console.log("カメラ許可ボタンがクリックされました");try{s(!1),console.log("カメラアクセスを試行中..."),console.log("カメラ制約を設定中...");const r={video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}}};console.log("カメラ制約:",r);const d=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(console.log("モバイル環境チェック:",d),d){const v={video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}}};console.log("モバイル用カメラ制約:",v);const w=await navigator.mediaDevices.getUserMedia(v);console.log("モバイル環境でカメラストリームを取得しました:",w),F.current=w,T.current=w.getVideoTracks()[0],O.current&&(O.current.srcObject=w,console.log("video要素にストリームを設定しました"))}else{const v=await navigator.mediaDevices.getUserMedia(r);console.log("カメラストリームを取得しました:",v),F.current=v,T.current=v.getVideoTracks()[0],O.current&&(O.current.srcObject=v,console.log("video要素にストリームを設定しました"))}c(!0),g(null),console.log("カメラが正常に起動しました")}catch(r){console.error("カメラ起動エラー:",r),r.name==="NotAllowedError"?g("カメラの使用が拒否されました。ブラウザの設定でカメラの使用を許可してください。"):r.name==="NotFoundError"?g("利用可能なカメラが見つかりません。"):r.name==="NotReadableError"?g("カメラが他のアプリケーションによって使用中です。"):location.protocol!=="https:"&&location.hostname!=="localhost"&&location.hostname!=="127.0.0.1"?g("モバイル端末でカメラ機能を使用するにはHTTPS環境が必要です。HTTPS環境またはlocalhostでのみカメラ機能を使用できます。"):g(J.CAMERA_PERMISSION)}},Y=()=>{console.log("カメラ停止処理を開始"),F.current&&(F.current.getTracks().forEach(r=>{console.log("トラックを停止:",r),r.stop()}),F.current=null,T.current=null),c(!1),console.log("カメラ停止処理完了")},oe=async()=>{if(T.current&&"torch"in T.current.getCapabilities())try{const r=!C;await T.current.applyConstraints({advanced:[{torch:r}]}),A(r)}catch(r){console.error("フラッシュの切り替えに失敗しました:",r),g("フラッシュの切り替えに失敗しました")}else g("このデバイスではフラッシュがサポートされていません")},K=async r=>{if(T.current&&"zoom"in T.current.getCapabilities())try{const d=T.current.getCapabilities(),w=T.current.getSettings().zoom||1,P=Math.min(Math.max(w+r,d.zoom.min),d.zoom.max);await T.current.applyConstraints({advanced:[{zoom:P}]}),j(P)}catch(d){console.error("ズームの調整に失敗しました:",d)}},re=async()=>{if(console.log("写真撮影を開始"),O.current&&G.current){const r=O.current,d=G.current,v=d.getContext("2d");if(console.log("video要素のサイズ:",r.videoWidth,"x",r.videoHeight),d.width=r.videoWidth,d.height=r.videoHeight,v){v.drawImage(r,0,0,d.width,d.height),console.log("canvasに画像を描画しました");const w=d.toDataURL("image/jpeg",.9);console.log("画像データを取得しました。データURLの長さ:",w.length),console.log("高度な画像処理を開始...");const P=await X.processImage(w,{deskew:!0,binarize:!0,enhanceContrast:!0,removeNoise:!0,sharpen:!0});console.log("画像処理完了"),h(P),Y(),k(P)}else console.error("canvasのコンテキストを取得できませんでした"),g("画像処理に失敗しました。もう一度お試しください。")}else console.error("videoまたはcanvas要素が見つかりません"),g("カメラが正しく初期化されていません。もう一度お試しください。")},ee=async r=>{console.log("OCR処理を開始");const d=r.split(",")[1];return console.log("Base64画像データの長さ:",d==null?void 0:d.length),console.log("APIキーの存在確認:",!1),console.warn("Google Cloud Vision APIキーが設定されていません。サンプルデータを返します。"),`ダイエー
2024/01/15 14:30:25
りんご 1個 120円
バナナ 2本 200円
合計 320円
税率 10% 内消費税 29円`},te=(r,d)=>{console.log("AI分析を開始");const v={category:le(r),expenseType:t(r),confidence:i(r,d),insights:f(r,d)};return console.log("AI分析結果:",v),v},le=r=>{const d={食費:["レストラン","カフェ","マクドナルド","スターバックス","居酒屋","ラーメン","寿司"],交通費:["電車","バス","タクシー","ガソリン","駐車場"],買い物:["スーパー","ダイエー","セブンイレブン","ローソン","ファミリーマート","Amazon","楽天"],娯楽:["映画","ゲーム","本屋","CD","DVD"],医療:["病院","薬局","クリニック"],教育:["書店","学習塾","受験","教材"],通信:["電話","インターネット","携帯"],公共:["水道","電気","ガス","NHK"],その他:[]};for(const[v,w]of Object.entries(d))for(const P of w)if(r.includes(P))return v;return"その他"},t=r=>r.includes("給与")||r.includes("収入")?"収入":r.includes("交通")||r.includes("電車")||r.includes("バス")?"交通費":r.includes("食")||r.includes("レストラン")||r.includes("カフェ")?"食費":r.includes("買い物")||r.includes("スーパー")?"買い物":"一般支出",i=(r,d)=>{const v=Math.min(r.length/100,1);let w=0;d.store_name&&d.store_name.length>1&&(w+=.25),d.date&&d.date.length>0&&(w+=.25),d.total_amount&&d.total_amount>0&&(w+=.25),d.tax_rate!==void 0&&(w+=.25);const P=(v+w)/2;return Math.min(Math.max(P,0),1)},f=(r,d)=>{const v=[];d.total_amount>1e4&&v.push("高額な支出です。経費精算の際には詳細な説明が必要かもしれません。");const w=new Date,P=new Date(d.date);return Math.floor((w.getTime()-P.getTime())/(1e3*60*60*24))>30&&v.push("このレシートは30日以上前のものです。経費申請の期限に注意してください。"),(r.includes("コンビニ")||r.includes("セブンイレブン")||r.includes("ローソン")||r.includes("ファミリーマート"))&&v.push("コンビニでの購入です。領収書がなくても電子レシートで申請可能です。"),v},k=async r=>{console.log("画像処理を開始"),m(!0),g(null),I.onProcessingStateChange&&I.onProcessingStateChange({isProcessing:!0,progress:0,currentStep:"画像前処理中..."});try{L(r),console.log("OCR処理を実行中..."),I.onProcessingStateChange&&I.onProcessingStateChange({isProcessing:!0,progress:30,currentStep:"OCR処理中..."});const d=await ee(r);console.log("OCR処理完了。結果の長さ:",d.length),console.log("データ抽出を実行中..."),I.onProcessingStateChange&&I.onProcessingStateChange({isProcessing:!0,progress:60,currentStep:"データ抽出中..."});const w=new Fe().parseReceipt(d);console.log("データ抽出完了:",w),console.log("AI分析を実行中..."),I.onProcessingStateChange&&I.onProcessingStateChange({isProcessing:!0,progress:80,currentStep:"AI分析中..."});const P=te(d,w),V={...w,category:P.category,expenseType:P.expenseType,aiConfidence:P.confidence,insights:P.insights};if(!D(V))throw new Error("NO_DATA_FOUND");I.onProcessingStateChange&&I.onProcessingStateChange({isProcessing:!0,progress:90,currentStep:"処理完了..."}),x(V),I.onScanComplete(V)}catch(d){console.error("OCR処理エラー:",d),g(J[d.message]||"予期しないエラーが発生しました")}finally{m(!1),I.onProcessingStateChange&&I.onProcessingStateChange({isProcessing:!1,progress:100,currentStep:"完了"})}},D=r=>{console.log("データバリデーションを実行中:",r);const d=r.store_name.length>0&&r.date.length>0&&r.total_amount>0;return console.log("データバリデーション結果:",d),d},L=r=>(console.log("画像品質チェックを実行中"),console.log("画像品質チェック結果: OK"),!0),_=()=>{h(null),x(null),g(null),Z()},U=async r=>{var v;const d=(v=r.target.files)==null?void 0:v[0];if(d){const w=new FileReader;w.onload=async P=>{var xe;const V=(xe=P.target)==null?void 0:xe.result;if(V){const he=await X.processImage(V,{deskew:!0,binarize:!0,enhanceContrast:!0,removeNoise:!0,sharpen:!0});h(he),k(he)}},w.readAsDataURL(d)}},z=(r,d)=>{a&&x({...a,[r]:d})},B=()=>{if(a){const r={success:!0,data:a,confidence:a.confidence},d=JSON.stringify(r,null,2);console.log(d)}},M=()=>{if(a){const r=JSON.stringify(a,null,2);navigator.clipboard.writeText(r)}},H=()=>{a&&navigator.share&&navigator.share({title:"レシートデータ",text:JSON.stringify(a,null,2)})};return N.useEffect(()=>()=>{F.current&&F.current.getTracks().forEach(r=>r.stop())},[]),e.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[l&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"カメラの使用許可"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"レシートをスキャンするには、カメラへのアクセス許可が必要です。 カメラでレシートを撮影するためにアクセスを許可してください。"}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:()=>s(!1),className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors",children:"キャンセル"}),e.jsx("button",{onClick:ae,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"許可する"})]})]})})}),!o&&!a&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"レシートスキャナー"}),n?e.jsxs("div",{className:"relative",children:[e.jsx("video",{ref:O,autoPlay:!0,playsInline:!0,className:"w-full h-96 object-cover rounded-lg bg-gray-100"}),e.jsx("div",{className:"absolute inset-0 border-2 border-dashed border-white m-8 pointer-events-none"}),e.jsxs("div",{className:"absolute top-4 right-4 flex flex-col space-y-2",children:[e.jsx("button",{onClick:()=>K(1),className:"p-2 bg-black bg-opacity-50 rounded-full text-white",children:e.jsx(Ee,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>K(-1),className:"p-2 bg-black bg-opacity-50 rounded-full text-white",children:e.jsx(Oe,{className:"w-5 h-5"})}),e.jsx("button",{onClick:oe,className:`p-2 rounded-full ${C?"bg-yellow-500":"bg-black bg-opacity-50"} text-white`,children:e.jsx("span",{className:"text-xs",children:"FLASH"})})]}),e.jsxs("div",{className:"flex justify-center mt-4 space-x-4",children:[e.jsx("button",{onClick:re,className:"w-16 h-16 rounded-full bg-white border-4 border-gray-300 flex items-center justify-center hover:bg-gray-100 transition-colors",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-red-500"})}),e.jsx("button",{onClick:Y,className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors",children:"キャンセル"})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{onClick:Z,className:"w-full py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center",children:[e.jsx(be,{className:"w-5 h-5 mr-2"}),"カメラで撮影"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:U,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer"}),e.jsxs("button",{className:"w-full py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center",children:[e.jsx(Ae,{className:"w-5 h-5 mr-2"}),"画像を選択"]})]})]}),y&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700",children:y})]}),o&&!a&&u&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"処理中..."}),e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})]}),o&&a&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"抽出結果"}),e.jsx("div",{className:"mb-6",children:e.jsx("img",{src:o,alt:"Captured receipt",className:"w-full h-48 object-contain rounded-lg border"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"店舗名"}),e.jsx("input",{type:"text",value:a.store_name,onChange:r=>z("store_name",r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"日付"}),e.jsx("input",{type:"date",value:a.date,onChange:r=>z("date",r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"合計金額"}),e.jsx("input",{type:"number",value:a.total_amount,onChange:r=>z("total_amount",parseInt(r.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"税率"}),e.jsx("input",{type:"number",value:a.tax_rate,onChange:r=>z("tax_rate",parseInt(r.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),a.category&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"カテゴリ（AI推定）"}),e.jsx("div",{className:"px-3 py-2 bg-blue-50 border border-blue-200 rounded-md",children:a.category})]}),a.expenseType&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"支出種別（AI推定）"}),e.jsx("div",{className:"px-3 py-2 bg-blue-50 border border-blue-200 rounded-md",children:a.expenseType})]}),a.aiConfidence!==void 0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"AI信頼度"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:e.jsx("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:`${a.aiConfidence*100}%`}})}),e.jsxs("span",{className:"ml-2 text-sm text-gray-600",children:[Math.round(a.aiConfidence*100),"%"]})]})]}),a.insights&&a.insights.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"分析インサイト"}),e.jsx("ul",{className:"list-disc pl-5 space-y-1",children:a.insights.map((r,d)=>e.jsx("li",{className:"text-sm text-gray-600",children:r},d))})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-6",children:[e.jsxs("button",{onClick:_,className:"flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"再撮影"]}),e.jsxs("button",{onClick:B,className:"flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"保存"]}),e.jsxs("button",{onClick:M,className:"flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"コピー"]}),typeof navigator.share<"u"&&e.jsxs("button",{onClick:H,className:"flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors",children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"共有"]})]}),y&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700",children:y})]}),e.jsx("canvas",{ref:G,className:"hidden"})]})},Qe=()=>{const[I,n]=N.useState([{id:"1",date:"2024-01-15",merchant:"セブンイレブン",amount:1200,category:"消耗品費",description:"事務用品購入",confidence:95,status:"pending"},{id:"2",date:"2024-01-14",merchant:"スターバックス",amount:580,category:"接待交際費",description:"クライアント打ち合わせ",confidence:88,status:"approved"}]),[c,l]=N.useState({isProcessing:!1,retryCount:0}),s=[{id:"3",date:"2024-01-16",merchant:"ローソン",amount:750,category:"消耗品費",description:"コピー用紙",confidence:90,status:"pending"},{id:"4",date:"2024-01-13",merchant:"マクドナルド",amount:680,category:"接待交際費",description:"社内打合せ",confidence:85,status:"pending"}],[o,h]=N.useState(null),[a,x]=N.useState({}),[u,m]=N.useState(!1),y=N.useRef(null),g=N.useRef(null),b=N.useRef(null),[j,C]=N.useState(""),[A,E]=N.useState("all"),[S,R]=N.useState("all"),[p,$]=N.useState(null),[q,Q]=N.useState(!1),de=async()=>{const t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(location.protocol!=="https:"&&location.hostname!=="localhost"&&location.hostname!=="127.0.0.1"){if(t){if(!window.confirm("モバイル端末からのカメラアクセスにはHTTPS環境が必要です。現在はHTTP環境のため、カメラが動作しない可能性があります。テスト目的であれば、PCのlocalhost環境でアクセスしてください。続行しますか？"))return}else if(!window.confirm("カメラ機能を使用するにはHTTPS環境またはlocalhostが必要です。HTTP環境ではカメラが動作しない可能性があります。続行しますか？"))return}try{let i;try{i=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}})}catch(f){console.warn("背面カメラが利用できません。フロントカメラを試します。",f),i=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720}}})}b.current=i,y.current&&(y.current.srcObject=i),m(!0)}catch(i){console.error("カメラの起動に失敗しました:",i),i instanceof DOMException&&i.name==="NotAllowedError"?alert("カメラの使用が拒否されました。ブラウザの設定でカメラの使用を許可してください。"):i instanceof DOMException&&i.name==="NotFoundError"?alert("利用可能なカメラが見つかりません。"):i instanceof DOMException&&i.name==="NotReadableError"?alert("カメラが他のアプリケーションによって使用中です。"):location.protocol!=="https:"?alert(t?"モバイル端末からのカメラアクセスにはHTTPS環境が必要です。PCのlocalhost環境でテストしてください。":"カメラの起動に失敗しました。HTTP環境ではカメラが動作しない可能性があります。HTTPS環境またはlocalhostでのみカメラ機能を使用できます。"):alert("カメラの起動に失敗しました。ブラウザの設定を確認してください。")}},ne=()=>{b.current&&(b.current.getTracks().forEach(t=>t.stop()),b.current=null),m(!1)},me=async()=>{if(y.current&&g.current){const t=y.current,i=g.current,f=i.getContext("2d");i.width=t.videoWidth,i.height=t.videoHeight,f&&(f.drawImage(t,0,0,i.width,i.height),i.toBlob(async k=>{k&&await O(k)},"image/jpeg",.95)),ne()}},O=async t=>{await G(t)},G=async t=>{l({isProcessing:!0,retryCount:0});try{const i=new FileReader;i.onload=async f=>{var U,z,B;const k=(U=f.target)==null?void 0:U.result;if(!k)throw new Error("画像データの読み込みに失敗しました");const D=k.split(",")[1],L=void 0;if(!L)throw new Error("Google Cloud Vision APIキーが設定されていません");const _={id:Date.now().toString(),date:new Date().toISOString().split("T")[0],merchant:"処理中...",amount:0,category:"未分類",description:"解析中...",confidence:0,status:"pending"};n(M=>[_,...M]);try{const M=await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${L}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requests:[{image:{content:D},features:[{type:"TEXT_DETECTION",maxResults:100}]}]})});if(!M.ok)throw new Error(`APIリクエスト失敗: ${M.status} ${M.statusText}`);const H=await M.json();console.log("Vision API結果:",H);const r=((B=(z=H.responses[0])==null?void 0:z.fullTextAnnotation)==null?void 0:B.text)||"";if(!r)throw new Error("テキストが検出されませんでした");const d=F(r);n(v=>v.map(w=>w.id===_.id?{...w,merchant:d.merchant||"不明",date:d.date||w.date,amount:d.amount||0,taxRate:d.taxRate||0,description:d.description||"OCR処理完了",confidence:d.confidence||80,confidenceScores:d.confidenceScores}:w))}catch(M){console.error("Vision API処理エラー:",M),n(H=>H.map(r=>r.id===_.id?{...r,merchant:"解析エラー",description:`OCR処理に失敗しました: ${M.message}`,confidence:0}:r))}finally{l(M=>({...M,isProcessing:!1}))}},i.readAsDataURL(t)}catch(i){console.error("画像処理エラー:",i),l(f=>({...f,isProcessing:!1,errorMessage:`画像の処理中にエラーが発生しました: ${i.message}`}))}},F=t=>{const i={date:/(\d{4}[年/-]\d{1,2}[月/-]\d{1,2}[日]?)|(\d{2}\/\d{2}\/\d{2})/i,taxRate:/税率?\s*([0-9]+)%|消費税.*?([0-9]+)%/i,storeName:/^([ァ-ヴー・ａ-ｚＡ-Ｚ0-9\u4E00-\u9FFF]+)(店|ストア|マート)/i};let f="不明",k=0;const D=t.match(i.storeName);if(D)f=D[1]+(D[2]||""),k=90;else{const v=["セブンイレブン","ローソン","ファミリーマート","スターバックス","マクドナルド"];for(const w of v)if(t.includes(w)){f=w,k=80;break}}let L="",_=0;const U=t.match(i.date);U&&(L=U[0],_=85);let z=0,B=0;const M=t.match(/\d{3,}/g);M&&(z=Math.max(...M.map(Number)),B=80);let H=0,r=0;const d=t.match(i.taxRate);return d&&(H=parseInt(d[1]||d[2]),r=85),{merchant:f,date:L,amount:z,taxRate:H,description:"OCRで抽出",confidence:Math.round((k+_+B+r)/4),confidenceScores:{merchant:k,date:_,amount:B,taxRate:r}}},T=async t=>{const i=t.target.files;if(i&&i.length>0){const f=i[0],k=new FileReader;k.onload=async D=>{var _;const L=(_=D.target)==null?void 0:_.result;if(L){const U=new Blob([L],{type:f.type});await O(U)}},k.readAsArrayBuffer(f)}},X=()=>{o&&a&&(n(t=>t.map(i=>i.id===o?{...i,...a}:i)),h(null),x({}))},J=t=>{n(i=>i.map(f=>f.id===t?{...f,status:"approved"}:f))},Z=t=>{n(i=>i.map(f=>f.id===t?{...f,status:"rejected"}:f))},ae=()=>{n(t=>[...s,...t])},Y=async()=>{try{const t={id:Date.now().toString(),date:new Date().toISOString().split("T")[0],merchant:"処理中...",amount:0,category:"未分類",description:"解析中...",confidence:0,status:"pending"};n(k=>[t,...k]);const f=F(`セブンイレブン
2024/01/15
レシート番号: 12345
商品名: コピー用紙 ￥1,200
消費税: ￥120
合計: ￥1,320
      
マクドナルド
2024/01/14
商品名: ビッグマックセット ￥680
消費税: ￥68
合計: ￥748`);n(k=>k.map(D=>D.id===t.id?{...D,merchant:f.merchant||"不明",amount:f.amount||0,description:f.description||"OCR処理完了",confidence:f.confidence||80}:D))}catch(t){console.error("OCRテストエラー:",t)}},oe=t=>{const i={id:Date.now().toString(),date:t.date,merchant:t.store_name,amount:t.total_amount,category:t.category||"未分類",description:"スキャンされたレシート",confidence:Math.round((t.confidence.store_name+t.confidence.date+t.confidence.total_amount+t.confidence.tax_rate)/4*100),status:"pending",taxRate:t.tax_rate,aiAnalysis:{category:t.category,expenseType:t.expenseType,confidence:t.aiConfidence,insights:t.insights,items:t.items}};n(f=>[i,...f])},K=async t=>{n(i=>i.map(f=>f.id===t?{...f,merchant:"処理中...",amount:0,description:"再解析中...",confidence:0}:f)),setTimeout(()=>{n(i=>i.map(f=>f.id===t?{...f,merchant:"ファミリーマート",amount:950,description:"再解析完了",confidence:88}:f))},3e3)},re=async()=>{if(c.imageData&&c.retryCount<3){l(t=>({...t,retryCount:t.retryCount+1,errorMessage:void 0}));try{const i=await(await fetch(c.imageData)).blob();await O(i)}catch(t){console.error("再試行エラー:",t),l(i=>({...i,errorMessage:"再試行に失敗しました"}))}}},ee=t=>{$(t),Q(!0)},te=I.filter(t=>{const i=t.merchant.toLowerCase().includes(j.toLowerCase())||t.description.toLowerCase().includes(j.toLowerCase()),f=A==="all"||t.status===A,k=S==="all"||t.category===S;return i&&f&&k}),le=Array.from(new Set(I.map(t=>t.category)));return ye.useEffect(()=>()=>{b.current&&b.current.getTracks().forEach(t=>t.stop())},[]),e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&location.protocol!=="https:"&&e.jsx("div",{className:"mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md",children:e.jsxs("div",{className:"flex",children:[e.jsx(pe,{className:"w-5 h-5 text-yellow-500 mr-2 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-yellow-800",children:"モバイル端末からのアクセスについて"}),e.jsx("p",{className:"text-xs text-yellow-700 mt-1",children:"現在HTTP環境でアクセスしています。カメラ機能を使用するにはHTTPS環境が必要です。 テスト目的であれば、PCのlocalhost環境（http://localhost:5173）でアクセスしてください。"})]})]})}),e.jsxs("div",{className:"p-6 max-w-7xl mx-auto space-y-8",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:"レシート処理"}),e.jsx("p",{className:"text-text-muted mt-2",children:"アップロードされたレシートをAIが解析し、自動で仕訳データを作成します"})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-surface border border-border rounded-2xl p-6 shadow-sm",children:[e.jsxs("h2",{className:"text-xl font-semibold text-text-main mb-4 flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5 text-primary"}),"レシートアップロード"]}),e.jsx($e,{onUpload:T})]}),e.jsxs("div",{className:"bg-surface border border-border rounded-2xl p-6 shadow-sm",children:[e.jsxs("h2",{className:"text-xl font-semibold text-text-main mb-4 flex items-center gap-2",children:[e.jsx(ue,{className:"w-5 h-5 text-primary"}),"最近のアップロード"]}),e.jsx("div",{className:"space-y-4",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-background rounded-xl border border-border hover:border-primary/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary",children:e.jsx(ue,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-text-main",children:"セブンイレブン ジャパン"}),e.jsxs("p",{className:"text-sm text-text-muted",children:["2024年3月",15-t,"日 12:30"]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium bg-green-500/10 text-green-500 border border-green-500/20",children:"処理完了"}),e.jsx("button",{className:"p-2 text-text-muted hover:text-primary transition-colors",children:e.jsx(Ce,{className:"w-5 h-5"})})]})]},t))})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-surface border border-border rounded-2xl p-6 shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-text-main mb-4",children:"処理ステータス"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-background rounded-xl border border-border",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-text-muted",children:"今月の処理枚数"}),e.jsx("span",{className:"text-2xl font-bold text-text-main",children:"45枚"})]}),e.jsx("div",{className:"w-full bg-surface-highlight rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full",style:{width:"75%"}})})]}),e.jsxs("div",{className:"p-4 bg-background rounded-xl border border-border",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-text-muted",children:"AI認識精度"}),e.jsx("span",{className:"text-2xl font-bold text-text-main",children:"98.5%"})]}),e.jsx("div",{className:"w-full bg-surface-highlight rounded-full h-2",children:e.jsx("div",{className:"bg-secondary h-2 rounded-full",style:{width:"98.5%"}})})]}),e.jsxs("div",{className:"p-4 bg-background rounded-xl border border-border",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-text-muted",children:"削減時間"}),e.jsx("span",{className:"text-2xl font-bold text-text-main",children:"12.5時間"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-500",children:[e.jsx(Se,{className:"w-4 h-4"}),e.jsx("span",{children:"先月比 +2.5時間"})]})]})]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-primary/10 to-secondary/10 border border-primary/20 rounded-2xl p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-text-main mb-2",children:"Proプランでさらに便利に"}),e.jsx("p",{className:"text-sm text-text-muted mb-4",children:"月間処理枚数無制限、優先処理、専任サポートなど、ビジネスを加速させる機能をご利用いただけます。"}),e.jsx("button",{className:"w-full py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors shadow-lg shadow-primary/25",children:"プランを確認する"})]})]})]})]}),u&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-surface rounded-lg w-full max-w-2xl",children:[e.jsxs("div",{className:"p-4 border-b border-border flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"カメラでレシートを撮影"}),e.jsx("button",{onClick:ne,className:"text-text-muted hover:text-text-muted",children:e.jsx(se,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"relative bg-gray-900 rounded-lg overflow-hidden aspect-video flex items-center justify-center",children:[e.jsx("video",{ref:y,autoPlay:!0,playsInline:!0,className:"w-full h-full object-contain"}),e.jsx("div",{className:"absolute inset-0 border-2 border-dashed border-white m-8 pointer-events-none"})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{onClick:me,className:"w-16 h-16 rounded-full bg-surface border-4 border-border flex items-center justify-center hover:bg-surface-highlight transition-colors",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-red-500"})})})]})]})}),q&&p&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-surface rounded-lg w-full max-w-md",children:[e.jsxs("div",{className:"p-4 border-b border-border flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"レシート詳細"}),e.jsx("button",{onClick:()=>Q(!1),className:"text-text-muted hover:text-text-muted",children:e.jsx(se,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-text-muted",children:"日付"}),e.jsx("p",{className:"text-text-main",children:p.date})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-text-muted",children:"店舗名"}),e.jsx("p",{className:"text-text-main",children:p.merchant})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-text-muted",children:"金額"}),e.jsxs("p",{className:"text-text-main",children:["¥",p.amount.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-text-muted",children:"カテゴリ"}),e.jsx("p",{className:"text-text-main",children:p.category})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-text-muted",children:"説明"}),e.jsx("p",{className:"text-text-main",children:p.description})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-text-muted",children:"信頼度"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-16 bg-border rounded-full h-2 mr-2",children:e.jsx("div",{className:`h-2 rounded-full ${p.confidence>=90?"bg-green-500":p.confidence>=70?"bg-yellow-500":"bg-red-500"}`,style:{width:`${p.confidence}%`}})}),e.jsxs("span",{className:"text-xs text-text-muted",children:[p.confidence,"%"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-text-muted",children:"ステータス"}),e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${p.status==="approved"?"bg-green-100 text-green-800":p.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:p.status==="approved"?"承認済み":p.status==="rejected"?"却下":"保留中"})]}),p.taxRate!==void 0&&p.taxRate>0&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-text-muted",children:"税率"}),e.jsxs("p",{className:"text-text-main",children:[p.taxRate,"%"]})]}),p.confidenceScores&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-text-muted",children:"信頼度詳細"}),e.jsxs("div",{className:"text-xs text-text-muted mt-1",children:[e.jsxs("div",{children:["店舗: ",p.confidenceScores.merchant||0,"%"]}),e.jsxs("div",{children:["日付: ",p.confidenceScores.date||0,"%"]}),e.jsxs("div",{children:["金額: ",p.confidenceScores.amount||0,"%"]})]})]}),p.aiAnalysis&&e.jsxs("div",{className:"border-t border-border pt-3",children:[e.jsx("h4",{className:"text-sm font-medium text-text-muted mb-2",children:"AI分析結果"}),p.aiAnalysis.category&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"text-xs font-medium text-text-muted",children:"推定カテゴリ"}),e.jsx("p",{className:"text-sm text-text-main",children:p.aiAnalysis.category})]}),p.aiAnalysis.expenseType&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"text-xs font-medium text-text-muted",children:"支出種別"}),e.jsx("p",{className:"text-sm text-text-main",children:p.aiAnalysis.expenseType})]}),p.aiAnalysis.confidence!==void 0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"text-xs font-medium text-text-muted",children:"AI信頼度"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-16 bg-border rounded-full h-1.5 mr-2",children:e.jsx("div",{className:`h-1.5 rounded-full ${p.aiAnalysis.confidence>=.9?"bg-green-500":p.aiAnalysis.confidence>=.7?"bg-yellow-500":"bg-red-500"}`,style:{width:`${p.aiAnalysis.confidence*100}%`}})}),e.jsxs("span",{className:"text-xs text-text-muted",children:[Math.round(p.aiAnalysis.confidence*100),"%"]})]})]}),p.aiAnalysis.insights&&p.aiAnalysis.insights.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"text-xs font-medium text-text-muted",children:"分析インサイト"}),e.jsx("ul",{className:"list-disc pl-4 space-y-1 mt-1",children:p.aiAnalysis.insights.map((t,i)=>e.jsx("li",{className:"text-xs text-text-muted",children:t},i))})]}),p.aiAnalysis.items&&p.aiAnalysis.items.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-text-muted",children:"商品アイテム"}),e.jsx("div",{className:"mt-1 space-y-1",children:p.aiAnalysis.items.map((t,i)=>e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{className:"text-text-muted",children:t.name}),e.jsxs("span",{className:"text-text-main",children:["¥",t.price.toLocaleString()]})]},i))})]})]})]})}),e.jsx("div",{className:"p-4 border-t border-border flex justify-end space-x-2",children:e.jsx("button",{onClick:()=>Q(!1),className:"px-4 py-2 bg-border text-text-main rounded-md hover:bg-gray-300 transition-colors",children:"閉じる"})})]})}),e.jsx("canvas",{ref:g,className:"hidden"}),e.jsxs("div",{className:"bg-surface rounded-xl shadow-sm border border-border p-6 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"レシートをアップロード"}),e.jsx("div",{className:"mb-6",children:e.jsx(ze,{onScanComplete:oe,onProcessingStateChange:t=>{l(i=>({...i,isProcessing:t.isProcessing,progress:t.progress,currentStep:t.currentStep}))}})}),c.isProcessing&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(ke,{className:"w-5 h-5 text-blue-500 animate-spin mr-2"}),e.jsx("span",{className:"text-blue-700 font-medium",children:"レシートを処理中です..."})]}),c.currentStep&&e.jsxs("div",{className:"text-sm text-primary mb-2",children:["処理ステップ: ",c.currentStep]}),c.progress!==void 0&&e.jsx("div",{className:"w-full bg-border rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full transition-all duration-300",style:{width:`${c.progress}%`}})})]}),c.errorMessage&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-md flex items-center",children:[e.jsx(pe,{className:"w-5 h-5 text-red-500 mr-2"}),e.jsx("span",{className:"text-red-700",children:c.errorMessage}),c.retryCount<3&&e.jsx("button",{onClick:re,className:"ml-4 px-3 py-1 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition-colors text-sm",children:"再試行"})]}),e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[e.jsx("button",{onClick:ae,className:"px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-colors text-sm w-full sm:w-auto",children:"サンプルレシートを追加（テスト用）"}),e.jsx("button",{onClick:Y,className:"px-4 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200 transition-colors text-sm w-full sm:w-auto",children:"OCRテストを実行（サンプル画像）"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("label",{className:"border-2 border-dashed border-border rounded-lg p-6 text-center cursor-pointer hover:border-purple-400 hover:bg-purple-50 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:T,className:"hidden"}),e.jsx(ie,{className:"w-8 h-8 text-text-muted mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-text-muted",children:"ファイルを選択"}),e.jsx("p",{className:"text-xs text-text-muted",children:"PNG, JPG, PDF対応"})]}),e.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-6 text-center cursor-pointer hover:border-purple-400 hover:bg-purple-50 transition-colors",onClick:de,children:[e.jsx(be,{className:"w-8 h-8 text-text-muted mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-text-muted",children:"カメラで撮影"}),e.jsx("p",{className:"text-xs text-text-muted",children:"その場で撮影"})]}),e.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-6 text-center",children:[e.jsx(Re,{className:"w-8 h-8 text-text-muted mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-text-muted",children:"ドラッグ&ドロップ"}),e.jsx("p",{className:"text-xs text-text-muted",children:"ここに画像をドロップ"})]})]})]}),e.jsx("div",{className:"bg-surface rounded-xl shadow-sm border border-border p-4 mb-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(we,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-text-muted w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"店舗名や説明で検索...",className:"w-full pl-10 pr-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary",value:j,onChange:t=>C(t.target.value)})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("select",{className:"px-3 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary w-full sm:w-auto",value:A,onChange:t=>E(t.target.value),children:[e.jsx("option",{value:"all",children:"すべてのステータス"}),e.jsx("option",{value:"pending",children:"保留中"}),e.jsx("option",{value:"approved",children:"承認済み"}),e.jsx("option",{value:"rejected",children:"却下"})]}),e.jsxs("select",{className:"px-3 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary w-full sm:w-auto",value:S,onChange:t=>R(t.target.value),children:[e.jsx("option",{value:"all",children:"すべてのカテゴリ"}),le.map(t=>e.jsx("option",{value:t,children:t},t))]})]})]})}),e.jsxs("div",{className:"bg-surface rounded-xl shadow-sm border border-border",children:[e.jsx("div",{className:"p-6 border-b border-border",children:e.jsx("h2",{className:"text-lg font-semibold",children:"処理済みレシート"})}),e.jsx("div",{className:"md:hidden p-4 space-y-4",children:te.map(t=>e.jsxs("div",{className:"border border-border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-text-main",children:t.merchant}),e.jsx("p",{className:"text-sm text-text-muted",children:t.date})]}),e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${t.status==="approved"?"bg-green-100 text-green-800":t.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:t.status==="approved"?"承認":t.status==="rejected"?"却下":"保留"})]}),e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("p",{className:"text-lg font-semibold text-text-main",children:["¥",t.amount.toLocaleString()]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-16 bg-border rounded-full h-1.5 mr-2",children:e.jsx("div",{className:`h-1.5 rounded-full ${t.confidence>=90?"bg-green-500":t.confidence>=70?"bg-yellow-500":"bg-red-500"}`,style:{width:`${t.confidence}%`}})}),e.jsxs("span",{className:"text-xs text-text-muted",children:[t.confidence,"%"]})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-text-muted",children:t.category}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>ee(t),className:"text-primary hover:text-blue-900",children:e.jsx(fe,{className:"w-4 h-4"})}),t.merchant==="解析エラー"&&e.jsx("button",{onClick:()=>K(t.id),className:"text-orange-600 hover:text-orange-900",title:"再試行",children:e.jsx(ce,{className:"w-4 h-4"})}),t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>J(t.id),className:"text-green-600 hover:text-green-900",children:e.jsx(ge,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>Z(t.id),className:"text-red-600 hover:text-red-900",children:e.jsx(se,{className:"w-4 h-4"})})]})]})]})]},t.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-background",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"日付"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"店舗名"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"金額"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"カテゴリ"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"説明"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"信頼度"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"ステータス"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"操作"})]})}),e.jsx("tbody",{className:"bg-surface divide-y divide-gray-200",children:te.map(t=>e.jsxs("tr",{className:"hover:bg-background",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-text-main",children:o===t.id?e.jsx("input",{type:"date",value:a.date||t.date,onChange:i=>x(f=>({...f,date:i.target.value})),className:"w-full px-2 py-1 border border-border rounded text-sm"}):t.date}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-text-main",children:o===t.id?e.jsx("input",{type:"text",value:a.merchant||t.merchant,onChange:i=>x(f=>({...f,merchant:i.target.value})),className:"w-full px-2 py-1 border border-border rounded text-sm"}):t.merchant}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-text-main",children:o===t.id?e.jsx("input",{type:"number",value:a.amount||t.amount,onChange:i=>x(f=>({...f,amount:Number(i.target.value)})),className:"w-full px-2 py-1 border border-border rounded text-sm"}):`¥${t.amount.toLocaleString()}`}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-text-main",children:o===t.id?e.jsxs("select",{value:a.category||t.category,onChange:i=>x(f=>({...f,category:i.target.value})),className:"w-full px-2 py-1 border border-border rounded text-sm",children:[e.jsx("option",{value:"消耗品費",children:"消耗品費"}),e.jsx("option",{value:"接待交際費",children:"接待交際費"}),e.jsx("option",{value:"旅費交通費",children:"旅費交通費"}),e.jsx("option",{value:"通信費",children:"通信費"}),e.jsx("option",{value:"水道光熱費",children:"水道光熱費"})]}):t.category}),e.jsx("td",{className:"px-6 py-4 text-sm text-text-main max-w-xs truncate",children:o===t.id?e.jsx("input",{type:"text",value:a.description||t.description,onChange:i=>x(f=>({...f,description:i.target.value})),className:"w-full px-2 py-1 border border-border rounded text-sm"}):e.jsxs("div",{children:[e.jsx("div",{children:t.description}),t.taxRate!==void 0&&t.taxRate>0&&e.jsxs("div",{className:"text-xs text-text-muted mt-1",children:["税率: ",t.taxRate,"%"]})]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-16 bg-border rounded-full h-2 mr-2",children:e.jsx("div",{className:`h-2 rounded-full ${t.confidence>=90?"bg-green-500":t.confidence>=70?"bg-yellow-500":"bg-red-500"}`,style:{width:`${t.confidence}%`}})}),e.jsxs("span",{className:"text-xs text-text-muted",children:[t.confidence,"%"]})]}),t.confidenceScores&&e.jsxs("div",{className:"text-xs text-text-muted mt-1",children:[e.jsxs("div",{children:["店舗: ",t.confidenceScores.merchant||0,"%"]}),e.jsxs("div",{children:["日付: ",t.confidenceScores.date||0,"%"]}),e.jsxs("div",{children:["金額: ",t.confidenceScores.amount||0,"%"]})]}),t.aiAnalysis&&t.aiAnalysis.confidence!==void 0&&e.jsx("div",{className:"text-xs text-text-muted mt-1",children:e.jsxs("div",{children:["AI信頼度: ",Math.round(t.aiAnalysis.confidence*100),"%"]})})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${t.status==="approved"?"bg-green-100 text-green-800":t.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:t.status==="approved"?"承認済み":t.status==="rejected"?"却下":"保留中"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsx("div",{className:"flex space-x-2",children:o===t.id?e.jsx("button",{onClick:X,className:"text-green-600 hover:text-green-900",children:e.jsx(je,{className:"w-4 h-4"})}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>ee(t),className:"text-primary hover:text-blue-900",children:e.jsx(fe,{className:"w-4 h-4"})}),t.merchant==="解析エラー"&&e.jsx("button",{onClick:()=>K(t.id),className:"text-orange-600 hover:text-orange-900",title:"再試行",children:e.jsx(ce,{className:"w-4 h-4"})}),t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>J(t.id),className:"text-green-600 hover:text-green-900",children:e.jsx(ge,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>Z(t.id),className:"text-red-600 hover:text-red-900",children:e.jsx(se,{className:"w-4 h-4"})})]})]})})})]},t.id))})]})})]})]})})};export{Qe as default};
