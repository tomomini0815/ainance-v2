import{K as w,r as j,j as e,F as P,X as R,U as H,S as X,P as Q,q as Z,d as Y,G as v}from"./index-Dp8kLXFF.js";import{analyzePLDocumentWithVision as ee}from"./geminiAIService-DQoIspWT.js";import{L}from"./loader-circle-DrUCx8Vg.js";import{A as te}from"./arrow-right-CzxN8cLw.js";import{A as re}from"./arrow-left-CvQkh7k3.js";import{S as se}from"./save-fFq-WGpv.js";const $={async getByYear(r,n,a){const{data:u,error:s}=await w.from("yearly_settlements").select("*").eq("user_id",r).eq("business_type",n).eq("year",a).single();if(s){if(s.code==="PGRST116")return null;throw console.error("getYearlySettlement Error:",s),s}return u},async getAllByBusinessType(r,n){const{data:a,error:u}=await w.from("yearly_settlements").select("*").eq("user_id",r).eq("business_type",n).order("year",{ascending:!1});if(u)throw console.error("getAllYearlySettlements Error:",u),u;return a||[]},async getLatest(r,n){const{data:a,error:u}=await w.from("yearly_settlements").select("*").eq("user_id",r).eq("business_type",n).order("year",{ascending:!1}).limit(1).maybeSingle();if(u)throw console.error("getLatestYearlySettlement Error:",u),u;return a},async save(r){console.log("--- yearlySettlementService.save Start ---",r);const{data:n,error:a}=await w.from("yearly_settlements").upsert({...r,updated_at:new Date().toISOString()},{onConflict:"user_id,business_type,year"}).select().single();if(a)throw console.error("saveYearlySettlement Error Full:",a),console.error("Error Details:",a.details),console.error("Error Hint:",a.hint),console.error("Error Code:",a.code),a;return console.log("saveYearlySettlement Success:",n),n},mapAiResultToSettlement(r,n,a,u={}){console.log("--- AI Result Mapping Start ---"),console.log("Raw AI Result:",JSON.stringify(r,null,2));const s=l=>{if(l==null||l==="")return 0;if(typeof l=="number")return l;const i=l;let c=String(l).replace(/[$,¥円\s,()]/g,""),h=!1;(c.startsWith("△")||c.startsWith("▲")||c.startsWith("-"))&&(h=!0,c=c.substring(1));let b=1;c.includes("千万")?(b=1e7,c=c.replace("千万","")):c.includes("百万")?(b=1e6,c=c.replace("百万","")):c.includes("千")?(b=1e3,c=c.replace("千","")):c.includes("万")&&(b=1e4,c=c.replace("万",""));const S=parseFloat(c),N=isNaN(S)?0:S*b,k=h?-N:N;return isNaN(S)&&console.warn(`parseNum: Could not parse "${i}" as number`),Math.floor(k)},o=l=>{if(!(!r||typeof r!="object"))for(const i of l){if(r[i]!==void 0&&r[i]!==null)return r[i];const c=i.toLowerCase(),h=Object.keys(r).find(b=>b.toLowerCase()===c);if(h)return r[h]}},p=l=>Array.isArray(l)?l.map(i=>({category:String(i.category||i.name||i.項目||i.科目||"その他").trim(),amount:s(i.amount||i.value||i.price||i.金額)})).filter(i=>i.category&&i.amount!==0):[],f={user_id:n,business_type:a,year:s(o(["year","年度","決算年度","target_year"]))||new Date().getFullYear()-1,revenue:s(o(["revenue","sales","total_revenue","売上","売上高","収入金額","営業収益"])),cost_of_sales:s(o(["cost_of_sales","purchases","売上原価","仕入","仕入高","当期商品仕入高"])),operating_expenses:s(o(["operating_expenses","expenses","sga_expenses","販管費","販売費及び一般管理費","経費合計","営業費用"])),non_operating_income:s(o(["non_operating_income","営業外収益"])),non_operating_expenses:s(o(["non_operating_expenses","営業外費用","営業外支出"])),extraordinary_income:s(o(["extraordinary_income","特別利益","特別収益"])),extraordinary_loss:s(o(["extraordinary_loss","特別損失","特別支出"])),income_before_tax:s(o(["income_before_tax","税引前当期純利益","税金等調整前当期純利益"])),net_income:s(o(["net_income","profit","net_profit","当期純利益","利益"])),balance_sheet:{retained_earnings:s(o(["retained_earnings","利益剰余金","繰越利益剰余金","利益積立金"])),capital:s(o(["capital","資本金","資本金等の額"])),cash:s(o(["cash","cash_and_equivalents","現金預金","現預金"])),receivable:s(o(["receivable","accounts_receivable","売掛金"])),inventory:s(o(["inventory","棚卸資産","商品"])),fixed_assets:s(o(["fixed_assets","tangible_fixed_assets","有形固定資産"])),short_term_loans:s(o(["short_term_loans","短期借入金"])),long_term_loans:s(o(["long_term_loans","長期借入金"]))},net_assets_total:s(o(["net_assets_total","純資産の部合計","純資産合計"])),liabilities_and_net_assets_total:s(o(["liabilities_and_net_assets_total","負債及び純資産の部合計","負債純資産合計"])),category_breakdown:p(r.category_breakdown||r.items||r.内訳||r.項目別||[]),status:"draft",metadata:{...u,confidence:r.confidence}};return console.log("Mapped Settlement Data:",f),console.log("--- AI Result Mapping End ---"),f},async delete(r){const{error:n}=await w.from("yearly_settlements").delete().eq("id",r);if(n)throw console.error("deleteYearlySettlement Error:",n),n},async updateStatus(r,n){const{error:a}=await w.from("yearly_settlements").update({status:n,updated_at:new Date().toISOString()}).eq("id",r);if(a)throw console.error("updateStatus Settlement Error:",a),a}},ae={async uploadFinancialDocument(r,n,a,u){try{const s=n.name.split(".").pop(),o=`${a}_${u}_${Date.now()}.${s}`,p=`${r}/${o}`;console.log("Uploading file to:",p);const{data:f,error:l}=await w.storage.from("financial_documents").upload(p,n,{cacheControl:"3600",upsert:!1});if(l)throw console.error("Storage Upload Error:",l),l;return console.log("File uploaded successfully:",f.path),f.path}catch(s){throw console.error("uploadFinancialDocument Error:",s),s}},async getSignedUrl(r){try{if(!r)return null;const{data:n,error:a}=await w.storage.from("financial_documents").createSignedUrl(r,3600);return a?(console.error("Get Signed URL Error:",a),null):n.signedUrl}catch(n){return console.error("getSignedUrl Error:",n),null}}},me=({isOpen:r,onClose:n,userId:a,businessType:u,onImportSuccess:s,initialData:o})=>{const[p,f]=j.useState(1),[l,i]=j.useState(!1),[c,h]=j.useState(!1),[b,S]=j.useState(!1),[N,k]=j.useState(null),[q,D]=j.useState(!1),F=j.useRef(null),[m,y]=j.useState({user_id:a,business_type:u,year:new Date().getFullYear()-1,revenue:0,cost_of_sales:0,operating_expenses:0,non_operating_income:0,non_operating_expenses:0,extraordinary_income:0,extraordinary_loss:0,income_before_tax:0,net_income:0,category_breakdown:[],metadata:{},document_path:void 0,status:"draft"});if(j.useEffect(()=>{if(r){if(o){const{id:t,created_at:d,updated_at:x,...g}=o;y({...g,user_id:a}),D(!0),f(2)}else f(1),k(null),D(!1),y({user_id:a,business_type:u,year:new Date().getFullYear()-1,revenue:0,cost_of_sales:0,operating_expenses:0,non_operating_income:0,non_operating_expenses:0,extraordinary_income:0,extraordinary_loss:0,income_before_tax:0,net_income:0,category_breakdown:[],metadata:{},document_path:void 0,status:"draft"});i(!1),h(!1)}},[r,a,u,o]),!r)return null;const E=async t=>{if(!t)return;const d=t.type.startsWith("image/"),x=t.type==="application/pdf";if(!d&&!x){v.error("画像ファイル（JPG/PNG）またはPDFファイルのみ対応しています");return}k(t),i(!0);try{const g=new FileReader;g.onloadend=async()=>{const C=g.result,A=await ee(C);if(A){const K=$.mapAiResultToSettlement(A,a,u,{fileName:t.name});y(K),f(2),v.success("解析が完了しました。内容を確認してください。")}else v.error("解析に失敗しました。手動で入力してください。"),f(2);i(!1)},g.readAsDataURL(t)}catch(g){console.error("File Analysis Error:",g),v.error("解析中にエラーが発生しました"),i(!1),f(2)}},U=t=>{var x;const d=(x=t.target.files)==null?void 0:x[0];d&&E(d)},M=t=>{t.preventDefault(),t.stopPropagation(),!l&&p===1&&S(!0)},G=t=>{t.preventDefault(),t.stopPropagation(),S(!1)},z=t=>{var d;if(t.preventDefault(),t.stopPropagation(),S(!1),!l&&p===1){const x=(d=t.dataTransfer.files)==null?void 0:d[0];x&&E(x)}},B=async()=>{h(!0);try{if(!m.year||m.year<2e3||m.year>2100){v.error("有効な年度を入力してください"),h(!1);return}let t;if(N)try{v.loading("ファイルをアップロード中...",{id:"upload-toast"}),t=await ae.uploadFinancialDocument(a,N,m.year,"pl"),t&&v.success("ファイルのアップロード完了",{id:"upload-toast"})}catch(x){console.error("File Upload Error:",x),v.error("ファイルのアップロードに失敗しました",{id:"upload-toast"})}const d={...m,document_path:t||m.document_path};await $.save(d),s(),f(3),h(!1)}catch(t){console.error("Save Error:",t),v.error("保存に失敗しました"),h(!1)}},T=()=>{k(null),y({...m,year:new Date().getFullYear()-1}),f(2)},V=()=>{f(1),k(null),y({...m,year:new Date().getFullYear()-1,revenue:0,cost_of_sales:0,operating_expenses:0,non_operating_income:0,non_operating_expenses:0,extraordinary_income:0,extraordinary_loss:0,income_before_tax:0,net_income:0,category_breakdown:[],document_path:void 0,status:"draft"})},_=(t,d)=>{y(x=>({...x,[t]:d}))},W=()=>{y(t=>({...t,category_breakdown:[...t.category_breakdown,{category:"",amount:0,percentage:0}]}))},I=(t,d,x)=>{y(g=>{const C=[...g.category_breakdown];return C[t]={...C[t],[d]:x},{...g,category_breakdown:C}})},O=t=>{y(d=>({...d,category_breakdown:d.category_breakdown.filter((x,g)=>g!==t)}))},J=()=>e.jsx("div",{className:"flex items-center justify-center mb-8",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`
                        flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm
                        ${p>=t?"bg-primary text-white":"bg-surface-highlight text-text-muted"}
                        transition-colors duration-300
                    `,children:p>t?e.jsx(Y,{className:"w-5 h-5"}):t}),e.jsxs("span",{className:`ml-2 text-sm font-medium ${p>=t?"text-text-main":"text-text-muted"}`,children:[t===1&&"アップロード",t===2&&"データ確認",t===3&&"完了"]}),t<3&&e.jsx("div",{className:`w-12 h-0.5 mx-4 ${p>t?"bg-primary":"bg-surface-highlight"}`})]},t))});return e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-surface border border-border rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl",onDragOver:M,onDragLeave:G,onDrop:z,children:[e.jsxs("div",{className:"px-6 py-4 border-b border-border flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-text-main flex items-center",children:[e.jsx(P,{className:"w-5 h-5 mr-2 text-primary"}),"前年度決算データのインポート"]}),e.jsx("button",{onClick:n,className:"text-text-muted hover:text-text-main transition-colors",children:e.jsx(R,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[J(),p===1&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full min-h-[400px]",children:[e.jsxs("div",{onClick:()=>{var t;return(t=F.current)==null?void 0:t.click()},className:`
                                    w-full max-w-2xl text-center p-12 rounded-2xl border-2 border-dashed cursor-pointer transition-all duration-300
                                    ${b?"border-primary bg-primary/10 scale-[1.02]":"border-border hover:border-primary/50 hover:bg-surface-highlight"}
                                `,children:[e.jsx("input",{type:"file",ref:F,className:"hidden",accept:"image/*,.pdf",onChange:U}),e.jsx("div",{className:"bg-primary/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6",children:l?e.jsx(L,{className:"w-10 h-10 text-primary animate-spin"}):e.jsx(H,{className:"w-10 h-10 text-primary"})}),e.jsx("h3",{className:"text-xl font-bold text-text-main mb-2",children:l?"AI解析中...":"決算書をアップロード"}),e.jsx("p",{className:"text-text-muted mb-6",children:l?"画像を解析してデータを抽出しています":"PDFまたは画像ファイル（JPG/PNG）をドラッグ＆ドロップ"}),!l&&e.jsx("button",{className:"btn-primary px-8 py-3 rounded-full shadow-lg hover:shadow-primary/25",children:"ファイルを選択"})]}),e.jsxs("div",{className:"mt-8 flex items-center w-full max-w-2xl",children:[e.jsx("div",{className:"h-px bg-border flex-1"}),e.jsx("span",{className:"px-4 text-text-muted text-sm",children:"または"}),e.jsx("div",{className:"h-px bg-border flex-1"})]}),e.jsxs("button",{onClick:T,className:"mt-8 flex items-center text-text-muted hover:text-primary transition-colors font-medium group",children:["手動で入力する",e.jsx(te,{className:"w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform"})]})]}),p===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-surface-highlight/30 rounded-lg p-4 mb-6 border border-border/50",children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-main mb-2 flex items-center",children:[e.jsx(X,{className:"w-4 h-4 text-primary mr-2"}),"データ確認・修正"]}),e.jsx("p",{className:"text-sm text-text-muted",children:q?"データを修正して保存してください。":N?"AI解析によって抽出されたデータです。誤りがないか確認し、必要に応じて修正してください。":"手動でデータを入力してください。"}),N&&e.jsxs("div",{className:"mt-3 flex items-center text-xs text-text-muted bg-surface/50 p-2 rounded border border-border",children:[e.jsx(P,{className:"w-3 h-3 mr-2"}),"参照ファイル: ",N.name]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"対象年度"}),e.jsx("input",{type:"number",value:m.year,onChange:t=>_("year",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"売上高"}),e.jsx("input",{type:"number",value:m.revenue,onChange:t=>_("revenue",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"売上原価"}),e.jsx("input",{type:"number",value:m.cost_of_sales,onChange:t=>_("cost_of_sales",parseInt(t.target.value)),className:"input-field"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"販売費及び一般管理費"}),e.jsx("input",{type:"number",value:m.operating_expenses,onChange:t=>_("operating_expenses",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"営業外収益"}),e.jsx("input",{type:"number",value:m.non_operating_income,onChange:t=>_("non_operating_income",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"営業外費用"}),e.jsx("input",{type:"number",value:m.non_operating_expenses,onChange:t=>_("non_operating_expenses",parseInt(t.target.value)),className:"input-field"})]})]})]}),e.jsxs("div",{className:"bg-surface-highlight/10 rounded-xl p-5 border border-border mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-text-main flex items-center",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-purple-500 mr-2"}),"主要カテゴリ別内訳（任意）"]}),e.jsxs("button",{onClick:W,className:"text-xs flex items-center text-primary hover:text-primary-light transition-colors",children:[e.jsx(Q,{className:"w-3 h-3 mr-1"}),"カテゴリを追加"]})]}),e.jsxs("div",{className:"space-y-3",children:[m.category_breakdown.map((t,d)=>e.jsxs("div",{className:"flex items-center gap-3 bg-surface-highlight/20 p-3 rounded-lg border border-border/50 group",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",placeholder:"カテゴリ名（例: 商品売上）",value:t.category,onChange:x=>I(d,"category",x.target.value),className:"w-full bg-transparent border-none p-0 text-sm focus:ring-0 text-text-main placeholder-text-muted/50"})}),e.jsxs("div",{className:"w-32 relative",children:[e.jsx("span",{className:"absolute left-2 top-1/2 -translate-y-1/2 text-text-muted text-xs",children:"¥"}),e.jsx("input",{type:"number",placeholder:"金額",value:t.amount,onChange:x=>I(d,"amount",parseInt(x.target.value)),className:"w-full bg-surface-highlight/50 border border-border rounded-md pl-6 pr-2 py-1 text-right text-sm font-mono focus:ring-1 focus:ring-primary"})]}),e.jsx("button",{onClick:()=>O(d),className:"w-6 h-6 flex items-center justify-center text-text-muted hover:text-red-500 hover:bg-red-500/10 rounded opacity-0 group-hover:opacity-100 transition-all",children:e.jsx(Z,{className:"w-4 h-4"})})]},d)),m.category_breakdown.length===0&&e.jsx("p",{className:"text-xs text-text-muted text-center py-4 border-2 border-dashed border-border/50 rounded-lg",children:"内訳を登録すると、統計比較がより詳細になります。"})]})]}),e.jsx("div",{className:"border-t border-border pt-6 mt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"特別利益"}),e.jsx("input",{type:"number",value:m.extraordinary_income,onChange:t=>_("extraordinary_income",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-text-muted mb-1",children:"特別損失"}),e.jsx("input",{type:"number",value:m.extraordinary_loss,onChange:t=>_("extraordinary_loss",parseInt(t.target.value)),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-primary mb-1",children:"当期純利益"}),e.jsx("input",{type:"number",value:m.net_income,onChange:t=>_("net_income",parseInt(t.target.value)),className:"input-field border-primary/50 bg-primary/5 font-bold"})]})]})})]}),p===3&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full py-12",children:[e.jsx("div",{className:"w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mb-6",children:e.jsx(Y,{className:"w-10 h-10 text-green-500"})}),e.jsx("h3",{className:"text-2xl font-bold text-text-main mb-2",children:"インポート完了"}),e.jsxs("p",{className:"text-text-muted mb-8 text-center max-w-md",children:["前年度データの保存が完了しました。",e.jsx("br",{}),"経営分析の比較データとして利用されます。"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:n,className:"btn-ghost",children:"閉じる"}),e.jsx("button",{onClick:V,className:"btn-primary",children:"続けてインポートする"})]})]})]}),p===2&&e.jsxs("div",{className:"px-6 py-4 border-t border-border flex items-center justify-between bg-surface-highlight/30",children:[e.jsxs("button",{onClick:()=>f(1),className:"flex items-center text-text-muted hover:text-text-main transition-colors",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("button",{onClick:B,disabled:c,className:"btn-primary min-w-[140px]",children:c?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"保存して完了"]})})]})]})})};export{me as P,ae as s,$ as y};
