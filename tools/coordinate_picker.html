<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFåº§æ¨™ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚¿ãƒ¼ - è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .pdf-panel {
            flex: 1;
            overflow: auto;
            position: relative;
            padding: 20px;
            background: #16213e;
        }

        .sidebar {
            width: 400px;
            background: #0f3460;
            padding: 15px;
            overflow-y: auto;
        }

        h1 {
            color: #e94560;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        h2 {
            color: #0abde3;
            margin: 10px 0 6px;
            font-size: 0.9em;
            border-bottom: 1px solid #2a4a6a;
            padding-bottom: 4px;
        }

        .canvas-wrapper {
            position: relative;
            display: inline-block;
        }

        #pdfCanvas {
            border: 2px solid #e94560;
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.3);
        }

        .draggable-point {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: white;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            transition: transform 0.1s, box-shadow 0.1s;
            z-index: 100;
        }

        .draggable-point:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .draggable-point.dragging {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            z-index: 1000;
        }

        .draggable-point.digit {
            background: #e94560;
        }

        .draggable-point.text {
            background: #10ac84;
        }

        .draggable-point.selected {
            border: 3px solid #f1c40f;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
        }

        .draggable-point.required::after {
            content: 'â˜…';
            position: absolute;
            top: -6px;
            right: -6px;
            font-size: 8px;
            color: #ffcc00;
        }

        .draggable-point.hidden-field {
            display: none;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            color: #aaa;
            font-size: 0.8em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #1a1a2e;
            color: #fff;
            font-size: 0.9em;
        }

        button {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 3px 0;
            width: 100%;
            transition: all 0.2s;
            font-size: 0.85em;
        }

        button:hover {
            transform: scale(1.02);
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-success {
            background: #10ac84;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: #1a1a2e;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .field-list {
            max-height: 180px;
            overflow-y: auto;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 6px;
        }

        .field-item {
            display: flex;
            align-items: center;
            padding: 4px;
            margin: 2px 0;
            border-radius: 4px;
            background: #2a3a5a;
            font-size: 0.7em;
            cursor: pointer;
        }

        .field-item:hover {
            background: #3a4a6a;
        }

        .field-item.selected {
            background: #f39c1233;
            border: 1px solid #f39c12;
        }

        .field-item .num {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            font-size: 7px;
            font-weight: bold;
            color: white;
        }

        .field-item .num.digit {
            background: #e94560;
        }

        .field-item .num.text {
            background: #10ac84;
        }

        .field-item.hidden-item {
            opacity: 0.5;
            background: #1a2a3a;
        }

        #output {
            background: #1a1a2e;
            padding: 6px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.55em;
            white-space: pre-wrap;
            max-height: 120px;
            overflow-y: auto;
        }

        .instructions {
            background: rgba(10, 189, 227, 0.1);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.75em;
            line-height: 1.3;
        }

        .selected-info {
            background: #f39c1233;
            padding: 6px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        .tax-type-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .tax-type-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-size: 0.8em;
            background: #2a3a5a;
            border: 2px solid transparent;
            cursor: pointer;
            border-radius: 6px;
        }

        .tax-type-tab.active {
            border-color: #e94560;
            background: #e9456033;
        }

        .doc-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .doc-btn {
            padding: 6px 4px;
            font-size: 0.7em;
            background: #2a3a5a;
            border: 2px solid transparent;
            border-radius: 4px;
        }

        .doc-btn.active {
            border-color: #e94560;
            background: #e9456033;
        }

        .legend {
            display: flex;
            gap: 10px;
            margin-bottom: 6px;
            font-size: 0.7em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .legend-item .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .add-field {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 5px;
            margin-bottom: 6px;
        }

        .add-field input {
            padding: 6px;
            font-size: 0.8em;
        }

        .add-field select {
            width: 65px;
            padding: 6px;
        }

        .page-nav {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            background: #2a3a5a;
            padding: 8px;
            border-radius: 8px;
        }

        .page-nav button {
            width: auto;
            padding: 6px 12px;
            margin: 0;
        }

        .page-nav span {
            font-size: 0.85em;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="pdf-panel">
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="pdfCanvas"></canvas>
            </div>
        </div>

        <div class="sidebar">
            <h1>ğŸ“ åº§æ¨™ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>

            <div class="instructions">
                1. ç¨ç¨®é¡ã‚’é¸æŠ â†’ 2. æ›¸é¡ â†’ 3. PDFèª­è¾¼ â†’ 4. ãƒ‰ãƒ©ãƒƒã‚°èª¿æ•´ â†’ 5. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </div>

            <h2>ğŸ¢ ç¨ç¨®é¡</h2>
            <div class="tax-type-tabs">
                <div class="tax-type-tab active" data-type="corporate">æ³•äººç¨</div>
                <div class="tax-type-tab" data-type="personal">æ‰€å¾—ç¨</div>
            </div>

            <h2>ğŸ“„ æ›¸é¡é¸æŠ</h2>
            <div class="doc-selector" id="docSelector"></div>

            <div class="input-group">
                <label>PDFãƒ•ã‚¡ã‚¤ãƒ«:</label>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>

            <!-- ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="page-nav" id="pageNav" style="display:none;">
                <button class="btn-info" id="prevPage">â—€</button>
                <span>ãƒšãƒ¼ã‚¸ <span id="currentPage">1</span> / <span id="totalPages">1</span></span>
                <button class="btn-info" id="nextPage">â–¶</button>
            </div>

            <button class="btn-warning" id="showPoints">ğŸ“ ç‚¹ã‚’è¡¨ç¤º</button>

            <div class="selected-info" id="selectedInfo" style="display:none;">
                <strong>é¸æŠ:</strong> <span id="selectedName">-</span> (<span id="selectedCoords">-</span>)
            </div>

            <h2>â• ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ </h2>
            <div class="add-field">
                <input type="text" id="newFieldName" placeholder="ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å">
                <select id="newFieldType">
                    <option value="digit">æ•°å­—</option>
                    <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
                </select>
            </div>
            <button class="btn-info" id="addFieldBtn">ï¼‹ è¿½åŠ </button>

            <h2>ğŸ“‹ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (ãƒšãƒ¼ã‚¸ <span id="currentPageIndicator">1</span>/<span id="totalPageIndicator">1</span>) - <span
                    id="fieldCount">0</span>ä»¶</h2>
            <p id="pageGuidance" style="font-size: 0.8em; color: #888; margin: 4px 0 8px 0;">
                â€» PDFã‚’èª­ã¿è¾¼ã¿å¾Œã€ãƒšãƒ¼ã‚¸ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã§ãã¾ã™
            </p>
            <div class="legend">
                <div class="legend-item">
                    <div class="dot" style="background:#e94560"></div> æ•°å­—
                </div>
                <div class="legend-item">
                    <div class="dot" style="background:#10ac84"></div> ãƒ†ã‚­ã‚¹ãƒˆ
                </div>
            </div>
            <div class="field-list" id="fieldList"></div>

            <h2>ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                <button class="btn-success" id="updateCoordsBtn">ğŸ’¾ åº§æ¨™ã‚’æ›´æ–° (Source)</button>
                <button class="btn-info" id="importJsonBtn">ğŸ“¤ JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            </div>
            <input type="file" id="importJsonFile" accept=".json" style="display: none;">
            <button class="btn-secondary" id="exportCoords" style="font-size: 0.8em; padding: 6px 10px;">ğŸ“‹
                ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼</button>
            <div id="output">æ›¸é¡ã‚’é¸æŠã—ã¦PDFã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let scale = 1.5;
        let pdfWidth = 0;
        let pdfHeight = 0;
        let currentTaxType = 'corporate';
        let currentDoc = 'beppyo1';
        let currentPageNum = 1;
        let totalPages = 1;
        let isDragging = false;

        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('canvasWrapper');

        // ===== CORPORATE TAX FORMS (æ³•äººç¨) =====
        const corporateForms = {
            beppyo1: {
                name: 'åˆ¥è¡¨ä¸€',
                pages: 1,
                fields: {
                    1: [
                        // Left Column
                        { id: 'æ‰€å¾—é‡‘é¡_row1', type: 'digit', x: 292.7, y: 568.6, label: '1' },
                        { id: 'æ³•äººç¨é¡_row2', type: 'digit', x: 293.3, y: 549.9, label: '2' },
                        { id: 'ç‰¹åˆ¥æ§é™¤é¡_row3', type: 'digit', x: 293.3, y: 533.3, label: '3' },
                        { id: 'ç¨é¡æ§é™¤_row4', type: 'digit', x: 293.3, y: 514.6, label: '4' },
                        { id: 'åˆ©å­ç¨_row5', type: 'digit', x: 292, y: 496.6, label: '5' },
                        { id: 'æ§é™¤ç¨é¡_row6', type: 'digit', x: 292.7, y: 479.3, label: '6' },
                        { id: 'ç•™ä¿é‡‘é¡_row7', type: 'digit', x: 292.7, y: 460.6, label: '7' },
                        { id: 'åŒä¸Šç¨é¡_row8', type: 'digit', x: 292, y: 441.9, label: '8' },
                        { id: 'æ³•äººç¨é¡è¨ˆ1_row9', type: 'digit', x: 294.7, y: 407.3, label: '9' },
                        { id: 'row10', type: 'digit', x: 294, y: 386.6, label: '10' },
                        { id: 'row11', type: 'digit', x: 293.3, y: 368.6, label: '11' },
                        { id: 'row12', type: 'digit', x: 292.7, y: 351.3, label: '12' },
                        { id: 'å·®å¼•æ³•äººç¨é¡_row13', type: 'digit', x: 292.7, y: 333.9, label: '13' },
                        { id: 'ä¸­é–“ç”³å‘Š_row14', type: 'digit', x: 294.7, y: 316.8, label: '14' },
                        { id: 'row15', type: 'digit', x: 293.3, y: 295.3, label: '15' },
                        { id: 'æ³•äººç¨é¡è¨ˆ_row28', type: 'digit', x: 293.3, y: 276.1, label: '28' },

                        // Right Column
                        { id: 'row16', type: 'digit', x: 560, y: 565.3, label: '16' },
                        { id: 'row17', type: 'digit', x: 560, y: 547.3, label: '17' },
                        { id: 'æ‰€å¾—åˆè¨ˆ_row18', type: 'digit', x: 560, y: 527.3, label: '18' },
                        { id: 'row19', type: 'digit', x: 559.3, y: 509.9, label: '19' },
                        { id: 'row20', type: 'digit', x: 560, y: 492.1, label: '20' },
                        { id: 'row21', type: 'digit', x: 559.3, y: 470.8, label: '21' },
                        { id: 'row22', type: 'digit', x: 560, y: 447.5, label: '22' },
                        { id: 'row23', type: 'digit', x: 560, y: 421.5, label: '23' },
                        { id: 'row24', type: 'digit', x: 560, y: 394.1, label: '24' },
                        { id: 'row25', type: 'digit', x: 558.7, y: 340.1, label: '25' },
                        { id: 'row26', type: 'digit', x: 558.7, y: 316.8, label: '26' },
                        { id: 'row27', type: 'digit', x: 560, y: 295.5, label: '27' },

                        // Text Fields
                        { id: 'ç¨å‹™ç½²å', type: 'text', x: 114, y: 781.5, label: 'ç½²' },
                        { id: 'æ³•äººå', type: 'text', x: 85.3, y: 716.1, label: 'å' },
                        { id: 'æ³•äººç•ªå·', type: 'text', x: 83.3, y: 695.3, label: 'ç•ª' },
                        { id: 'ç´ç¨åœ°', type: 'text', x: 84, y: 752.1, label: 'ä½' },
                        { id: 'é›»è©±ç•ªå·', type: 'text', x: 170, y: 745.5, label: 'é›»' },
                        { id: 'ä»£è¡¨è€…æ°å', type: 'text', x: 85.3, y: 665.9, label: 'ä»£' },
                        { id: 'äº‹æ¥­å¹´åº¦_å¹´_è‡ª', type: 'text', x: 420.7, y: 772.6, label: 'è‡ªå¹´' },
                        { id: 'äº‹æ¥­å¹´åº¦_æœˆ_è‡ª', type: 'text', x: 461.3, y: 772.6, label: 'è‡ªæœˆ' },
                        { id: 'äº‹æ¥­å¹´åº¦_æ—¥_è‡ª', type: 'text', x: 489.3, y: 772.6, label: 'è‡ªæ—¥' },
                        { id: 'äº‹æ¥­å¹´åº¦_å¹´_è‡³', type: 'text', x: 508.7, y: 772.6, label: 'è‡³å¹´' },
                        { id: 'äº‹æ¥­å¹´åº¦_æœˆ_è‡³', type: 'text', x: 541.3, y: 772.6, label: 'è‡³æœˆ' },
                        { id: 'äº‹æ¥­å¹´åº¦_æ—¥_è‡³', type: 'text', x: 572.7, y: 772.6, label: 'è‡³æ—¥' },
                    ]
                }
            },
            beppyo4: {
                name: 'åˆ¥è¡¨å››',
                pages: 1,
                fields: {
                    1: [
                        { id: 'å½“æœŸåˆ©ç›Š_row1', type: 'digit', x: 318.7, y: 723.3, label: '1' },
                        { id: 'æé‡‘ç®—å…¥æ³•äººç¨_row2', type: 'digit', x: 321.3, y: 539.3, label: '2' },
                        { id: 'æé‡‘ç®—å…¥ä½æ°‘ç¨_row3', type: 'digit', x: 321.3, y: 520, label: '3' },
                        { id: 'äº¤éš›è²»ä¸ç®—å…¥é¡_row4', type: 'digit', x: 321.3, y: 500, label: '4' },
                        { id: 'æ¸›ä¾¡å„Ÿå´è¶…éé¡_row5', type: 'digit', x: 321.3, y: 480, label: '5' },
                        { id: 'æ³•äººç¨ç­‰é‚„ä»˜é‡‘_row33', type: 'digit', x: 318.7, y: 348.6, label: '33' },
                        { id: 'æ”¯å‡ºäº‹æ¥­ç¨_row34', type: 'digit', x: 318.7, y: 330, label: '34' },
                        { id: 'æ‰€å¾—é‡‘é¡_row52', type: 'digit', x: 321.3, y: 68.6, label: '52' },
                        { id: 'æ³•äººå', type: 'text', x: 434.7, y: 788.6, label: 'æ³•' },
                    ]
                }
            },
            beppyo5: {
                name: 'åˆ¥è¡¨äº”(ä¸€)',
                pages: 1,
                fields: {
                    1: [
                        // åˆ©ç›Šæº–å‚™é‡‘ (Row 1)
                        { id: 'åˆ©ç›Šæº–å‚™é‡‘_1', type: 'digit', x: 400, y: 650, label: '1â‘ ' },
                        { id: 'åˆ©ç›Šæº–å‚™é‡‘_2', type: 'digit', x: 430, y: 650, label: '1â‘¡' },
                        { id: 'åˆ©ç›Šæº–å‚™é‡‘_3', type: 'digit', x: 460, y: 650, label: '1â‘¢' },
                        { id: 'åˆ©ç›Šæº–å‚™é‡‘_4', type: 'digit', x: 490, y: 650, label: '1â‘£' },
                        // ç¹°è¶Šæç›Šé‡‘ (Row 31)
                        { id: 'ç¹°è¶Šæç›Šé‡‘_1', type: 'digit', x: 400, y: 630, label: '31â‘ ' },
                        { id: 'ç¹°è¶Šæç›Šé‡‘_2', type: 'digit', x: 430, y: 630, label: '31â‘¡' },
                        { id: 'ç¹°è¶Šæç›Šé‡‘_3', type: 'digit', x: 460, y: 630, label: '31â‘¢' },
                        { id: 'ç¹°è¶Šæç›Šé‡‘_4', type: 'digit', x: 490, y: 630, label: '31â‘£' },
                        // ç´ç¨å……å½“é‡‘ (Row 32)
                        { id: 'ç´ç¨å……å½“é‡‘_1', type: 'digit', x: 400, y: 400, label: '32â‘ ' },
                        { id: 'ç´ç¨å……å½“é‡‘_2', type: 'digit', x: 430, y: 400, label: '32â‘¡' },
                        { id: 'ç´ç¨å……å½“é‡‘_3', type: 'digit', x: 460, y: 400, label: '32â‘¢' },
                        { id: 'ç´ç¨å……å½“é‡‘_4', type: 'digit', x: 490, y: 400, label: '32â‘£' },
                        // è³‡æœ¬é‡‘ (Row 33)
                        { id: 'è³‡æœ¬é‡‘_1', type: 'digit', x: 400, y: 200, label: '33â‘ ' },
                        { id: 'è³‡æœ¬é‡‘_4', type: 'digit', x: 490, y: 200, label: '33â‘£' },
                        { id: 'æ³•äººå', type: 'text', x: 100, y: 780, label: 'æ³•' },
                    ]
                }
            },
            beppyo5_2: {
                name: 'åˆ¥è¡¨äº”(äºŒ)',
                pages: 1,
                fields: {
                    1: [
                        // æ³•äººç¨ (Row 1)
                        { id: 'æ³•äººç¨_1', type: 'digit', x: 400, y: 650, label: '1â‘ ' },
                        { id: 'æ³•äººç¨_2', type: 'digit', x: 430, y: 650, label: '1â‘¡' },
                        { id: 'æ³•äººç¨_3', type: 'digit', x: 460, y: 650, label: '1â‘¢' },
                        { id: 'æ³•äººç¨_4', type: 'digit', x: 490, y: 650, label: '1â‘£' },
                        // ä½æ°‘ç¨ (éƒ½é“åºœçœŒ) (Row 2)
                        { id: 'ä½æ°‘ç¨_1', type: 'digit', x: 400, y: 600, label: '2â‘ ' },
                        { id: 'ä½æ°‘ç¨_2', type: 'digit', x: 430, y: 600, label: '2â‘¡' },
                        { id: 'ä½æ°‘ç¨_3', type: 'digit', x: 460, y: 600, label: '2â‘¢' },
                        { id: 'ä½æ°‘ç¨_4', type: 'digit', x: 490, y: 600, label: '2â‘£' },
                        // äº‹æ¥­ç¨ (Row 4)
                        { id: 'äº‹æ¥­ç¨_1', type: 'digit', x: 400, y: 550, label: '4â‘ ' },
                        { id: 'äº‹æ¥­ç¨_2', type: 'digit', x: 430, y: 550, label: '4â‘¡' },
                        { id: 'äº‹æ¥­ç¨_3', type: 'digit', x: 460, y: 550, label: '4â‘¢' },
                        { id: 'äº‹æ¥­ç¨_4', type: 'digit', x: 490, y: 550, label: '4â‘£' },
                        // ç´ç¨å……å½“é‡‘ (Rows 33, 34)
                        { id: 'ç´ç¨å……å½“é‡‘_ç¹°å…¥', type: 'digit', x: 400, y: 300, label: '33' },
                        { id: 'ç´ç¨å……å½“é‡‘_å–å´©', type: 'digit', x: 430, y: 300, label: '34' },
                        { id: 'æ³•äººå', type: 'text', x: 100, y: 780, label: 'æ³•' },
                    ]
                }
            },
            beppyo15: {
                name: 'åˆ¥è¡¨åäº”',
                pages: 1,
                fields: {
                    1: [
                        { id: 'æ”¯å‡ºäº¤éš›è²»ç­‰ã®é¡_row1', type: 'digit', x: 450, y: 650, label: '1' },
                        { id: 'æ¥å¾…é£²é£Ÿè²»ã®é¡_row2', type: 'digit', x: 450, y: 600, label: '2' },
                        { id: 'æŒ‡å®šé™åº¦é¡_row17', type: 'digit', x: 450, y: 300, label: '17' },
                        { id: 'æé‡‘ä¸ç®—å…¥é¡_row18', type: 'digit', x: 450, y: 250, label: '18' },
                        { id: 'æ³•äººå', type: 'text', x: 100, y: 780, label: 'æ³•' },
                    ]
                }
            },
            beppyo16: {
                name: 'åˆ¥è¡¨åå…­(ä¸€)',
                pages: 1,
                fields: {
                    1: [
                        // Row 1
                        { id: 'è³‡ç”£å_row1', type: 'text', x: 100, y: 700, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row1', type: 'digit', x: 200, y: 700, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row1', type: 'digit', x: 280, y: 700, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row1', type: 'digit', x: 360, y: 700, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row1', type: 'digit', x: 440, y: 700, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row1', type: 'digit', x: 520, y: 700, label: 'è¶…é(41)' },
                        // Row 2
                        { id: 'è³‡ç”£å_row2', type: 'text', x: 100, y: 676, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row2', type: 'digit', x: 200, y: 676, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row2', type: 'digit', x: 280, y: 676, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row2', type: 'digit', x: 360, y: 676, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row2', type: 'digit', x: 440, y: 676, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row2', type: 'digit', x: 520, y: 676, label: 'è¶…é(41)' },
                        // Row 3
                        { id: 'è³‡ç”£å_row3', type: 'text', x: 100, y: 652, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row3', type: 'digit', x: 200, y: 652, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row3', type: 'digit', x: 280, y: 652, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row3', type: 'digit', x: 360, y: 652, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row3', type: 'digit', x: 440, y: 652, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row3', type: 'digit', x: 520, y: 652, label: 'è¶…é(41)' },
                        // Row 4
                        { id: 'è³‡ç”£å_row4', type: 'text', x: 100, y: 628, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row4', type: 'digit', x: 200, y: 628, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row4', type: 'digit', x: 280, y: 628, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row4', type: 'digit', x: 360, y: 628, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row4', type: 'digit', x: 440, y: 628, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row4', type: 'digit', x: 520, y: 628, label: 'è¶…é(41)' },
                        // Row 5
                        { id: 'è³‡ç”£å_row5', type: 'text', x: 100, y: 604, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row5', type: 'digit', x: 200, y: 604, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row5', type: 'digit', x: 280, y: 604, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row5', type: 'digit', x: 360, y: 604, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row5', type: 'digit', x: 440, y: 604, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row5', type: 'digit', x: 520, y: 604, label: 'è¶…é(41)' },
                        // Row 6
                        { id: 'è³‡ç”£å_row6', type: 'text', x: 100, y: 580, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row6', type: 'digit', x: 200, y: 580, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row6', type: 'digit', x: 280, y: 580, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row6', type: 'digit', x: 360, y: 580, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row6', type: 'digit', x: 440, y: 580, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row6', type: 'digit', x: 520, y: 580, label: 'è¶…é(41)' },

                        { id: 'æ³•äººå', type: 'text', x: 100, y: 780, label: 'æ³•äººå' },
                    ]
                }
            },
            beppyo16_2: {
                name: 'åˆ¥è¡¨åå…­(äºŒ)',
                pages: 1,
                fields: {
                    1: [
                        // Row 1
                        { id: 'è³‡ç”£å_row1', type: 'text', x: 100, y: 700, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row1', type: 'digit', x: 200, y: 700, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row1', type: 'digit', x: 280, y: 700, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row1', type: 'digit', x: 360, y: 700, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row1', type: 'digit', x: 440, y: 700, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row1', type: 'digit', x: 520, y: 700, label: 'è¶…é(41)' },
                        // Row 2
                        { id: 'è³‡ç”£å_row2', type: 'text', x: 100, y: 676, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row2', type: 'digit', x: 200, y: 676, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row2', type: 'digit', x: 280, y: 676, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row2', type: 'digit', x: 360, y: 676, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row2', type: 'digit', x: 440, y: 676, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row2', type: 'digit', x: 520, y: 676, label: 'è¶…é(41)' },
                        // Row 3
                        { id: 'è³‡ç”£å_row3', type: 'text', x: 100, y: 652, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row3', type: 'digit', x: 200, y: 652, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row3', type: 'digit', x: 280, y: 652, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row3', type: 'digit', x: 360, y: 652, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row3', type: 'digit', x: 440, y: 652, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row3', type: 'digit', x: 520, y: 652, label: 'è¶…é(41)' },
                        // Row 4
                        { id: 'è³‡ç”£å_row4', type: 'text', x: 100, y: 628, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row4', type: 'digit', x: 200, y: 628, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row4', type: 'digit', x: 280, y: 628, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row4', type: 'digit', x: 360, y: 628, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row4', type: 'digit', x: 440, y: 628, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row4', type: 'digit', x: 520, y: 628, label: 'è¶…é(41)' },
                        // Row 5
                        { id: 'è³‡ç”£å_row5', type: 'text', x: 100, y: 604, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row5', type: 'digit', x: 200, y: 604, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row5', type: 'digit', x: 280, y: 604, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row5', type: 'digit', x: 360, y: 604, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row5', type: 'digit', x: 440, y: 604, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row5', type: 'digit', x: 520, y: 604, label: 'è¶…é(41)' },
                        // Row 6
                        { id: 'è³‡ç”£å_row6', type: 'text', x: 100, y: 580, label: 'å' },
                        { id: 'å–å¾—ä¾¡é¡_row6', type: 'digit', x: 200, y: 580, label: 'å–å¾—(1)' },
                        { id: 'æœŸæœ«å¸³ç°¿ä¾¡é¡_row6', type: 'digit', x: 280, y: 580, label: 'å¸³ç°¿(10)' },
                        { id: 'å„Ÿå´é™åº¦é¡_row6', type: 'digit', x: 360, y: 580, label: 'é™åº¦(29)' },
                        { id: 'å½“æœŸå„Ÿå´é¡_row6', type: 'digit', x: 440, y: 580, label: 'å„Ÿå´(35)' },
                        { id: 'å„Ÿå´è¶…éé¡_row6', type: 'digit', x: 520, y: 580, label: 'è¶…é(41)' },

                        { id: 'æ³•äººå', type: 'text', x: 100, y: 780, label: 'æ³•äººå' },
                    ]
                }
            },

        };

        // ===== PERSONAL TAX FORMS (æ‰€å¾—ç¨ãƒ»å€‹äºº) =====
        const personalForms = {
            kakutei_1_2: {
                name: 'ç¢ºå®šç”³å‘Šæ›¸ ç¬¬ä¸€è¡¨ãƒ»ç¬¬äºŒè¡¨',
                pages: 4,
                fields: {
                    // ===== ç¬¬ä¸€è¡¨ (ãƒšãƒ¼ã‚¸1) =====
                    1: [
                        // --- åå…¥é‡‘é¡ç­‰ (å·¦å´) ---
                        { id: 'åå…¥_ã‚¢_å–¶æ¥­ç­‰', type: 'digit', x: 286.7, y: 672.6, label: 'ã‚¢', required: true },
                        { id: 'åå…¥_ã‚¤_è¾²æ¥­', type: 'digit', x: 286.7, y: 659, label: 'ã‚¤' },
                        { id: 'åå…¥_ã‚¦_ä¸å‹•ç”£', type: 'digit', x: 286.7, y: 645, label: 'ã‚¦' },
                        { id: 'åå…¥_ã‚¨_çµ¦ä¸', type: 'digit', x: 286.7, y: 631, label: 'ã‚¨' },
                        { id: 'åå…¥_ã‚ª_å…¬çš„å¹´é‡‘ç­‰', type: 'digit', x: 286.7, y: 617, label: 'ã‚ª' },
                        { id: 'åå…¥_ã‚«_æ¥­å‹™', type: 'digit', x: 286.7, y: 603, label: 'ã‚«' },
                        { id: 'åå…¥_ã‚­_ãã®ä»–', type: 'digit', x: 286.7, y: 589, label: 'ã‚­' },
                        { id: 'åå…¥_ã‚¯_çŸ­æœŸ', type: 'digit', x: 286.7, y: 575, label: 'ã‚¯' },
                        { id: 'åå…¥_ã‚±_é•·æœŸ', type: 'digit', x: 286.7, y: 561, label: 'ã‚±' },
                        { id: 'åå…¥_ã‚³_ä¸€æ™‚', type: 'digit', x: 286.7, y: 547, label: 'ã‚³' },
                        // --- æ‰€å¾—é‡‘é¡ç­‰ (å·¦å´) ---
                        { id: 'æ‰€å¾—_1_å–¶æ¥­ç­‰', type: 'digit', x: 286.7, y: 520, label: 'â‘ ', required: true },
                        { id: 'æ‰€å¾—_2_è¾²æ¥­', type: 'digit', x: 286.7, y: 506, label: 'â‘¡' },
                        { id: 'æ‰€å¾—_3_ä¸å‹•ç”£', type: 'digit', x: 286.7, y: 492, label: 'â‘¢' },
                        { id: 'æ‰€å¾—_4_åˆ©å­', type: 'digit', x: 286.7, y: 478, label: 'â‘£' },
                        { id: 'æ‰€å¾—_5_é…å½“', type: 'digit', x: 286.7, y: 464, label: 'â‘¤' },
                        { id: 'æ‰€å¾—_6_çµ¦ä¸', type: 'digit', x: 286.7, y: 450, label: 'â‘¥' },
                        { id: 'æ‰€å¾—_7_å…¬çš„å¹´é‡‘ç­‰', type: 'digit', x: 286.7, y: 436, label: 'â‘¦' },
                        { id: 'æ‰€å¾—_8_æ¥­å‹™', type: 'digit', x: 286.7, y: 422, label: 'â‘§' },
                        { id: 'æ‰€å¾—_9_ãã®ä»–', type: 'digit', x: 286.7, y: 408, label: 'â‘¨' },
                        { id: 'æ‰€å¾—_10_å°è¨ˆ', type: 'digit', x: 286.7, y: 394, label: 'â‘©' },
                        { id: 'æ‰€å¾—_11_ç·åˆèª²ç¨', type: 'digit', x: 286.7, y: 380, label: 'â‘ª' },
                        { id: 'æ‰€å¾—_12_åˆè¨ˆ', type: 'digit', x: 286.7, y: 366, label: 'â‘«', required: true },
                        // --- æ‰€å¾—æ§é™¤ (å·¦å´) ---
                        { id: 'æ§é™¤_13_ç¤¾ä¼šä¿é™ºæ–™', type: 'digit', x: 286.7, y: 330, label: 'â‘¬' },
                        { id: 'æ§é™¤_14_å°è¦æ¨¡ä¼æ¥­å…±æ¸ˆ', type: 'digit', x: 286.7, y: 316, label: 'â‘­' },
                        { id: 'æ§é™¤_15_ç”Ÿå‘½ä¿é™ºæ–™', type: 'digit', x: 286.7, y: 302, label: 'â‘®' },
                        { id: 'æ§é™¤_16_åœ°éœ‡ä¿é™ºæ–™', type: 'digit', x: 286.7, y: 288, label: 'â‘¯' },
                        { id: 'æ§é™¤_17_å¯¡å©¦ã²ã¨ã‚Šè¦ª', type: 'digit', x: 286.7, y: 274, label: 'â‘°' },
                        { id: 'æ§é™¤_18_å‹¤åŠ´å­¦ç”Ÿéšœå®³è€…', type: 'digit', x: 286.7, y: 260, label: 'â‘±' },
                        { id: 'æ§é™¤_19_é…å¶è€…', type: 'digit', x: 286.7, y: 246, label: 'â‘²' },
                        { id: 'æ§é™¤_20_é…å¶è€…ç‰¹åˆ¥', type: 'digit', x: 286.7, y: 232, label: 'â‘³' },
                        { id: 'æ§é™¤_21_æ‰¶é¤Š', type: 'digit', x: 286.7, y: 218, label: 'ã‰‘' },
                        { id: 'æ§é™¤_22_åŸºç¤æ§é™¤', type: 'digit', x: 286.7, y: 204, label: 'ã‰’', required: true },
                        { id: 'æ§é™¤_23_é›‘æ', type: 'digit', x: 286.7, y: 190, label: 'ã‰“' },
                        { id: 'æ§é™¤_24_åŒ»ç™‚è²»', type: 'digit', x: 286.7, y: 176, label: 'ã‰”' },
                        { id: 'æ§é™¤_25_å¯„é™„é‡‘', type: 'digit', x: 286.7, y: 162, label: 'ã‰•' },
                        { id: 'æ§é™¤_26_åˆè¨ˆ', type: 'digit', x: 286.7, y: 148, label: 'ã‰–', required: true },
                        // --- ç¨é‡‘ã®è¨ˆç®— (å³å´) ---
                        { id: 'ç¨é¡_27_èª²ç¨æ‰€å¾—', type: 'digit', x: 552, y: 672.6, label: 'ã‰—', required: true },
                        { id: 'ç¨é¡_28_ä¸Šã®ç¨é¡', type: 'digit', x: 552, y: 658, label: 'ã‰˜', required: true },
                        { id: 'ç¨é¡_29_é…å½“æ§é™¤', type: 'digit', x: 552, y: 644, label: 'ã‰™' },
                        { id: 'ç¨é¡_38_ä½å®…æ§é™¤', type: 'digit', x: 552, y: 606, label: 'ãŠ³' },
                        { id: 'ç¨é¡_43_ç½å®³æ¸›å…é¡', type: 'digit', x: 552, y: 568, label: 'ãŠ¸' },
                        { id: 'ç¨é¡_44_å†å·®å¼•æ‰€å¾—ç¨', type: 'digit', x: 552, y: 554, label: 'ãŠ¹' },
                        { id: 'ç¨é¡_45_å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨', type: 'digit', x: 552, y: 540, label: 'ãŠº' },
                        { id: 'ç¨é¡_46_æ‰€å¾—ç¨å¾©èˆˆç¨åˆè¨ˆ', type: 'digit', x: 552, y: 526, label: 'ãŠ»' },
                        { id: 'ç¨é¡_47_å¤–å›½ç¨é¡æ§é™¤ç­‰', type: 'digit', x: 552, y: 512, label: 'ãŠ¼' },
                        { id: 'ç¨é¡_48_æºæ³‰å¾´åç¨é¡', type: 'digit', x: 552, y: 498, label: 'ãŠ½' },
                        { id: 'ç¨é¡_49_ç”³å‘Šç´ç¨é¡', type: 'digit', x: 552, y: 484, label: 'ãŠ¾' },
                        { id: 'ç¨é¡_50_äºˆå®šç´ç¨é¡', type: 'digit', x: 552, y: 470, label: 'ãŠ¿' },
                        { id: 'ç¨é¡_51_ç´ã‚ã‚‹ç¨é‡‘', type: 'digit', x: 552, y: 456, label: '51', required: true },
                        { id: 'ç¨é¡_52_é‚„ä»˜ã•ã‚Œã‚‹ç¨é‡‘', type: 'digit', x: 552, y: 442, label: '52' },
                        // --- ãã®ä»– (å³å´) ---
                        { id: 'ä»–_56_å…¬çš„å¹´é‡‘ä»¥å¤–', type: 'digit', x: 552, y: 380, label: '56' },
                        { id: 'ä»–_57_é…å¶è€…åˆè¨ˆ', type: 'digit', x: 552, y: 366, label: '57' },
                        { id: 'ä»–_58_å°‚å¾“è€…çµ¦ä¸', type: 'digit', x: 552, y: 352, label: '58' },
                        { id: 'ä»–_59_é’è‰²ç”³å‘Šç‰¹åˆ¥æ§é™¤', type: 'digit', x: 552, y: 338, label: '59' },
                        { id: 'ä»–_66_å»¶ç´å±Šå‡ºé¡', type: 'digit', x: 552, y: 260, label: '66' },
                        // --- ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± ---
                        { id: 'æ°å', type: 'text', x: 364.7, y: 738.8, label: 'æ°', required: true },
                        { id: 'ä½æ‰€', type: 'text', x: 89.3, y: 758.8, label: 'ä½', required: true },
                        { id: 'ç¨å‹™ç½²å', type: 'text', x: 48, y: 818.1, label: 'ç¨' },
                        { id: 'è·æ¥­', type: 'text', x: 450, y: 770, label: 'è·' },
                        { id: 'å±‹å·', type: 'text', x: 450, y: 755, label: 'å±‹' },
                        { id: 'é›»è©±ç•ªå·', type: 'text', x: 350, y: 755, label: 'é›»' },
                    ],
                    // ===== ç¬¬äºŒè¡¨ (ãƒšãƒ¼ã‚¸2) =====
                    2: [
                        // æºæ³‰å¾´åç¨é¡
                        { id: 'æºæ³‰_çµ¦ä¸', type: 'digit', x: 236.7, y: 581.3, label: 'æºçµ¦' },
                        { id: 'æºæ³‰_å¹´é‡‘', type: 'digit', x: 237.3, y: 555.3, label: 'æºå¹´' },
                        // ç¤¾ä¼šä¿é™ºæ–™
                        { id: 'ç¤¾ä¿_å›½æ°‘å¥åº·', type: 'digit', x: 486, y: 769.3, label: 'å›½å¥' },
                        { id: 'ç¤¾ä¿_å›½æ°‘å¹´é‡‘', type: 'digit', x: 486, y: 747.9, label: 'å›½å¹´' },
                        // ç”Ÿå‘½ä¿é™ºæ–™
                        { id: 'ç”Ÿå‘½ä¿é™º_ä¸€èˆ¬', type: 'digit', x: 486, y: 667.9, label: 'ç”Ÿä¸€' },
                        { id: 'ç”Ÿå‘½ä¿é™º_å€‹äººå¹´é‡‘', type: 'digit', x: 484.7, y: 708.6, label: 'ç”Ÿå¹´' },
                        // ãƒ˜ãƒƒãƒ€ãƒ¼
                        { id: 'æ°å_2è¡¨', type: 'text', x: 100, y: 682.1, label: 'æ°' },
                    ],
                    3: [],
                    4: []
                }
            },
            aoiro_kessan: {
                name: 'é’è‰²ç”³å‘Šæ±ºç®—æ›¸',
                pages: 4,
                fields: {
                    1: [
                        { id: 'å£²ä¸Šé‡‘é¡', type: 'digit', x: 450, y: 700, label: 'å£²' },
                        { id: 'å£²ä¸ŠåŸä¾¡', type: 'digit', x: 450, y: 650, label: 'åŸ' },
                        { id: 'çµŒè²»åˆè¨ˆ', type: 'digit', x: 450, y: 400, label: 'çµŒ' },
                        { id: 'é’è‰²ç”³å‘Šç‰¹åˆ¥æ§é™¤', type: 'digit', x: 450, y: 200, label: 'é’' },
                        { id: 'æ‰€å¾—é‡‘é¡', type: 'digit', x: 450, y: 150, label: 'æ‰€' },
                        { id: 'å±‹å·', type: 'text', x: 100, y: 780, label: 'å±‹' },
                        { id: 'æ°å', type: 'text', x: 300, y: 780, label: 'æ°' },
                    ],
                    2: [],
                    3: [],
                    4: []
                }
            },
            uchiwake: {
                name: 'æ‰€å¾—ã®å†…è¨³æ›¸',
                pages: 1,
                fields: {
                    1: [
                        { id: 'æ‰€å¾—ç¨®é¡_1', type: 'text', x: 100, y: 650, label: 'ç¨®1' },
                        { id: 'åå…¥é‡‘é¡_1', type: 'digit', x: 350, y: 650, label: 'å1' },
                        { id: 'æºæ³‰å¾´åç¨é¡_1', type: 'digit', x: 480, y: 650, label: 'æº1' },
                        { id: 'æ‰€å¾—ç¨®é¡_2', type: 'text', x: 100, y: 600, label: 'ç¨®2' },
                        { id: 'åå…¥é‡‘é¡_2', type: 'digit', x: 350, y: 600, label: 'å2' },
                        { id: 'æ°å', type: 'text', x: 100, y: 780, label: 'æ°' },
                    ]
                }
            },
            shushi: {
                name: 'åæ”¯å†…è¨³æ›¸',
                pages: 2,
                fields: {
                    1: [
                        { id: 'å£²ä¸Šé‡‘é¡', type: 'digit', x: 450, y: 700, label: 'å£²' },
                        { id: 'ä»•å…¥é‡‘é¡', type: 'digit', x: 450, y: 650, label: 'ä»•' },
                        { id: 'çµŒè²»åˆè¨ˆ', type: 'digit', x: 450, y: 400, label: 'çµŒ' },
                        { id: 'æ‰€å¾—é‡‘é¡', type: 'digit', x: 450, y: 200, label: 'æ‰€' },
                        { id: 'å±‹å·', type: 'text', x: 100, y: 780, label: 'å±‹' },
                        { id: 'æ°å', type: 'text', x: 300, y: 780, label: 'æ°' },
                    ],
                    2: []
                }
            }
        };

        function getCurrentForms() {
            return currentTaxType === 'corporate' ? corporateForms : personalForms;
        }

        function getCurrentFormConfig() {
            return getCurrentForms()[currentDoc];
        }

        function getCurrentFields() {
            const config = getCurrentFormConfig();
            return config?.fields[currentPageNum] || [];
        }

        function renderDocSelector() {
            const forms = getCurrentForms();
            const selector = document.getElementById('docSelector');
            selector.innerHTML = '';

            Object.keys(forms).forEach((key, i) => {
                const btn = document.createElement('button');
                btn.className = `doc-btn${i === 0 ? ' active' : ''}`;
                btn.dataset.doc = key;
                btn.textContent = forms[key].name;
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.doc-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDoc = key;
                    currentPageNum = 1;
                    clearPoints();
                    updatePageNav();
                    renderFieldList();
                });
                selector.appendChild(btn);
            });

            currentDoc = Object.keys(forms)[0];
            updatePageNav();
            renderFieldList();
        }

        function updatePageNav() {
            const config = getCurrentFormConfig();
            // PDFãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å®Ÿéš›ã®ãƒšãƒ¼ã‚¸æ•°ã‚’ä½¿ç”¨
            if (pdfDoc) {
                totalPages = pdfDoc.numPages;
                // ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚‚æ›´æ–°
                if (config && totalPages > config.pages) {
                    config.pages = totalPages;
                    for (let i = 1; i <= totalPages; i++) {
                        if (!config.fields[i]) config.fields[i] = [];
                    }
                }
            } else {
                totalPages = config?.pages || 1;
            }

            const pageNav = document.getElementById('pageNav');
            if (totalPages > 1) {
                pageNav.style.display = 'flex';
                document.getElementById('currentPage').textContent = currentPageNum;
                document.getElementById('totalPages').textContent = totalPages;
            } else {
                pageNav.style.display = 'none';
            }

            // Update sidebar page indicators
            document.getElementById('currentPageIndicator').textContent = currentPageNum;
            document.getElementById('totalPageIndicator').textContent = totalPages;
        }

        // Page navigation
        document.getElementById('prevPage').addEventListener('click', async () => {
            if (currentPageNum > 1) {
                currentPageNum--;
                await renderPage();
                updatePageNav();
                clearPoints();
                createPoints();
            }
        });

        document.getElementById('nextPage').addEventListener('click', async () => {
            if (currentPageNum < totalPages) {
                currentPageNum++;
                await renderPage();
                updatePageNav();
                clearPoints();
                createPoints();
            }
        });

        // Tax type tabs
        document.querySelectorAll('.tax-type-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tax-type-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTaxType = tab.dataset.type;
                currentPageNum = 1;
                renderDocSelector();
                clearPoints();
            });
        });

        // Load PDF
        document.getElementById('pdfFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            totalPages = pdfDoc.numPages;

            // Update form config if PDF has more pages
            const config = getCurrentFormConfig();
            if (config && totalPages > config.pages) {
                config.pages = totalPages;
                for (let i = 1; i <= totalPages; i++) {
                    if (!config.fields[i]) config.fields[i] = [];
                }
            }

            await renderPage();
            updatePageNav();
            renderFieldList();
        });

        async function renderPage() {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(currentPageNum);
            const viewport = page.getViewport({ scale });
            pdfWidth = page.getViewport({ scale: 1 }).width;
            pdfHeight = page.getViewport({ scale: 1 }).height;
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: ctx, viewport }).promise;
        }

        function pdfToScreen(x, y) {
            return { left: x * scale, top: (pdfHeight - y) * scale };
        }

        function screenToPdf(left, top) {
            return { x: left / scale, y: pdfHeight - (top / scale) };
        }

        function clearPoints() {
            document.querySelectorAll('.draggable-point').forEach(el => el.remove());
        }

        function createPoints() {
            clearPoints();
            const fields = getCurrentFields();

            fields.forEach((field, index) => {
                const pos = pdfToScreen(field.x, field.y);
                const point = document.createElement('div');
                let classNames = `draggable-point ${field.type}`;
                if (field.required) classNames += ' required';
                if (field.hidden) classNames += ' hidden-field';
                point.className = classNames;
                point.textContent = field.label;
                // Clamp positions to visible area to ensure points are accessible
                const safeLeft = Math.max(0, Math.min(pos.left, canvas.width - 20)); // -20 for point width
                const safeTop = Math.max(0, Math.min(pos.top, canvas.height - 20));

                point.style.left = safeLeft + 'px';
                point.style.top = safeTop + 'px';
                point.dataset.index = index;
                point.addEventListener('mousedown', startDrag);
                wrapper.appendChild(point);
            });

            renderFieldList();
        }

        function startDrag(e) {
            e.preventDefault();
            const point = e.target;
            const index = parseInt(point.dataset.index);
            const fields = getCurrentFields();

            isDragging = true;
            point.classList.add('dragging', 'selected');

            document.querySelectorAll('.draggable-point').forEach(p => {
                if (p !== point) p.classList.remove('selected');
            });
            document.querySelectorAll('.field-item').forEach(item => {
                item.classList.toggle('selected', parseInt(item.dataset.index) === index);
            });

            updateSelectedInfo(fields[index]);

            const onMouseMove = (e) => {
                if (!isDragging) return;
                const rect = wrapper.getBoundingClientRect();
                const left = Math.max(0, Math.min(e.clientX - rect.left, canvas.width));
                const top = Math.max(0, Math.min(e.clientY - rect.top, canvas.height));

                point.style.left = left + 'px';
                point.style.top = top + 'px';

                const pdfCoords = screenToPdf(left, top);
                fields[index].x = Math.round(pdfCoords.x * 10) / 10;
                fields[index].y = Math.round(pdfCoords.y * 10) / 10;

                updateSelectedInfo(fields[index]);
            };

            const onMouseUp = () => {
                isDragging = false;
                point.classList.remove('dragging');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                renderFieldList();
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function updateSelectedInfo(field) {
            document.getElementById('selectedInfo').style.display = 'block';
            document.getElementById('selectedName').textContent = field.id;
            document.getElementById('selectedCoords').textContent = `${field.x}, ${field.y}`;
        }

        function renderFieldList() {
            const fields = getCurrentFields();
            const list = document.getElementById('fieldList');
            document.getElementById('fieldCount').textContent = fields.length;

            list.innerHTML = fields.map((f, i) => `
                <div class="field-item${f.hidden ? ' hidden-item' : ''}" data-index="${i}">
                    <div class="num ${f.type}">${f.label}</div>
                    ${f.required ? '<span style="color:#ffcc00;margin-right:2px;">â˜…</span>' : ''}
                    <span title="${f.id}">${f.id.length > 20 ? f.id.substring(0, 17) + '...' : f.id}</span>
                    <span style="margin-left:auto;color:#888;font-family:monospace;font-size:0.85em;">(${f.x}, ${f.y})</span>
                    <div style="display: flex; gap: 4px; margin-left: 8px;">
                        <button class="toggle-visibility-btn" data-index="${i}" title="è¡¨ç¤º/éè¡¨ç¤º" style="width:16px;height:16px;padding:0;font-size:10px;cursor:pointer;background:${f.hidden ? '#e94560' : '#10ac84'};border:none;border-radius:4px;color:white;display:flex;align-items:center;justify-content:center;">
                            ${f.hidden ? 'â—‹' : 'Ã—'}
                        </button>
                        <button class="delete-field-btn" data-index="${i}" title="å‰Šé™¤" style="width:16px;height:16px;padding:0;font-size:10px;cursor:pointer;background:#6c757d;border:none;border-radius:4px;color:white;display:flex;align-items:center;justify-content:center;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');

            // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é¸æŠ
            list.querySelectorAll('.field-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
                    if (e.target.closest('button')) return;

                    const index = parseInt(item.dataset.index);
                    const point = document.querySelector(`.draggable-point[data-index="${index}"]`);
                    if (point) {
                        document.querySelectorAll('.draggable-point').forEach(p => p.classList.remove('selected'));
                        document.querySelectorAll('.field-item').forEach(i => i.classList.remove('selected'));
                        point.classList.add('selected');
                        item.classList.add('selected');
                        updateSelectedInfo(fields[index]);
                    }
                });
            });

            // è¡¨ç¤º/éè¡¨ç¤ºãƒˆã‚°ãƒ«
            list.querySelectorAll('.toggle-visibility-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    const field = fields[index];
                    field.hidden = !field.hidden;
                    renderFieldList();
                    createPoints();
                });
            });

            // å‰Šé™¤
            list.querySelectorAll('.delete-field-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    if (confirm(`ã€Œ${fields[index].id}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        fields.splice(index, 1);
                        renderFieldList();
                        createPoints();
                    }
                });
            });
        }

        // Add field
        document.getElementById('addFieldBtn').addEventListener('click', () => {
            const name = document.getElementById('newFieldName').value.trim();
            const type = document.getElementById('newFieldType').value;
            if (!name) { alert('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            const fields = getCurrentFields();
            const newLabel = type === 'digit' ? String(fields.length + 1) : name.charAt(0);
            fields.push({ id: name, type: type, x: 300, y: 400, label: newLabel });

            document.getElementById('newFieldName').value = '';
            createPoints();
        });

        document.getElementById('showPoints').addEventListener('click', () => {
            if (!pdfDoc) { alert('PDFã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
            createPoints();
        });

        // Export - now exports all pages
        document.getElementById('exportCoords').addEventListener('click', () => {
            const config = getCurrentFormConfig();
            const docName = currentDoc.toUpperCase();

            let output = `// ===== ${docName} COORDINATE CONFIG =====\n`;
            output += `// Total pages: ${config.pages}\n\n`;

            for (let page = 1; page <= config.pages; page++) {
                const fields = config.fields[page] || [];
                if (fields.length === 0) continue;

                const digitFields = fields.filter(f => f.type === 'digit');
                const textFields = fields.filter(f => f.type === 'text');

                output += `// ===== PAGE ${page} =====\n`;
                output += `export const ${docName}_PAGE${page}_FIELDS: { [key: string]: DigitBoxConfig } = {\n`;

                digitFields.forEach(f => {
                    output += `    '${f.id}': { anchorX: ${f.x}, anchorY: ${f.y}, boxWidth: 16, boxSpacing: 16, fontSize: 10, maxDigits: 12 },\n`;
                });

                output += '};\n\n';
                output += `export const ${docName}_PAGE${page}_TEXT: { [key: string]: TextFieldConfig } = {\n`;

                textFields.forEach(f => {
                    output += `    '${f.id}': { x: ${f.x}, y: ${f.y}, fontSize: 9 },\n`;
                });

                output += '};\n\n';
            }

            document.getElementById('output').textContent = output;
        });

        // Update Coordinates in Source Code
        document.getElementById('updateCoordsBtn').addEventListener('click', async () => {
            if (!confirm('ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰(pdfDigitBoxService.ts)ã®åº§æ¨™å®šç¾©ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚')) {
                return;
            }

            // Generate TypeScript code
            let output = `// ===== COORDINATE CONFIGURATION =====

/**
 * Box configuration for digit placement
 * Values are in PDF points (1pt = 1/72 inch â‰ˆ 0.35mm)
 */
export interface DigitBoxConfig {
    anchorX: number;      // Rightmost digit box center X
    anchorY: number;      // Text baseline Y
    boxWidth: number;     // Width of each digit box
    boxSpacing: number;   // Center-to-center spacing
    fontSize: number;     // Font size for digits
    maxDigits: number;    // Maximum digits
}

/**
 * Text field configuration for company info
 */
export interface TextFieldConfig {
    x: number;
    y: number;
    fontSize: number;
    maxWidth?: number;
    align?: 'left' | 'center' | 'right';
}

// ===================================================================
// IMPORTANT: Coordinates calibrated using drag-and-drop tool
// Digit boxes standardized to 16pt width/spacing and 10pt font size
// ===================================================================
`;

            // Helper to generate field config string
            const generateFieldConfig = (fields) => {
                if (!fields || fields.length === 0) return '';
                // Sort by ID to keep order somewhat consistent
                // Custom sort order based on field contents might be better but simple sort for now
                return fields.map(f => {
                    if (f.type === 'digit') {
                        return `    '${f.id}': { anchorX: ${f.x}, anchorY: ${f.y}, boxWidth: 16, boxSpacing: 16, fontSize: 10, maxDigits: 12 },`;
                    } else {
                        return `    '${f.id}': { x: ${f.x}, y: ${f.y}, fontSize: 9 },`;
                    }
                }).join('\n');
            };

            // Beppyo 1
            output += `
export const BEPPYO1_FIELDS: { [key: string]: DigitBoxConfig } = {
${generateFieldConfig(corporateForms.beppyo1.fields[1].filter(f => f.type === 'digit'))}
};

export const BEPPYO1_TEXT_FIELDS: { [key: string]: TextFieldConfig } = {
${generateFieldConfig(corporateForms.beppyo1.fields[1].filter(f => f.type === 'text'))}
};
`;

            // Beppyo 4
            output += `
// ===== BEPPYO4 COORDINATE CONFIG =====
export const BEPPYO4_FIELDS: { [key: string]: DigitBoxConfig } = {
${generateFieldConfig(corporateForms.beppyo4.fields[1].filter(f => f.type === 'digit'))}
};

export const BEPPYO4_TEXT_FIELDS: { [key: string]: TextFieldConfig } = {
${generateFieldConfig(corporateForms.beppyo4.fields[1].filter(f => f.type === 'text'))}
};
`;

            // Beppyo 5 (Page 1 only for now as per current structure)
            output += `
// ===== BEPPYO5 (åˆ©ç›Šç©ç«‹é‡‘) COORDINATE CONFIG =====
export const BEPPYO5_PAGE1_FIELDS: { [key: string]: DigitBoxConfig } = {
${generateFieldConfig(corporateForms.beppyo5.fields[1].filter(f => f.type === 'digit'))}
};

export const BEPPYO5_PAGE1_TEXT: { [key: string]: TextFieldConfig } = {
${generateFieldConfig(corporateForms.beppyo5.fields[1].filter(f => f.type === 'text'))}
};

// ===== BEPPYO5 (2) (ç§Ÿç¨å…¬èª²) COORDINATE CONFIG =====
export const BEPPYO5_PAGE2_FIELDS: { [key: string]: DigitBoxConfig } = {
${generateFieldConfig(corporateForms.beppyo5_2.fields[1].filter(f => f.type === 'digit'))}
};
export const BEPPYO5_PAGE2_TEXT: { [key: string]: TextFieldConfig } = {
${generateFieldConfig(corporateForms.beppyo5_2.fields[1].filter(f => f.type === 'text'))}
};

// ===== BEPPYO15 (äº¤éš›è²») COORDINATE CONFIG =====
export const BEPPYO15_FIELDS: { [key: string]: DigitBoxConfig } = {
${generateFieldConfig(corporateForms.beppyo15.fields[1].filter(f => f.type === 'digit'))}
};
export const BEPPYO15_TEXT: { [key: string]: TextFieldConfig } = {
${generateFieldConfig(corporateForms.beppyo15.fields[1].filter(f => f.type === 'text'))}
};

// ===== BEPPYO16 (1) (æ¸›ä¾¡å„Ÿå´ å®šé¡æ³•) COORDINATE CONFIG =====
export const BEPPYO16_1_FIELDS: { [key: string]: DigitBoxConfig } = {
${generateFieldConfig(corporateForms.beppyo16.fields[1].filter(f => f.type === 'digit'))}
};
export const BEPPYO16_1_TEXT: { [key: string]: TextFieldConfig } = {
${generateFieldConfig(corporateForms.beppyo16.fields[1].filter(f => f.type === 'text'))}
};

// ===== BEPPYO16 (2) (æ¸›ä¾¡å„Ÿå´ å®šç‡æ³•) COORDINATE CONFIG =====
export const BEPPYO16_2_FIELDS: { [key: string]: DigitBoxConfig } = {
${generateFieldConfig(corporateForms.beppyo16_2.fields[1].filter(f => f.type === 'digit'))}
};
export const BEPPYO16_2_TEXT: { [key: string]: TextFieldConfig } = {
${generateFieldConfig(corporateForms.beppyo16_2.fields[1].filter(f => f.type === 'text'))}
};
`;

            try {
                const response = await fetch('http://localhost:3001/api/update-coordinates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: output }),
                });

                const result = await response.json();

                if (response.ok) {
                    alert('âœ… åº§æ¨™ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼\n\nã€é‡è¦ã€‘å¤‰æ›´ã‚’åæ˜ ã™ã‚‹ã«ã¯:\n1. npm run dev ã‚’ Ctrl+C ã§åœæ­¢\n2. npm run dev ã§å†èµ·å‹•\n\nã¾ãŸã¯ä»»æ„ã®.tsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦HMRã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
                    document.getElementById('output').textContent = 'âœ… åº§æ¨™æ›´æ–°æˆåŠŸ: ' + new Date().toLocaleTimeString() + ' (ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ãŒå¿…è¦)';
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (err) {
                alert('âŒ æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                document.getElementById('output').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + err.message;
            }
        });

        // JSON Import - Load coordinates from JSON file
        document.getElementById('importJsonBtn').addEventListener('click', () => {
            document.getElementById('importJsonFile').click();
        });

        document.getElementById('importJsonFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const jsonData = JSON.parse(event.target.result);

                    if (!jsonData.configs) {
                        throw new Error('Invalid config format: missing configs property');
                    }

                    let importedCount = 0;

                    // Import corporate forms
                    Object.keys(jsonData.configs).forEach(key => {
                        const config = jsonData.configs[key];
                        if (corporateForms[key]) {
                            corporateForms[key] = config;
                            importedCount++;
                        } else if (personalForms[key]) {
                            personalForms[key] = config;
                            importedCount++;
                        }
                    });

                    // Refresh display
                    if (pdfDoc) {
                        createPoints();
                    }
                    renderFieldList();

                    document.getElementById('output').textContent = `âœ… ${importedCount}ä»¶ã®åº§æ¨™è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ\n(${jsonData.exportedAt || 'unknown date'}ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ)`;
                } catch (err) {
                    alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset for re-import
        });

        // Initialize
        renderDocSelector();
    </script>
</body>

</html>