# レシートスキャン機能 - 精度向上ガイド

## 概要
このドキュメントでは、レシートスキャン機能の精度を最大化するための方法を説明します。

## OCRエンジン構成

### 2段階OCRシステム
1. **Google Cloud Vision API（優先）**
   - 最高精度のOCRエンジン
   - 日本語・英語の混在テキストに強い
   - 手書き文字にも対応

2. **Tesseract.js（フォールバック）**
   - オフライン対応
   - Google Cloud Vision APIが利用できない場合に自動的に使用
   - 日本語+英語のデュアル言語モード

## Google Cloud Vision API セットアップ

### 1. APIキーの取得
1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクトを作成または選択
3. Cloud Vision APIを有効化
4. APIキーを作成

### 2. 環境変数の設定
`.env`ファイルに以下を追加:
```env
VITE_GOOGLE_VISION_API_KEY=your_api_key_here
```

### 3. API設定（最適化済み）
現在の実装では以下の最適化が適用されています:
- `DOCUMENT_TEXT_DETECTION`: ドキュメント認識を優先
- `TEXT_DETECTION`: バックアップとして通常のテキスト検出
- `IMAGE_PROPERTIES`: 画像品質分析
- 言語ヒント: 日本語(`ja`)と英語(`en`)
- 信頼度スコア: 有効化

## 画像前処理パイプライン

### 5段階の最適化処理
1. **ノイズ除去** - Gaussian BlurとMedian Filterで画像をクリーンに
2. **傾き補正** - エッジ検出で自動的に傾きを補正
3. **コントラスト強化** - ヒストグラム均等化でテキストを鮮明に
4. **シャープ化** - Unsharp Maskingで文字のエッジを強調
5. **適応的二値化** - ローカル閾値処理で背景とテキストを分離

### 処理モード
- **標準モード**: 全処理を実行（高精度）
- **高速モード**: コントラスト強化+二値化のみ（高速）

## レシート撮影のベストプラクティス

### 1. 撮影環境
- ✅ **明るい場所で撮影**
  - 自然光または均一な照明
  - 蛍光灯の真下は避ける
- ✅ **平らな面に置く**
  - レシートを平らに広げる
  - 折り目やシワをできるだけ伸ばす
- ✅ **影を避ける**
  - レシートに影が落ちないように注意

### 2. カメラ設定
- ✅ **縦長ガイドに合わせる**
  - レシート全体がガイド内に収まるように
  - 余白を最小限に
- ✅ **ピント合わせ**
  - タップしてフォーカス調整
  - 自動撮影機能が品質をチェック
- ✅ **手ブレ防止**
  - 両手でしっかり持つ
  - 自動撮影を活用

### 3. 避けるべき条件
- ❌ 暗すぎる・明るすぎる
- ❌ 斜めから撮影
- ❌ レシートが丸まっている
- ❌ 汚れや破損がひどい
- ❌ 感熱紙が劣化している

## 認識精度向上のための店舗名データベース

### 対応店舗（200店舗以上）
- **コンビニ**: セブンイレブン、ローソン、ファミマ、ミニストップなど
- **スーパー**: イオン、イトーヨーカドー、ライフ、西友など
- **飲食店**: マクドナルド、スタバ、すき家、吉野家など
- **ドラッグストア**: マツキヨ、ウエルシア、ツルハなど
- **家電**: ビックカメラ、ヨドバシ、ヤマダ電機など
- **その他**: 百貨店、書店、ガソリンスタンドなど

## 金額抽出の強化

### 優先度付きパターンマッチング

#### 高信頼度（最優先）
- 「合計」「総計」「お買上計」などのキーワード付き
- 例: `合計 ¥1,320`

#### 中信頼度
- 決済方法別パターン
- 例: `PayPay ¥1,320`, `現金 ¥1,320`

#### 低信頼度（フォールバック）
- 頻出金額の検出
- 最大値の選択（日付を除外）

### 対応決済方法
- 現金、クレジットカード
- PayPay、d払い、LINE Pay、楽天ペイ、メルペイ
- Suica、PASMO、nanaco、WAON、Edy
- iD、QUICPay

## トラブルシューティング

### OCRが失敗する場合

#### 問題1: 「OCR_FAILED」エラー
**原因**: 画像の品質が低い、APIキーが無効

**解決策**:
1. 照明を改善して再撮影
2. レシートを平らに広げる
3. APIキーを確認（Google Cloud Vision API）
4. Tesseract.jsが自動的にフォールバック

#### 問題2: 金額が正しく抽出されない
**原因**: 特殊なレシート形式、OCRの誤認識

**解決策**:
1. レシート全体が枠内に収まっているか確認
2. ピントを合わせて再撮影
3. 手動で金額を編集（編集機能を利用）

#### 問題3: 店舗名が「不明」になる
**原因**: 店舗が未登録、OCRの誤認識

**解決策**:
1. レシートの上部（店舗名が記載されている部分）を鮮明に撮影
2. 手動で店舗名を編集
3. 未対応店舗は随時追加予定

### デバッグモード
ブラウザの開発者コンソールで詳細ログを確認:
```javascript
// 画像前処理の進捗
[1/5] ノイズ除去を実行中...
   完了 (234ms)
[2/5] 傾き補正を実行中...
   完了 (156ms)
...

// OCR結果
OCR結果: セブンイレブン\n2024/11/24\n合計 ¥1,320\n...

// データ抽出結果
店舗名抽出成功: セブンイレブン
日付抽出成功: 2024-11-24
高信頼度金額抽出成功 (パターン0): 1320
```

## パフォーマンス最適化

### 処理時間の目安
- **画像前処理**: 1-3秒
- **Google Cloud Vision API**: 2-4秒
- **Tesseract.js**: 5-10秒（初回は言語データダウンロードで+10秒）
- **データ抽出**: <1秒

### キャッシュとオフライン対応
- Tesseract.jsの言語データはブラウザにキャッシュ
- 2回目以降は高速に動作

## 今後の改善予定

- [ ] 複数レシートの一括スキャン
- [ ] レシート画像の保存機能
- [ ] AI学習による精度向上
- [ ] QRコードからの自動データ取得
- [ ] 手書きメモの認識
- [ ] レシートの自動分類

## まとめ

レシートスキャン機能は以下の要素で最高精度を実現しています:
1. **2段階OCRシステム** - Google Cloud Vision API + Tesseract.js
2. **5段階画像前処理** - ノイズ除去から二値化まで
3. **優先度付きパターンマッチング** - 200店舗以上対応、多様な決済方法
4. **縦長撮影ガイド** - レシートの形状に最適化

これらの機能により、ほとんどの日本のレシートを高精度で認識できます。
