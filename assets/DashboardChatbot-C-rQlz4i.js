import{c as C,r as o,a as z,e as A,l as _,j as e,X as R,H as F}from"./index-BcSqN67S.js";import{parseChatTransactionWithAI as O}from"./geminiAIService-DQoIspWT.js";import{d as B,s as K}from"./keywordCategoryService-9yZ-pShI.js";import{S as P}from"./send-BMYfwif-.js";/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]],S=C("bot",V);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=[["path",{d:"m14 10 7-7",key:"oa77jy"}],["path",{d:"M20 10h-6V4",key:"mjg0md"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M4 14h6v6",key:"rmj7iw"}]],L=C("minimize-2",H),Q=()=>{const[l,g]=o.useState(!1),[m,y]=o.useState(""),[d,D]=o.useState(new Date().toISOString().split("T")[0]),[h,w]=o.useState(!1),v=o.useRef(null),[j,x]=o.useState([{role:"assistant",content:`こんにちは！AIアシスタントです。
「タクシー代 2500円」のように入力すると、自動で家計簿に記録します。`}]),{user:r}=z(),{currentBusinessType:p}=A(),{createTransaction:M}=_(r==null?void 0:r.id,p==null?void 0:p.business_type),N=o.useRef(null),E=()=>{var t;(t=N.current)==null||t.scrollIntoView({behavior:"smooth"})};o.useEffect(()=>{E()},[j,l]);const T=async t=>{if(t==null||t.preventDefault(),!m.trim()||h)return;const a=m;y(""),x(s=>[...s,{role:"user",content:a}]),w(!0);try{if(!(r!=null&&r.id))throw new Error("ログインが必要です");const s=await O(a);let n;if(s)n={item:s.item||"AIチャット入力",description:s.description||s.item,amount:s.amount,date:s.date||d,category:s.category||"未分類",type:s.type||"expense",creator:r.id,approval_status:"pending",tags:["ai-chat"]};else{let i=0;const u=a.match(/((?:\d+[,\s]?)+(?:万(?:\s?\d+)*)?(?:千(?:\s?\d+)*)?円?)/);if(u){let c=u[1].replace(/円|,/g,"");if(c.includes("万")){const f=c.split("万");i=(parseFloat(f[0])||0)*1e4,f[1]&&(i+=(parseFloat(f[1].replace("千",""))||0)*1e3)}else i=parseFloat(c)||0}const I=B(a)||"未分類",$=["売上","売り上げ","収入","入金","給与","給料","賞与","ボーナス","受取"].some(c=>a.includes(c));let b=a;u&&(b=a.replace(u[0],"").trim()),n={item:K(b||a,I),description:b||a,amount:i,date:d,category:I,type:$?"income":"expense",creator:r.id,approval_status:"pending",tags:["ai-chat","fallback"]}}const k=await M(n);if(k.error)throw k.error;x(i=>[...i,{role:"assistant",content:`✅ 記録しました！
科目: ${n.category}
金額: ¥${n.amount.toLocaleString()}
(確認待ちに追加されました)`}]),window.dispatchEvent(new CustomEvent("transactionRecorded"))}catch(s){console.error("AI Chat Error:",s),x(n=>[...n,{role:"assistant",content:`❌ エラーが発生しました: ${s.message}`}])}finally{w(!1)}};return e.jsxs("div",{className:"fixed bottom-24 md:bottom-32 right-6 z-40 flex flex-col items-end transition-all duration-300 pointer-events-none",children:[l&&e.jsxs("div",{className:"relative bg-white dark:bg-surface border border-border shadow-2xl rounded-2xl w-80 sm:w-96 h-[500px] mb-4 flex flex-col overflow-visible animate-in slide-in-from-bottom-5 duration-200 pointer-events-auto",children:[e.jsx("div",{className:"absolute -bottom-2 right-8 w-4 h-4 bg-white dark:bg-surface border-b border-r border-border rotate-45 z-0"}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden relative z-10 bg-white dark:bg-surface rounded-2xl",children:[e.jsxs("div",{className:"bg-primary/5 p-4 border-b border-border flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-bold text-text-main",children:"AIアシスタント"})]}),e.jsx("button",{onClick:()=>g(!1),className:"text-text-muted hover:text-text-main p-1 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors",children:e.jsx(R,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-surface-highlight/30",children:[j.map((t,a)=>e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-2xl px-4 py-2.5 text-sm whitespace-pre-wrap ${t.role==="user"?"bg-primary text-white rounded-tr-none":"bg-surface border border-border text-text-main rounded-tl-none shadow-sm"}`,children:t.content})},a)),h&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"bg-surface border border-border text-text-main rounded-2xl rounded-tl-none px-4 py-3 shadow-sm flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-primary rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-1.5 h-1.5 bg-primary rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-1.5 h-1.5 bg-primary rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})}),e.jsx("div",{ref:N})]}),e.jsx("form",{onSubmit:T,className:"p-3 border-t border-border bg-surface",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{type:"button",onClick:()=>{var t;return(t=v.current)==null?void 0:t.showPicker()},className:`p-2.5 rounded-xl transition-all ${d!==new Date().toISOString().split("T")[0]?"bg-primary text-white shadow-lg shadow-primary/25":"bg-surface-highlight text-text-muted hover:text-text-main hover:bg-surface-highlight/80"}`,title:"日付を選択 (基準日)",children:e.jsx(F,{className:"w-5 h-5"})}),d!==new Date().toISOString().split("T")[0]&&e.jsxs("span",{className:"absolute -top-1 -right-1 flex h-3 w-3",children:[e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex rounded-full h-3 w-3 bg-red-500"})]}),e.jsx("input",{type:"date",ref:v,value:d,onChange:t=>D(t.target.value),className:"absolute inset-0 opacity-0 cursor-pointer"})]}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"text",value:m,onChange:t=>y(t.target.value),placeholder:"例: ランチ 1000円",className:"w-full pl-4 pr-12 py-3 bg-surface-highlight border border-border rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 text-text-main text-sm",disabled:h}),e.jsx("button",{type:"submit",disabled:!m.trim()||h,className:"absolute right-2 top-1/2 -translate-y-1/2 p-1.5 bg-primary text-white rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-all",children:e.jsx(P,{className:"w-4 h-4"})})]})]})})]})]}),e.jsx("button",{onClick:()=>g(!l),className:`flex items-center justify-center gap-2 px-5 py-4 rounded-full shadow-lg shadow-primary/25 transition-all duration-300 hover:scale-105 active:scale-95 pointer-events-auto ${l?"bg-surface-highlight text-text-muted border border-border hover:bg-surface-highlight/80":"bg-gradient-to-r from-primary to-blue-600 text-white"}`,children:l?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"w-5 h-5"}),e.jsx("span",{className:"font-bold text-sm hidden sm:inline",children:"閉じる"})]}):e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"w-6 h-6"}),e.jsx("span",{className:"font-bold text-sm hidden sm:inline",children:"AIで記帳"})]})})]})};export{Q as default};
