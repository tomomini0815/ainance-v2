import{r as i,s as f}from"./index-9K-405_8.js";const y=o=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(o),D=o=>{const[g,n]=i.useState([]),[p,u]=i.useState(!1),h=i.useCallback(async()=>{if(!o)return null;try{const{data:t,error:e}=await f.from("business_type").select("*").eq("id",o).single();if(e)throw e;return t}catch(t){return console.error("業態形態情報の取得に失敗しました:",t),null}},[o]),l=i.useCallback(async()=>{if(!o)return"individual_transactions";const t=await h();return t&&t.business_type==="corporation"?"corporation_transactions":"individual_transactions"},[o,h]),c=i.useCallback(async()=>{if(!o){n([]);return}u(!0);const t=localStorage.getItem("user");let e="00000000-0000-0000-0000-000000000000";if(t)try{const r=JSON.parse(t);y(r.id)&&(e=r.id)}catch(r){console.error("ユーザー情報の解析に失敗しました:",r)}try{const r=await l();console.log("取引データを取得するテーブル:",r);const{data:s,error:a}=await f.from(r).select("*").eq("creator",e).order("date",{ascending:!1});if(a)if(a.message&&a.message.includes("not found"))console.warn(`テーブル ${r} が存在しません。テーブルを作成するか、管理者に問い合わせてください。`),n([]);else throw a;else n(s||[]);u(!1)}catch(r){console.error(`取引データの取得に失敗しました: ${r.message}`),n([]),u(!1)}},[o,l]),E=async t=>{if(!o)throw new Error("業態形態が選択されていません");try{y(t.creator)||(console.warn("無効なcreator IDが検出されました。匿名ユーザーとして処理します。"),t.creator="00000000-0000-0000-0000-000000000000");const e={...t,creator:t.creator||"00000000-0000-0000-0000-000000000000"},r=await l();console.log("取引データを保存中:",e),console.log("保存するテーブル:",r);const{data:s,error:a}=await f.from(r).insert(e).select().single();if(a)throw a.message&&a.message.includes("not found")?new Error(`テーブル ${r} が存在しません。テーブルを作成するか、管理者に問い合わせてください。`):a;console.log("取引データ保存成功:",s.id);const w=s;return n(d=>[w,...d]),await c(),s.id}catch(e){throw console.error("取引の作成に失敗しました:",e),e.message&&e.message.includes("Failed to fetch")?new Error("ネットワークエラーが発生しました。インターネット接続を確認してください。"):e}},S=async(t,e)=>{if(!o)throw new Error("業態形態が選択されていません");try{const r=await l(),{data:s,error:a}=await f.from(r).update({...e,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(a)throw a;const w=s;n(d=>d.map(m=>m.id===t?w:m)),await c()}catch(r){throw console.error("取引の更新に失敗しました:",r),r}},_=async t=>{if(!o)throw new Error("業態形態が選択されていません");try{const e=await l(),{error:r}=await f.from(e).delete().eq("id",t);if(r)throw r;n(s=>s.filter(a=>a.id!==t)),await c()}catch(e){throw console.error("取引の削除に失敗しました:",e),e}};return i.useEffect(()=>{c()},[c]),{transactions:g,loading:p,fetchTransactions:c,createTransaction:E,updateTransaction:S,deleteTransaction:_}};export{D as u};
