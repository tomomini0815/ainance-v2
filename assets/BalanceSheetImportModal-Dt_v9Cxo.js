import{r as l,j as e,F as A,X as Z,U as ee,S as te,x as se,d as E,G as x}from"./index-Ca_aGh3E.js";import{s as ae}from"./PreviousYearImportModal-BH5M637s.js";import{analyzeBSDocumentWithVision as re}from"./geminiAIService-DQoIspWT.js";import{y as P}from"./yearlyBalanceSheetService-DD9gBUkK.js";import{L as I}from"./loader-circle-R8GsC2dY.js";import{A as ne}from"./arrow-right-CzQErwYu.js";import{A as le}from"./arrow-left-w2g22jH0.js";import{S as ie}from"./save-D1FMWJIj.js";const _e=({isOpen:v,onClose:z,userId:m,businessType:u,onImportSuccess:R})=>{const[i,d]=l.useState(1),[h,p]=l.useState(!1),[C,g]=l.useState(!1),[$,N]=l.useState(!1),[b,j]=l.useState(null),k=l.useRef(null),[a,_]=l.useState({user_id:m,business_type:u,year:new Date().getFullYear()-1,assets_current_cash:0,assets_current_total:0,assets_total:0,liabilities_total:0,net_assets_capital:0,net_assets_retained_earnings:0,net_assets_retained_earnings_total:0,net_assets_shareholders_equity:0,net_assets_total:0,liabilities_and_net_assets_total:0,metadata:{},document_path:void 0});if(l.useEffect(()=>{v&&(d(1),j(null),p(!1),g(!1),_({user_id:m,business_type:u,year:new Date().getFullYear()-1,assets_current_cash:0,assets_current_total:0,assets_total:0,liabilities_total:0,net_assets_capital:0,net_assets_retained_earnings:0,net_assets_retained_earnings_total:0,net_assets_shareholders_equity:0,net_assets_total:0,liabilities_and_net_assets_total:0,metadata:{},document_path:void 0}))},[v,m,u]),!v)return null;const D=async t=>{if(!t)return;const s=t.type.startsWith("image/"),r=t.type==="application/pdf";if(!s&&!r){x.error("画像またはPDFファイルを選択してください");return}j(t),p(!0);try{const c=new FileReader;c.onloadend=async()=>{const y=c.result,f=await re(y);if(f){const w=P.mapAiResultToBS(f,m,u,{fileName:t.name});_(w),d(2),x.success("解析が完了しました。内容を確認してください。")}else x.error("解析に失敗しました。数値を直接入力してください。"),d(2);p(!1)},c.readAsDataURL(t)}catch(c){console.error("BS Analysis Error:",c),x.error("解析中にエラーが発生しました"),p(!1),d(2)}},L=t=>{var r;const s=(r=t.target.files)==null?void 0:r[0];s&&D(s)},q=t=>{t.preventDefault(),t.stopPropagation(),!h&&i===1&&N(!0)},U=t=>{t.preventDefault(),t.stopPropagation(),N(!1)},V=t=>{var s;if(t.preventDefault(),t.stopPropagation(),N(!1),!h&&i===1){const r=(s=t.dataTransfer.files)==null?void 0:s[0];r&&D(r)}},n=(t,s)=>{let r=typeof s=="string"?parseInt(s)||0:s;_(c=>({...c,[t]:r}))},Y=async()=>{g(!0);try{let t;if(b)try{x.loading("ファイルをアップロード中...",{id:"upload-toast"}),t=await ae.uploadFinancialDocument(m,b,a.year,"bs"),t&&x.success("ファイルのアップロード完了",{id:"upload-toast"})}catch(r){console.error("File Upload Error:",r),x.error("ファイルのアップロードに失敗しました",{id:"upload-toast"})}const s={...a,document_path:t||a.document_path};await P.save(s),R(),d(3),g(!1)}catch(t){console.error("Save BS Error:",t),x.error("保存に失敗しました"),g(!1)}},G=()=>{j(null),_({...a,year:new Date().getFullYear()-1}),d(2)},M=()=>{d(1),j(null),_({user_id:m,business_type:u,year:new Date().getFullYear()-1,assets_current_cash:0,assets_current_total:0,assets_total:0,liabilities_total:0,net_assets_capital:0,net_assets_retained_earnings:0,net_assets_retained_earnings_total:0,net_assets_shareholders_equity:0,net_assets_total:0,liabilities_and_net_assets_total:0,metadata:{},document_path:void 0})},T=t=>{const s=t<0,r=Math.abs(t);return(s?"△":"")+r.toLocaleString()},o=({label:t,value:s,onChange:r,indent:c=!1,indentPlus:y=!1,isBold:f=!1,isTotal:w=!1})=>{const[X,F]=l.useState(!1),[B,S]=l.useState(s.toString());l.useEffect(()=>{S(s.toString())},[s]);const H=()=>{F(!1),r(parseInt(B)||0)},K=()=>{S(s.toString()),F(!0)},O=T(s);return e.jsxs("div",{className:`flex justify-between items-end border-b ${w?"border-zinc-800 border-b-2":"border-zinc-200"} py-1.5 group transition-colors hover:bg-zinc-50 dark:hover:bg-zinc-900/50`,children:[e.jsx("div",{className:`${c?"pl-4":y?"pl-8":""} ${f?"font-bold":"text-zinc-700 dark:text-zinc-300"} text-sm`,children:t}),e.jsx("div",{className:"w-36 text-right relative",children:X?e.jsx("input",{type:"number",value:B,onChange:Q=>S(Q.target.value),onBlur:H,autoFocus:!0,className:"w-full bg-white dark:bg-zinc-800 border-b-2 border-primary text-right outline-none font-mono py-0.5 px-1 rounded-t-sm shadow-sm"}):e.jsx("div",{onClick:K,className:`w-full cursor-text text-right font-mono text-sm ${f?"font-bold text-zinc-900 dark:text-zinc-50":"text-zinc-800 dark:text-zinc-200"} ${s<0?"text-error":""} py-0.5 px-1 hover:bg-zinc-200/50 dark:hover:bg-zinc-700/50 rounded transition-colors`,children:O})})]})},W=a.assets_total!==a.liabilities_and_net_assets_total,J=()=>e.jsx("div",{className:"flex items-center justify-center mb-8",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`
                        flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm
                        ${i>=t?"bg-primary text-white":"bg-surface-highlight text-text-muted"}
                        transition-colors duration-300
                    `,children:i>t?e.jsx(E,{className:"w-5 h-5"}):t}),e.jsxs("span",{className:`ml-2 text-sm font-medium ${i>=t?"text-text-main":"text-text-muted"}`,children:[t===1&&"アップロード",t===2&&"データ確認",t===3&&"完了"]}),t<3&&e.jsx("div",{className:`w-12 h-0.5 mx-4 ${i>t?"bg-primary":"bg-surface-highlight"}`})]},t))});return e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-surface border border-border rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl",onDragOver:q,onDragLeave:U,onDrop:V,children:[e.jsxs("div",{className:"px-6 py-4 border-b border-border flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-text-main flex items-center",children:[e.jsx(A,{className:"w-5 h-5 mr-2 text-primary"}),"貸借対照表（BS）のインポート"]}),e.jsx("button",{onClick:z,className:"text-text-muted hover:text-text-main transition-colors",children:e.jsx(Z,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-border scrollbar-track-transparent",children:[J(),i===1&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full min-h-[400px]",children:[e.jsxs("div",{onClick:()=>{var t;return(t=k.current)==null?void 0:t.click()},className:`
                                    w-full max-w-2xl text-center p-12 rounded-2xl border-2 border-dashed cursor-pointer transition-all duration-300
                                    ${$?"border-primary bg-primary/10 scale-[1.02]":"border-border hover:border-primary/50 hover:bg-surface-highlight"}
                                `,children:[e.jsx("input",{type:"file",ref:k,onChange:L,className:"hidden",accept:"image/*,.pdf"}),e.jsx("div",{className:"bg-primary/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6",children:h?e.jsx(I,{className:"w-10 h-10 text-primary animate-spin"}):e.jsx(ee,{className:"w-10 h-10 text-primary"})}),e.jsx("h3",{className:"text-xl font-bold text-text-main mb-2",children:h?"AI解析中...":"貸借対照表をアップロード"}),e.jsx("p",{className:"text-text-muted mb-6",children:h?"画像を解析してデータを抽出しています":"PDFまたは画像ファイル（JPG/PNG）をドラッグ＆ドロップ"}),!h&&e.jsx("button",{className:"btn-primary px-8 py-3 rounded-full shadow-lg hover:shadow-primary/25",children:"ファイルを選択"})]}),e.jsxs("div",{className:"mt-8 flex items-center w-full max-w-2xl",children:[e.jsx("div",{className:"h-px bg-border flex-1"}),e.jsx("span",{className:"px-4 text-text-muted text-sm",children:"または"}),e.jsx("div",{className:"h-px bg-border flex-1"})]}),e.jsxs("button",{onClick:G,className:"mt-8 flex items-center text-text-muted hover:text-primary transition-colors font-medium group",children:["手動で入力する",e.jsx(ne,{className:"w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform"})]})]}),i===2&&e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"bg-surface-highlight/30 rounded-lg p-4 mb-6 border border-border/50",children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-main mb-2 flex items-center",children:[e.jsx(te,{className:"w-4 h-4 text-primary mr-2"}),"データ確認・修正"]}),e.jsx("p",{className:"text-sm text-text-muted",children:b?"AI解析によって抽出されたデータです。内容を確認してください。":"手動でデータを入力してください。"}),b&&e.jsxs("div",{className:"mt-3 flex items-center text-xs text-text-muted bg-surface/50 p-2 rounded border border-border",children:[e.jsx(A,{className:"w-3 h-3 mr-2"}),"参照ファイル: ",b.name]})]}),e.jsxs("div",{className:"font-serif bg-white dark:bg-zinc-950 p-8 rounded-xl shadow-inner border border-border/50 text-zinc-900 dark:text-zinc-100",children:[e.jsx("h2",{className:"text-2xl text-center mb-2 font-bold",children:"貸借対照表"}),e.jsxs("div",{className:"text-center text-sm mb-8 flex items-center justify-center gap-2",children:[e.jsx("input",{type:"number",value:a.year,onChange:t=>n("year",t.target.value),className:"w-20 bg-transparent border-b border-zinc-300 text-center font-bold outline-none"}),e.jsx("span",{children:"年12月31日 現在"})]}),e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold border-b-2 border-zinc-500 mb-4 pb-1",children:"資産の部"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"pl-4 text-xs font-bold text-zinc-500 mb-1",children:"【流動資産】"}),e.jsx(o,{label:"現金 及び 預金",value:a.assets_current_cash,onChange:t=>n("assets_current_cash",t),indent:!0}),e.jsx(o,{label:"流動資産合計",value:a.assets_current_total,onChange:t=>n("assets_current_total",t),indent:!0}),e.jsx(o,{label:"資産の部合計",value:a.assets_total,onChange:t=>n("assets_total",t),isBold:!0,isTotal:!0})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold border-b-2 border-zinc-500 mb-4 pb-1",children:"負債の部"}),e.jsx(o,{label:"負債の部合計",value:a.liabilities_total,onChange:t=>n("liabilities_total",t)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold border-b-2 border-zinc-500 mb-4 pb-1",children:"純資産の部"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"pl-4 text-xs font-bold text-zinc-500 mb-1",children:"【株主資本】"}),e.jsx(o,{label:"資 本 金",value:a.net_assets_capital,onChange:t=>n("net_assets_capital",t),indent:!0}),e.jsx("div",{className:"pl-4 text-xs text-zinc-500 py-1",children:"その他利益剰余金"}),e.jsx(o,{label:"繰越利益剰余金",value:a.net_assets_retained_earnings,onChange:t=>n("net_assets_retained_earnings",t),indentPlus:!0}),e.jsx(o,{label:"利益剰余金合計",value:a.net_assets_retained_earnings_total,onChange:t=>n("net_assets_retained_earnings_total",t),indent:!0}),e.jsx(o,{label:"株主資本合計",value:a.net_assets_shareholders_equity,onChange:t=>n("net_assets_shareholders_equity",t),indent:!0,isBold:!0}),e.jsx(o,{label:"純資産の部合計",value:a.net_assets_total,onChange:t=>n("net_assets_total",t),isBold:!0}),e.jsx(o,{label:"負債及び純資産の部合計",value:a.liabilities_and_net_assets_total,onChange:t=>n("liabilities_and_net_assets_total",t),isBold:!0,isTotal:!0})]})]})]}),W&&e.jsxs("div",{className:"mt-6 p-3 bg-red-500/10 border border-red-500/20 rounded-lg flex items-center gap-2 text-red-600 dark:text-red-400 text-xs font-bold",children:[e.jsx(se,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:["資産合計と負債・純資産合計が一致していません（差額: ¥",(a.assets_total-a.liabilities_and_net_assets_total).toLocaleString(),"）"]})]})]})]}),i===3&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full py-12",children:[e.jsx("div",{className:"w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mb-6",children:e.jsx(E,{className:"w-10 h-10 text-green-500"})}),e.jsx("h3",{className:"text-2xl font-bold text-text-main mb-2",children:"インポート完了"}),e.jsxs("p",{className:"text-text-muted mb-8 text-center max-w-md",children:["貸借対照表データの保存が完了しました。",e.jsx("br",{}),"経営分析の比較データとして利用されます。"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:z,className:"btn-ghost",children:"閉じる"}),e.jsx("button",{onClick:M,className:"btn-primary",children:"続けてインポートする"})]})]})]}),i===2&&e.jsxs("div",{className:"px-6 py-4 border-t border-border flex items-center justify-between bg-surface-highlight/30",children:[e.jsxs("button",{onClick:()=>d(1),className:"flex items-center text-text-muted hover:text-text-main transition-colors",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("button",{onClick:Y,disabled:C,className:"btn-primary min-w-[140px]",children:C?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"保存して完了"]})})]})]})})};export{_e as B};
