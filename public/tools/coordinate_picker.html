<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFÂ∫ßÊ®ô„Ç≠„É£„É™„Éñ„É¨„Éº„Çø„Éº - Ë§áÊï∞„Éö„Éº„Ç∏ÂØæÂøú</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .pdf-panel {
            flex: 1;
            overflow: auto;
            position: relative;
            padding: 20px;
            background: #16213e;
        }

        .sidebar {
            width: 400px;
            background: #0f3460;
            padding: 15px;
            overflow-y: auto;
        }

        h1 {
            color: #e94560;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        h2 {
            color: #0abde3;
            margin: 10px 0 6px;
            font-size: 0.9em;
            border-bottom: 1px solid #2a4a6a;
            padding-bottom: 4px;
        }

        .canvas-wrapper {
            position: relative;
            display: inline-block;
        }

        #pdfCanvas {
            border: 2px solid #e94560;
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.3);
        }

        .draggable-point {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: white;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            transition: transform 0.1s, box-shadow 0.1s;
            z-index: 100;
        }

        .draggable-point:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .draggable-point.dragging {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            z-index: 1000;
        }

        .draggable-point.digit {
            background: #e94560;
        }

        .draggable-point.text {
            background: #10ac84;
        }

        .draggable-point.selected {
            border: 3px solid #f1c40f;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            color: #aaa;
            font-size: 0.8em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #1a1a2e;
            color: #fff;
            font-size: 0.9em;
        }

        button {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 3px 0;
            width: 100%;
            transition: all 0.2s;
            font-size: 0.85em;
        }

        button:hover {
            transform: scale(1.02);
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-success {
            background: #10ac84;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: #1a1a2e;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .field-list {
            max-height: 180px;
            overflow-y: auto;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 6px;
        }

        .field-item {
            display: flex;
            align-items: center;
            padding: 4px;
            margin: 2px 0;
            border-radius: 4px;
            background: #2a3a5a;
            font-size: 0.7em;
            cursor: pointer;
        }

        .field-item:hover {
            background: #3a4a6a;
        }

        .field-item.selected {
            background: #f39c1233;
            border: 1px solid #f39c12;
        }

        .field-item .num {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            font-size: 7px;
            font-weight: bold;
            color: white;
        }

        .field-item .num.digit {
            background: #e94560;
        }

        .field-item .num.text {
            background: #10ac84;
        }

        #output {
            background: #1a1a2e;
            padding: 6px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.55em;
            white-space: pre-wrap;
            max-height: 120px;
            overflow-y: auto;
        }

        .instructions {
            background: rgba(10, 189, 227, 0.1);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.75em;
            line-height: 1.3;
        }

        .selected-info {
            background: #f39c1233;
            padding: 6px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        .tax-type-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .tax-type-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-size: 0.8em;
            background: #2a3a5a;
            border: 2px solid transparent;
            cursor: pointer;
            border-radius: 6px;
        }

        .tax-type-tab.active {
            border-color: #e94560;
            background: #e9456033;
        }

        .doc-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .doc-btn {
            padding: 6px 4px;
            font-size: 0.7em;
            background: #2a3a5a;
            border: 2px solid transparent;
            border-radius: 4px;
        }

        .doc-btn.active {
            border-color: #e94560;
            background: #e9456033;
        }

        .legend {
            display: flex;
            gap: 10px;
            margin-bottom: 6px;
            font-size: 0.7em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .legend-item .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .add-field {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 5px;
            margin-bottom: 6px;
        }

        .add-field input {
            padding: 6px;
            font-size: 0.8em;
        }

        .add-field select {
            width: 65px;
            padding: 6px;
        }

        .page-nav {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            background: #2a3a5a;
            padding: 8px;
            border-radius: 8px;
        }

        .page-nav button {
            width: auto;
            padding: 6px 12px;
            margin: 0;
        }

        .page-nav span {
            font-size: 0.85em;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="pdf-panel">
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="pdfCanvas"></canvas>
            </div>
        </div>

        <div class="sidebar">
            <h1>üìç Â∫ßÊ®ô„Ç≠„É£„É™„Éñ„É¨„Éº„Çø„Éº</h1>

            <div class="instructions">
                1. Á®éÁ®ÆÈ°û„ÇíÈÅ∏Êäû ‚Üí 2. Êõ∏È°û ‚Üí 3. PDFË™≠Ëæº ‚Üí 4. „Éâ„É©„ÉÉ„Ç∞Ë™øÊï¥ ‚Üí 5. „Ç®„ÇØ„Çπ„Éù„Éº„Éà
            </div>

            <h2>üè¢ Á®éÁ®ÆÈ°û</h2>
            <div class="tax-type-tabs">
                <div class="tax-type-tab active" data-type="corporate">Ê≥ï‰∫∫Á®é</div>
                <div class="tax-type-tab" data-type="personal">ÊâÄÂæóÁ®é</div>
            </div>

            <h2>üìÑ Êõ∏È°ûÈÅ∏Êäû</h2>
            <div class="doc-selector" id="docSelector"></div>

            <div class="input-group">
                <label>PDF„Éï„Ç°„Ç§„É´:</label>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>

            <!-- „Éö„Éº„Ç∏„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <div class="page-nav" id="pageNav" style="display:none;">
                <button class="btn-info" id="prevPage">‚óÄ</button>
                <span>„Éö„Éº„Ç∏ <span id="currentPage">1</span> / <span id="totalPages">1</span></span>
                <button class="btn-info" id="nextPage">‚ñ∂</button>
            </div>

            <button class="btn-warning" id="showPoints">üìç ÁÇπ„ÇíË°®Á§∫</button>

            <div class="selected-info" id="selectedInfo" style="display:none;">
                <strong>ÈÅ∏Êäû:</strong> <span id="selectedName">-</span> (<span id="selectedCoords">-</span>)
            </div>

            <h2>‚ûï „Éï„Ç£„Éº„É´„ÉâËøΩÂä†</h2>
            <div class="add-field">
                <input type="text" id="newFieldName" placeholder="„Éï„Ç£„Éº„É´„ÉâÂêç">
                <select id="newFieldType">
                    <option value="digit">Êï∞Â≠ó</option>
                    <option value="text">„ÉÜ„Ç≠„Çπ„Éà</option>
                </select>
            </div>
            <button class="btn-info" id="addFieldBtn">Ôºã ËøΩÂä†</button>

            <h2>üìã „Éï„Ç£„Éº„É´„Éâ (<span id="fieldCount">0</span>)</h2>
            <div class="legend">
                <div class="legend-item">
                    <div class="dot" style="background:#e94560"></div> Êï∞Â≠ó
                </div>
                <div class="legend-item">
                    <div class="dot" style="background:#10ac84"></div> „ÉÜ„Ç≠„Çπ„Éà
                </div>
            </div>
            <div class="field-list" id="fieldList"></div>

            <h2>üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà / „Ç§„É≥„Éù„Éº„Éà</h2>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                <button class="btn-success" id="exportJson">üì• JSON„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                <button class="btn-info" id="importJsonBtn">üì§ JSON„Ç§„É≥„Éù„Éº„Éà</button>
            </div>
            <input type="file" id="importJsonFile" accept=".json" style="display: none;">
            <button class="btn-secondary" id="exportCoords" style="font-size: 0.8em; padding: 6px 10px;">üìã
                „Ç≥„Éº„Éâ„Ç≥„Éî„Éº</button>
            <div id="output">Êõ∏È°û„ÇíÈÅ∏Êäû„Åó„Å¶PDF„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let scale = 1.5;
        let pdfWidth = 0;
        let pdfHeight = 0;
        let currentTaxType = 'corporate';
        let currentDoc = 'beppyo1';
        let currentPageNum = 1;
        let totalPages = 1;
        let isDragging = false;

        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('canvasWrapper');

        // ===== CORPORATE TAX FORMS (Ê≥ï‰∫∫Á®é) =====
        const corporateForms = {
            beppyo1: {
                name: 'Âà•Ë°®‰∏Ä',
                pages: 1,
                fields: {
                    1: [
                        { id: 'ÊâÄÂæóÈáëÈ°ç_row1', type: 'digit', x: 292.7, y: 568.6, label: '1' },
                        { id: 'Ê≥ï‰∫∫Á®éÈ°ç_row2', type: 'digit', x: 293.3, y: 549.9, label: '2' },
                        { id: 'ÁâπÂà•ÊéßÈô§È°ç_row3', type: 'digit', x: 293.3, y: 533.3, label: '3' },
                        { id: 'Á®éÈ°çÊéßÈô§_row4', type: 'digit', x: 293.3, y: 514.6, label: '4' },
                        { id: 'Âà©Â≠êÁ®é_row5', type: 'digit', x: 292, y: 496.6, label: '5' },
                        { id: 'ÊéßÈô§Á®éÈ°ç_row6', type: 'digit', x: 292.7, y: 479.3, label: '6' },
                        { id: 'Áïô‰øùÈáëÈ°ç_row7', type: 'digit', x: 292.7, y: 460.6, label: '7' },
                        { id: 'Âêå‰∏äÁ®éÈ°ç_row8', type: 'digit', x: 292, y: 441.9, label: '8' },
                        { id: 'Ê≥ï‰∫∫Á®éÈ°çË®à1_row9', type: 'digit', x: 294.7, y: 407.3, label: '9' },
                        { id: 'row10', type: 'digit', x: 294, y: 386.6, label: '10' },
                        { id: 'row11', type: 'digit', x: 293.3, y: 368.6, label: '11' },
                        { id: 'row12', type: 'digit', x: 292.7, y: 351.3, label: '12' },
                        { id: 'Ê≥ï‰∫∫Á®éÈ°çË®à_row28', type: 'digit', x: 293.3, y: 276.1, label: '28' },
                        { id: 'Á®éÂãôÁΩ≤Âêç', type: 'text', x: 114, y: 781.5, label: 'Á®é' },
                        { id: 'Ê≥ï‰∫∫Âêç', type: 'text', x: 85.3, y: 716.1, label: 'Ê≥ï' },
                        { id: '‰ª£Ë°®ËÄÖÊ∞èÂêç', type: 'text', x: 85.3, y: 665.9, label: '‰ª£' },
                    ]
                }
            },
            beppyo4: {
                name: 'Âà•Ë°®Âõõ',
                pages: 1,
                fields: {
                    1: [
                        { id: 'ÂΩìÊúüÂà©Áõä_row1', type: 'digit', x: 450, y: 700, label: '1' },
                        { id: 'Âä†ÁÆó_row2', type: 'digit', x: 450, y: 650, label: '2' },
                        { id: 'Ê∏õÁÆó_row3', type: 'digit', x: 450, y: 600, label: '3' },
                        { id: 'ÊâÄÂæóÈáëÈ°ç_row52', type: 'digit', x: 450, y: 200, label: '52' },
                        { id: 'Ê≥ï‰∫∫Âêç', type: 'text', x: 100, y: 780, label: 'Ê≥ï' },
                    ]
                }
            },
            beppyo5: {
                name: 'Âà•Ë°®‰∫î(‰∏Ä)',
                pages: 1,
                fields: {
                    1: [
                        { id: 'ÊúüÈ¶ñÂà©ÁõäÁ©çÁ´ãÈáë_row1', type: 'digit', x: 400, y: 650, label: '1' },
                        { id: 'ÂΩìÊúüÂ¢ó_row2', type: 'digit', x: 400, y: 600, label: '2' },
                        { id: 'Ê≥ï‰∫∫Âêç', type: 'text', x: 100, y: 780, label: 'Ê≥ï' },
                    ]
                }
            },
            beppyo5_2: {
                name: 'Âà•Ë°®‰∫î(‰∫å)',
                pages: 1,
                fields: {
                    1: [
                        { id: 'ÊúüÈ¶ñÁßüÁ®éÂÖ¨Ë™≤_row1', type: 'digit', x: 400, y: 650, label: '1' },
                        { id: 'ÂΩìÊúüÁô∫Áîü_row2', type: 'digit', x: 400, y: 600, label: '2' },
                        { id: 'ÂΩìÊúüÁ¥ç‰ªò_row3', type: 'digit', x: 400, y: 550, label: '3' },
                        { id: 'Ê≥ï‰∫∫Âêç', type: 'text', x: 100, y: 780, label: 'Ê≥ï' },
                    ]
                }
            },
            beppyo15: {
                name: 'Âà•Ë°®ÂçÅ‰∫î',
                pages: 1,
                fields: {
                    1: [
                        { id: '‰∫§ÈöõË≤ª_row1', type: 'digit', x: 450, y: 650, label: '1' },
                        { id: 'Êé•ÂæÖÈ£≤È£üË≤ª_row2', type: 'digit', x: 450, y: 600, label: '2' },
                        { id: 'Ê≥ï‰∫∫Âêç', type: 'text', x: 100, y: 780, label: 'Ê≥ï' },
                    ]
                }
            },
            beppyo16: {
                name: 'Âà•Ë°®ÂçÅÂÖ≠',
                pages: 1,
                fields: {
                    1: [
                        { id: 'Ê∏õ‰æ°ÂÑüÂç¥Ë≥áÁî£_row1', type: 'digit', x: 450, y: 700, label: '1' },
                        { id: 'ÂèñÂæó‰æ°È°ç_row2', type: 'digit', x: 450, y: 650, label: '2' },
                        { id: 'ÂÑüÂç¥È°ç_row3', type: 'digit', x: 450, y: 600, label: '3' },
                        { id: 'Ê≥ï‰∫∫Âêç', type: 'text', x: 100, y: 780, label: 'Ê≥ï' },
                    ]
                }
            },
            beppyo16_2: {
                name: 'Âà•Ë°®ÂçÅÂÖ≠(‰∫å)',
                pages: 1,
                fields: {
                    1: [
                        { id: 'Ê∏õ‰æ°ÂÑüÂç¥Ë≥áÁî£_row1', type: 'digit', x: 450, y: 700, label: '1' },
                        { id: 'ÂèñÂæó‰æ°È°ç_row2', type: 'digit', x: 450, y: 650, label: '2' },
                        { id: 'ÂÑüÂç¥È°ç_row3', type: 'digit', x: 450, y: 600, label: '3' },
                        { id: 'Ê≥ï‰∫∫Âêç', type: 'text', x: 100, y: 780, label: 'Ê≥ï' },
                    ]
                }
            }
        };

        // ===== PERSONAL TAX FORMS (ÊâÄÂæóÁ®é„ÉªÂÄã‰∫∫) =====
        const personalForms = {
            kakutei_1_2: {
                name: 'Á¢∫ÂÆöÁî≥ÂëäÊõ∏ Á¨¨‰∏ÄË°®„ÉªÁ¨¨‰∫åË°®',
                pages: 2,
                fields: {
                    // ===== Á¨¨‰∏ÄË°® („Éö„Éº„Ç∏1) =====
                    1: [
                        // ÂèéÂÖ•ÈáëÈ°ç
                        { id: '‰∫ãÊ•≠ÂèéÂÖ•_„Ç¢', type: 'digit', x: 480, y: 720, label: '„Ç¢' },
                        { id: 'Áµ¶‰∏éÂèéÂÖ•_„Ç´', type: 'digit', x: 480, y: 680, label: '„Ç´' },
                        { id: 'ÈõëÂèéÂÖ•_„ÇØ', type: 'digit', x: 480, y: 640, label: '„ÇØ' },
                        { id: 'ÂèéÂÖ•ÂêàË®à_‚ë´', type: 'digit', x: 480, y: 600, label: '‚ë´' },
                        // ÊâÄÂæóÈáëÈ°ç
                        { id: '‰∫ãÊ•≠ÊâÄÂæó_‚ë†', type: 'digit', x: 480, y: 540, label: '‚ë†' },
                        { id: 'Áµ¶‰∏éÊâÄÂæó_‚ë•', type: 'digit', x: 480, y: 500, label: '‚ë•' },
                        { id: 'ÊâÄÂæóÂêàË®à_‚ë´', type: 'digit', x: 480, y: 460, label: '‚ë´' },
                        // ÊâÄÂæóÊéßÈô§
                        { id: 'Âü∫Á§éÊéßÈô§_„ä≤', type: 'digit', x: 480, y: 380, label: '„ä≤' },
                        { id: 'Á§æ‰ºö‰øùÈô∫ÊñôÊéßÈô§_‚ë¨', type: 'digit', x: 480, y: 340, label: '‚ë¨' },
                        { id: 'ÊéßÈô§ÂêàË®à_„âï', type: 'digit', x: 480, y: 300, label: '„âï' },
                        // Á®éÈ°çË®àÁÆó
                        { id: 'Ë™≤Á®éÊâÄÂæó_„âñ', type: 'digit', x: 480, y: 260, label: '„âñ' },
                        { id: 'ÊâÄÂæóÁ®éÈ°ç_„âó', type: 'digit', x: 480, y: 220, label: '„âó' },
                        { id: 'Áî≥ÂëäÁ¥çÁ®éÈ°ç_„ä∑', type: 'digit', x: 480, y: 140, label: '„ä∑' },
                        // „Éò„ÉÉ„ÉÄ„Éº
                        { id: 'Ê∞èÂêç', type: 'text', x: 100, y: 780, label: 'Ê∞è' },
                        { id: '‰ΩèÊâÄ', type: 'text', x: 100, y: 750, label: '‰Ωè' },
                        { id: 'Á®éÂãôÁΩ≤Âêç', type: 'text', x: 100, y: 810, label: 'Á®é' },
                    ],
                    // ===== Á¨¨‰∫åË°® („Éö„Éº„Ç∏2) =====
                    2: [
                        // Ê∫êÊ≥âÂæ¥ÂèéÁ®éÈ°ç
                        { id: 'Ê∫êÊ≥â_Áµ¶‰∏é', type: 'digit', x: 350, y: 650, label: 'Ê∫êÁµ¶' },
                        { id: 'Ê∫êÊ≥â_Âπ¥Èáë', type: 'digit', x: 350, y: 600, label: 'Ê∫êÂπ¥' },
                        // Á§æ‰ºö‰øùÈô∫Êñô
                        { id: 'Á§æ‰øù_ÂõΩÊ∞ëÂÅ•Â∫∑', type: 'digit', x: 350, y: 500, label: 'ÂõΩÂÅ•' },
                        { id: 'Á§æ‰øù_ÂõΩÊ∞ëÂπ¥Èáë', type: 'digit', x: 350, y: 450, label: 'ÂõΩÂπ¥' },
                        // ÁîüÂëΩ‰øùÈô∫Êñô
                        { id: 'ÁîüÂëΩ‰øùÈô∫_‰∏ÄËà¨', type: 'digit', x: 350, y: 350, label: 'Áîü‰∏Ä' },
                        { id: 'ÁîüÂëΩ‰øùÈô∫_ÂÄã‰∫∫Âπ¥Èáë', type: 'digit', x: 350, y: 300, label: 'ÁîüÂπ¥' },
                        // „Éò„ÉÉ„ÉÄ„Éº
                        { id: 'Ê∞èÂêç_2Ë°®', type: 'text', x: 100, y: 780, label: 'Ê∞è' },
                    ]
                }
            },
            aoiro_kessan: {
                name: 'ÈùíËâ≤Áî≥ÂëäÊ±∫ÁÆóÊõ∏',
                pages: 4,
                fields: {
                    1: [
                        { id: 'Â£≤‰∏äÈáëÈ°ç', type: 'digit', x: 450, y: 700, label: 'Â£≤' },
                        { id: 'Â£≤‰∏äÂéü‰æ°', type: 'digit', x: 450, y: 650, label: 'Âéü' },
                        { id: 'ÁµåË≤ªÂêàË®à', type: 'digit', x: 450, y: 400, label: 'Áµå' },
                        { id: 'ÈùíËâ≤Áî≥ÂëäÁâπÂà•ÊéßÈô§', type: 'digit', x: 450, y: 200, label: 'Èùí' },
                        { id: 'ÊâÄÂæóÈáëÈ°ç', type: 'digit', x: 450, y: 150, label: 'ÊâÄ' },
                        { id: 'Â±ãÂè∑', type: 'text', x: 100, y: 780, label: 'Â±ã' },
                        { id: 'Ê∞èÂêç', type: 'text', x: 300, y: 780, label: 'Ê∞è' },
                    ],
                    2: [],
                    3: [],
                    4: []
                }
            },
            uchiwake: {
                name: 'ÊâÄÂæó„ÅÆÂÜÖË®≥Êõ∏',
                pages: 1,
                fields: {
                    1: [
                        { id: 'ÊâÄÂæóÁ®ÆÈ°û_1', type: 'text', x: 100, y: 650, label: 'Á®Æ1' },
                        { id: 'ÂèéÂÖ•ÈáëÈ°ç_1', type: 'digit', x: 350, y: 650, label: 'Âèé1' },
                        { id: 'Ê∫êÊ≥âÂæ¥ÂèéÁ®éÈ°ç_1', type: 'digit', x: 480, y: 650, label: 'Ê∫ê1' },
                        { id: 'ÊâÄÂæóÁ®ÆÈ°û_2', type: 'text', x: 100, y: 600, label: 'Á®Æ2' },
                        { id: 'ÂèéÂÖ•ÈáëÈ°ç_2', type: 'digit', x: 350, y: 600, label: 'Âèé2' },
                        { id: 'Ê∞èÂêç', type: 'text', x: 100, y: 780, label: 'Ê∞è' },
                    ]
                }
            },
            shushi: {
                name: 'ÂèéÊîØÂÜÖË®≥Êõ∏',
                pages: 2,
                fields: {
                    1: [
                        { id: 'Â£≤‰∏äÈáëÈ°ç', type: 'digit', x: 450, y: 700, label: 'Â£≤' },
                        { id: '‰ªïÂÖ•ÈáëÈ°ç', type: 'digit', x: 450, y: 650, label: '‰ªï' },
                        { id: 'ÁµåË≤ªÂêàË®à', type: 'digit', x: 450, y: 400, label: 'Áµå' },
                        { id: 'ÊâÄÂæóÈáëÈ°ç', type: 'digit', x: 450, y: 200, label: 'ÊâÄ' },
                        { id: 'Â±ãÂè∑', type: 'text', x: 100, y: 780, label: 'Â±ã' },
                        { id: 'Ê∞èÂêç', type: 'text', x: 300, y: 780, label: 'Ê∞è' },
                    ],
                    2: []
                }
            }
        };

        function getCurrentForms() {
            return currentTaxType === 'corporate' ? corporateForms : personalForms;
        }

        function getCurrentFormConfig() {
            return getCurrentForms()[currentDoc];
        }

        function getCurrentFields() {
            const config = getCurrentFormConfig();
            return config?.fields[currentPageNum] || [];
        }

        function renderDocSelector() {
            const forms = getCurrentForms();
            const selector = document.getElementById('docSelector');
            selector.innerHTML = '';

            Object.keys(forms).forEach((key, i) => {
                const btn = document.createElement('button');
                btn.className = `doc-btn${i === 0 ? ' active' : ''}`;
                btn.dataset.doc = key;
                btn.textContent = forms[key].name;
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.doc-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDoc = key;
                    currentPageNum = 1;
                    clearPoints();
                    updatePageNav();
                    renderFieldList();
                });
                selector.appendChild(btn);
            });

            currentDoc = Object.keys(forms)[0];
            updatePageNav();
            renderFieldList();
        }

        function updatePageNav() {
            const config = getCurrentFormConfig();
            // PDF„Åå„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂÆüÈöõ„ÅÆ„Éö„Éº„Ç∏Êï∞„Çí‰ΩøÁî®
            if (pdfDoc) {
                totalPages = pdfDoc.numPages;
                // „Éï„Ç©„Éº„É†Ë®≠ÂÆö„ÇÇÊõ¥Êñ∞
                if (config && totalPages > config.pages) {
                    config.pages = totalPages;
                    for (let i = 1; i <= totalPages; i++) {
                        if (!config.fields[i]) config.fields[i] = [];
                    }
                }
            } else {
                totalPages = config?.pages || 1;
            }

            const pageNav = document.getElementById('pageNav');
            if (totalPages > 1) {
                pageNav.style.display = 'flex';
                document.getElementById('currentPage').textContent = currentPageNum;
                document.getElementById('totalPages').textContent = totalPages;
            } else {
                pageNav.style.display = 'none';
            }
        }

        // Page navigation
        document.getElementById('prevPage').addEventListener('click', async () => {
            if (currentPageNum > 1) {
                currentPageNum--;
                await renderPage();
                updatePageNav();
                clearPoints();
                createPoints();
            }
        });

        document.getElementById('nextPage').addEventListener('click', async () => {
            if (currentPageNum < totalPages) {
                currentPageNum++;
                await renderPage();
                updatePageNav();
                clearPoints();
                createPoints();
            }
        });

        // Tax type tabs
        document.querySelectorAll('.tax-type-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tax-type-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTaxType = tab.dataset.type;
                currentPageNum = 1;
                renderDocSelector();
                clearPoints();
            });
        });

        // Load PDF
        document.getElementById('pdfFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            totalPages = pdfDoc.numPages;

            // Update form config if PDF has more pages
            const config = getCurrentFormConfig();
            if (config && totalPages > config.pages) {
                config.pages = totalPages;
                for (let i = 1; i <= totalPages; i++) {
                    if (!config.fields[i]) config.fields[i] = [];
                }
            }

            await renderPage();
            updatePageNav();
            renderFieldList();
        });

        async function renderPage() {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(currentPageNum);
            const viewport = page.getViewport({ scale });
            pdfWidth = page.getViewport({ scale: 1 }).width;
            pdfHeight = page.getViewport({ scale: 1 }).height;
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: ctx, viewport }).promise;
        }

        function pdfToScreen(x, y) {
            return { left: x * scale, top: (pdfHeight - y) * scale };
        }

        function screenToPdf(left, top) {
            return { x: left / scale, y: pdfHeight - (top / scale) };
        }

        function clearPoints() {
            document.querySelectorAll('.draggable-point').forEach(el => el.remove());
        }

        function createPoints() {
            clearPoints();
            const fields = getCurrentFields();

            fields.forEach((field, index) => {
                const pos = pdfToScreen(field.x, field.y);
                const point = document.createElement('div');
                point.className = `draggable-point ${field.type}`;
                point.textContent = field.label;
                point.style.left = pos.left + 'px';
                point.style.top = pos.top + 'px';
                point.dataset.index = index;
                point.addEventListener('mousedown', startDrag);
                wrapper.appendChild(point);
            });

            renderFieldList();
        }

        function startDrag(e) {
            e.preventDefault();
            const point = e.target;
            const index = parseInt(point.dataset.index);
            const fields = getCurrentFields();

            isDragging = true;
            point.classList.add('dragging', 'selected');

            document.querySelectorAll('.draggable-point').forEach(p => {
                if (p !== point) p.classList.remove('selected');
            });
            document.querySelectorAll('.field-item').forEach(item => {
                item.classList.toggle('selected', parseInt(item.dataset.index) === index);
            });

            updateSelectedInfo(fields[index]);

            const onMouseMove = (e) => {
                if (!isDragging) return;
                const rect = wrapper.getBoundingClientRect();
                const left = Math.max(0, Math.min(e.clientX - rect.left, canvas.width));
                const top = Math.max(0, Math.min(e.clientY - rect.top, canvas.height));

                point.style.left = left + 'px';
                point.style.top = top + 'px';

                const pdfCoords = screenToPdf(left, top);
                fields[index].x = Math.round(pdfCoords.x * 10) / 10;
                fields[index].y = Math.round(pdfCoords.y * 10) / 10;

                updateSelectedInfo(fields[index]);
            };

            const onMouseUp = () => {
                isDragging = false;
                point.classList.remove('dragging');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                renderFieldList();
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function updateSelectedInfo(field) {
            document.getElementById('selectedInfo').style.display = 'block';
            document.getElementById('selectedName').textContent = field.id;
            document.getElementById('selectedCoords').textContent = `${field.x}, ${field.y}`;
        }

        function renderFieldList() {
            const fields = getCurrentFields();
            const list = document.getElementById('fieldList');
            document.getElementById('fieldCount').textContent = fields.length;

            list.innerHTML = fields.map((f, i) => `
                <div class="field-item" data-index="${i}">
                    <div class="num ${f.type}">${f.label}</div>
                    <span>${f.id}</span>
                    <span style="margin-left:auto;color:#888;font-family:monospace;font-size:0.85em;">(${f.x}, ${f.y})</span>
                </div>
            `).join('');

            list.querySelectorAll('.field-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    const point = document.querySelector(`.draggable-point[data-index="${index}"]`);
                    if (point) {
                        document.querySelectorAll('.draggable-point').forEach(p => p.classList.remove('selected'));
                        document.querySelectorAll('.field-item').forEach(i => i.classList.remove('selected'));
                        point.classList.add('selected');
                        item.classList.add('selected');
                        updateSelectedInfo(fields[index]);
                    }
                });
            });
        }

        // Add field
        document.getElementById('addFieldBtn').addEventListener('click', () => {
            const name = document.getElementById('newFieldName').value.trim();
            const type = document.getElementById('newFieldType').value;
            if (!name) { alert('„Éï„Ç£„Éº„É´„ÉâÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

            const fields = getCurrentFields();
            const newLabel = type === 'digit' ? String(fields.length + 1) : name.charAt(0);
            fields.push({ id: name, type: type, x: 300, y: 400, label: newLabel });

            document.getElementById('newFieldName').value = '';
            createPoints();
        });

        document.getElementById('showPoints').addEventListener('click', () => {
            if (!pdfDoc) { alert('PDF„ÇíÂÖà„Å´Ë™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ'); return; }
            createPoints();
        });

        // Export - now exports all pages
        document.getElementById('exportCoords').addEventListener('click', () => {
            const config = getCurrentFormConfig();
            const docName = currentDoc.toUpperCase();

            let output = `// ===== ${docName} COORDINATE CONFIG =====\n`;
            output += `// Total pages: ${config.pages}\n\n`;

            for (let page = 1; page <= config.pages; page++) {
                const fields = config.fields[page] || [];
                if (fields.length === 0) continue;

                const digitFields = fields.filter(f => f.type === 'digit');
                const textFields = fields.filter(f => f.type === 'text');

                output += `// ===== PAGE ${page} =====\n`;
                output += `export const ${docName}_PAGE${page}_FIELDS: { [key: string]: DigitBoxConfig } = {\n`;

                digitFields.forEach(f => {
                    output += `    '${f.id}': { anchorX: ${f.x}, anchorY: ${f.y}, boxWidth: 16, boxSpacing: 16, fontSize: 10, maxDigits: 12 },\n`;
                });

                output += '};\n\n';
                output += `export const ${docName}_PAGE${page}_TEXT: { [key: string]: TextFieldConfig } = {\n`;

                textFields.forEach(f => {
                    output += `    '${f.id}': { x: ${f.x}, y: ${f.y}, fontSize: 9 },\n`;
                });

                output += '};\n\n';
            }

            document.getElementById('output').textContent = output;
        });

        // JSON Export - Download coordinates as JSON file
        document.getElementById('exportJson').addEventListener('click', () => {
            const allConfigs = {};

            // Export all corporate forms
            Object.keys(corporateForms).forEach(key => {
                allConfigs[key] = corporateForms[key];
            });

            // Export all personal forms
            Object.keys(personalForms).forEach(key => {
                allConfigs[key] = personalForms[key];
            });

            const jsonData = {
                version: '1.0',
                exportedAt: new Date().toISOString(),
                configs: allConfigs
            };

            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `coordinate_config_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            document.getElementById('output').textContent = '‚úÖ JSON„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü';
        });

        // JSON Import - Load coordinates from JSON file
        document.getElementById('importJsonBtn').addEventListener('click', () => {
            document.getElementById('importJsonFile').click();
        });

        document.getElementById('importJsonFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const jsonData = JSON.parse(event.target.result);

                    if (!jsonData.configs) {
                        throw new Error('Invalid config format: missing configs property');
                    }

                    let importedCount = 0;

                    // Import corporate forms
                    Object.keys(jsonData.configs).forEach(key => {
                        const config = jsonData.configs[key];
                        if (corporateForms[key]) {
                            corporateForms[key] = config;
                            importedCount++;
                        } else if (personalForms[key]) {
                            personalForms[key] = config;
                            importedCount++;
                        }
                    });

                    // Refresh display
                    if (pdfDoc) {
                        createPoints();
                    }
                    renderFieldList();

                    document.getElementById('output').textContent = `‚úÖ ${importedCount}‰ª∂„ÅÆÂ∫ßÊ®ôË®≠ÂÆö„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü\n(${jsonData.exportedAt || 'unknown date'}„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà)`;
                } catch (err) {
                    alert('JSON„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset for re-import
        });

        // Initialize
        renderDocSelector();
    </script>
</body>

</html>