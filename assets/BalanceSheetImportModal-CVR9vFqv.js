import{r as o,j as e,F as E,X as ee,U as te,S as se,x as ae,d as P,G as m}from"./index-BcSqN67S.js";import{s as re,a as I}from"./PreviousYearImportModal-BqgBtYWD.js";import{analyzeBSDocumentWithVision as ne}from"./geminiAIService-DQoIspWT.js";import{L as R}from"./loader-circle-zlJjn_E2.js";import{A as le}from"./arrow-right-BEJ899Mp.js";import{A as ie}from"./arrow-left-DdT9VhUy.js";import{S as oe}from"./save-BCLCohis.js";const be=({isOpen:y,onClose:z,userId:u,businessType:_,onImportSuccess:$})=>{const i=_==="corporation",[c,x]=o.useState(1),[h,g]=o.useState(!1),[k,j]=o.useState(!1),[L,N]=o.useState(!1),[b,v]=o.useState(null),D=o.useRef(null),[s,f]=o.useState({user_id:u,business_type:_,year:new Date().getFullYear()-1,assets_current_cash:0,assets_current_receivable:0,assets_current_inventory:0,assets_current_total:0,assets_fixed_total:0,assets_total:0,liabilities_current_payable:0,liabilities_short_term_loans:0,liabilities_long_term_loans:0,liabilities_total:0,net_assets_capital:0,net_assets_retained_earnings:0,net_assets_retained_earnings_total:0,net_assets_shareholders_equity:0,net_assets_total:0,liabilities_and_net_assets_total:0,metadata:{},document_path:void 0,status:"draft"});if(o.useEffect(()=>{y&&(x(1),v(null),g(!1),j(!1),f({user_id:u,business_type:_,year:new Date().getFullYear()-1,assets_current_cash:0,assets_current_receivable:0,assets_current_inventory:0,assets_current_total:0,assets_fixed_total:0,assets_total:0,liabilities_current_payable:0,liabilities_short_term_loans:0,liabilities_long_term_loans:0,liabilities_total:0,net_assets_capital:0,net_assets_retained_earnings:0,net_assets_retained_earnings_total:0,net_assets_shareholders_equity:0,net_assets_total:0,liabilities_and_net_assets_total:0,metadata:{},document_path:void 0,status:"draft"}))},[y,u,_]),!y)return null;const F=async t=>{if(!t)return;const a=t.type.startsWith("image/"),l=t.type==="application/pdf";if(!a&&!l){m.error("画像またはPDFファイルを選択してください");return}v(t),g(!0);try{const d=new FileReader;d.onloadend=async()=>{const w=d.result,p=await ne(w);if(p){const S=I.mapAiResultToBS(p,u,_,{fileName:t.name});f(S),x(2),m.success("解析が完了しました。内容を確認してください。")}else m.error("解析に失敗しました。数値を直接入力してください。"),x(2);g(!1)},d.readAsDataURL(t)}catch(d){console.error("BS Analysis Error:",d),m.error("解析中にエラーが発生しました"),g(!1),x(2)}},q=t=>{var l;const a=(l=t.target.files)==null?void 0:l[0];a&&F(a)},U=t=>{t.preventDefault(),t.stopPropagation(),!h&&c===1&&N(!0)},V=t=>{t.preventDefault(),t.stopPropagation(),N(!1)},Y=t=>{var a;if(t.preventDefault(),t.stopPropagation(),N(!1),!h&&c===1){const l=(a=t.dataTransfer.files)==null?void 0:a[0];l&&F(l)}},r=(t,a)=>{let l=typeof a=="string"?parseInt(a)||0:a;f(d=>({...d,[t]:l}))},G=async()=>{j(!0);try{let t;if(b)try{m.loading("ファイルをアップロード中...",{id:"upload-toast"}),t=await re.uploadFinancialDocument(u,b,s.year,"bs"),t&&m.success("ファイルのアップロード完了",{id:"upload-toast"})}catch(l){console.error("File Upload Error:",l),m.error("ファイルのアップロードに失敗しました",{id:"upload-toast"})}const a={...s,document_path:t||s.document_path};await I.save(a),$(),x(3),j(!1)}catch(t){console.error("Save BS Error:",t),m.error("保存に失敗しました"),j(!1)}},M=()=>{v(null),f({...s,year:new Date().getFullYear()-1}),x(2)},T=()=>{x(1),v(null),f({user_id:u,business_type:_,year:new Date().getFullYear()-1,assets_current_cash:0,assets_current_receivable:0,assets_current_inventory:0,assets_current_total:0,assets_fixed_total:0,assets_total:0,liabilities_current_payable:0,liabilities_short_term_loans:0,liabilities_long_term_loans:0,liabilities_total:0,net_assets_capital:0,net_assets_retained_earnings:0,net_assets_retained_earnings_total:0,net_assets_shareholders_equity:0,net_assets_total:0,liabilities_and_net_assets_total:0,metadata:{},document_path:void 0,status:"draft"})},W=t=>{const a=t<0,l=Math.abs(t);return(a?"△":"")+l.toLocaleString()},n=({label:t,value:a,onChange:l,indent:d=!1,indentPlus:w=!1,isBold:p=!1,isTotal:S=!1})=>{const[H,B]=o.useState(!1),[A,C]=o.useState(a.toString());o.useEffect(()=>{C(a.toString())},[a]);const K=()=>{B(!1),l(parseInt(A)||0)},O=()=>{C(a.toString()),B(!0)},Q=W(a);return e.jsxs("div",{className:`flex justify-between items-end border-b ${S?"border-zinc-800 border-b-2":"border-zinc-200"} py-1.5 group transition-colors hover:bg-zinc-50 dark:hover:bg-zinc-900/50`,children:[e.jsx("div",{className:`${d?"pl-4":w?"pl-8":""} ${p?"font-bold":"text-zinc-700 dark:text-zinc-300"} text-sm`,children:t}),e.jsx("div",{className:"w-36 text-right relative",children:H?e.jsx("input",{type:"number",value:A,onChange:Z=>C(Z.target.value),onBlur:K,autoFocus:!0,className:"w-full bg-white dark:bg-zinc-800 border-b-2 border-primary text-right outline-none font-mono py-0.5 px-1 rounded-t-sm shadow-sm"}):e.jsx("div",{onClick:O,className:`w-full cursor-text text-right font-mono text-sm ${p?"font-bold text-zinc-900 dark:text-zinc-50":"text-zinc-800 dark:text-zinc-200"} ${a<0?"text-error":""} py-0.5 px-1 hover:bg-zinc-200/50 dark:hover:bg-zinc-700/50 rounded transition-colors`,children:Q})})]})},J=s.assets_total!==s.liabilities_and_net_assets_total,X=()=>e.jsx("div",{className:"flex items-center justify-center mb-8",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`
                        flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm
                        ${c>=t?"bg-primary text-white":"bg-surface-highlight text-text-muted"}
                        transition-colors duration-300
                    `,children:c>t?e.jsx(P,{className:"w-5 h-5"}):t}),e.jsxs("span",{className:`ml-2 text-sm font-medium ${c>=t?"text-text-main":"text-text-muted"}`,children:[t===1&&"アップロード",t===2&&"データ確認",t===3&&"完了"]}),t<3&&e.jsx("div",{className:`w-12 h-0.5 mx-4 ${c>t?"bg-primary":"bg-surface-highlight"}`})]},t))});return e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-surface border border-border rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl",onDragOver:U,onDragLeave:V,onDrop:Y,children:[e.jsxs("div",{className:"px-6 py-4 border-b border-border flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-text-main flex items-center",children:[e.jsx(E,{className:"w-5 h-5 mr-2 text-primary"}),i?"貸借対照表（BS）のインポート":"貸借対照表(BS)・所得金額のインポート"]}),e.jsx("button",{onClick:z,className:"text-text-muted hover:text-text-main transition-colors",children:e.jsx(ee,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-border scrollbar-track-transparent",children:[X(),c===1&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full min-h-[400px]",children:[e.jsxs("div",{onClick:()=>{var t;return(t=D.current)==null?void 0:t.click()},className:`
                                    w-full max-w-2xl text-center p-12 rounded-2xl border-2 border-dashed cursor-pointer transition-all duration-300
                                    ${L?"border-primary bg-primary/10 scale-[1.02]":"border-border hover:border-primary/50 hover:bg-surface-highlight"}
                                `,children:[e.jsx("input",{type:"file",ref:D,onChange:q,className:"hidden",accept:"image/*,.pdf"}),e.jsx("div",{className:"bg-primary/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6",children:h?e.jsx(R,{className:"w-10 h-10 text-primary animate-spin"}):e.jsx(te,{className:"w-10 h-10 text-primary"})}),e.jsx("h3",{className:"text-xl font-bold text-text-main mb-2",children:h?"AI解析中...":i?"貸借対照表をアップロード":"青色申告決算書(4枚目)等をアップロード"}),e.jsx("p",{className:"text-text-muted mb-6",children:h?"画像を解析してデータを抽出しています":"PDFまたは画像ファイル（JPG/PNG）をドラッグ＆ドロップ"}),!h&&e.jsx("button",{className:"btn-primary px-8 py-3 rounded-full shadow-lg hover:shadow-primary/25",children:"ファイルを選択"})]}),e.jsxs("div",{className:"mt-8 flex items-center w-full max-w-2xl",children:[e.jsx("div",{className:"h-px bg-border flex-1"}),e.jsx("span",{className:"px-4 text-text-muted text-sm",children:"または"}),e.jsx("div",{className:"h-px bg-border flex-1"})]}),e.jsxs("button",{onClick:M,className:"mt-8 flex items-center text-text-muted hover:text-primary transition-colors font-medium group",children:["手動で入力する",e.jsx(le,{className:"w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform"})]})]}),c===2&&e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"bg-surface-highlight/30 rounded-lg p-4 mb-6 border border-border/50",children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-main mb-2 flex items-center",children:[e.jsx(se,{className:"w-4 h-4 text-primary mr-2"}),"データ確認・修正"]}),e.jsx("p",{className:"text-sm text-text-muted",children:b?"AI解析によって抽出されたデータです。内容を確認してください。":"手動でデータを入力してください。"}),b&&e.jsxs("div",{className:"mt-3 flex items-center text-xs text-text-muted bg-surface/50 p-2 rounded border border-border",children:[e.jsx(E,{className:"w-3 h-3 mr-2"}),"参照ファイル: ",b.name]})]}),e.jsxs("div",{className:"font-serif bg-white dark:bg-zinc-950 p-8 rounded-xl shadow-inner border border-border/50 text-zinc-900 dark:text-zinc-100",children:[e.jsx("h2",{className:"text-2xl text-center mb-2 font-bold",children:i?"貸借対照表":"貸借対照表（元入金・所得）"}),e.jsxs("div",{className:"text-center text-sm mb-8 flex items-center justify-center gap-2",children:[e.jsx("input",{type:"number",value:s.year,onChange:t=>r("year",t.target.value),className:"w-20 bg-transparent border-b border-zinc-300 text-center font-bold outline-none"}),e.jsx("span",{children:"年12月31日時点"})]}),e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold border-b-2 border-zinc-500 mb-4 pb-1",children:"資産の部"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"pl-4 text-xs font-bold text-zinc-500 mb-1",children:"【流動資産】"}),e.jsx(n,{label:"現金 及び 預金",value:s.assets_current_cash,onChange:t=>r("assets_current_cash",t),indent:!0}),e.jsx(n,{label:"売掛金",value:s.assets_current_receivable,onChange:t=>r("assets_current_receivable",t),indent:!0}),e.jsx(n,{label:"棚卸資産（在庫）",value:s.assets_current_inventory,onChange:t=>r("assets_current_inventory",t),indent:!0}),e.jsx(n,{label:"流動資産合計",value:s.assets_current_total,onChange:t=>r("assets_current_total",t),indent:!0}),e.jsx("div",{className:"pl-4 text-xs font-bold text-zinc-500 mb-1 mt-2",children:"【固定資産】"}),e.jsx(n,{label:"固定資産合計",value:s.assets_fixed_total,onChange:t=>r("assets_fixed_total",t),indent:!0}),e.jsx(n,{label:"資産の部合計",value:s.assets_total,onChange:t=>r("assets_total",t),isBold:!0,isTotal:!0})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold border-b-2 border-zinc-500 mb-4 pb-1",children:"負債の部"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"pl-4 text-xs font-bold text-zinc-500 mb-1",children:"【流動負債】"}),e.jsx(n,{label:"買掛金",value:s.liabilities_current_payable,onChange:t=>r("liabilities_current_payable",t),indent:!0}),e.jsx(n,{label:"短期借入金",value:s.liabilities_short_term_loans,onChange:t=>r("liabilities_short_term_loans",t),indent:!0}),e.jsx("div",{className:"pl-4 text-xs font-bold text-zinc-500 mb-1 mt-2",children:"【固定負債】"}),e.jsx(n,{label:"長期借入金",value:s.liabilities_long_term_loans,onChange:t=>r("liabilities_long_term_loans",t),indent:!0}),e.jsx(n,{label:"負債の部合計",value:s.liabilities_total,onChange:t=>r("liabilities_total",t),isBold:!0,isTotal:!0})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold border-b-2 border-zinc-500 mb-4 pb-1",children:i?"純資産の部":"元入金・所得の部"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"pl-4 text-xs font-bold text-zinc-500 mb-1",children:i?"【株主資本】":"【元入金等】"}),e.jsx(n,{label:i?"資 本 金":"元 入 金",value:s.net_assets_capital,onChange:t=>r("net_assets_capital",t),indent:!0}),e.jsx("div",{className:"pl-4 text-xs text-zinc-500 py-1",children:i?"その他利益剰余金":"所得金額"}),e.jsx(n,{label:i?"繰越利益剰余金":"今期純利益",value:s.net_assets_retained_earnings,onChange:t=>r("net_assets_retained_earnings",t),indentPlus:!0}),e.jsx(n,{label:i?"利益剰余金合計":"元入金・所得合計",value:s.net_assets_retained_earnings_total,onChange:t=>r("net_assets_retained_earnings_total",t),indent:!0}),e.jsx(n,{label:i?"株主資本合計":"元入金・所得等合計",value:s.net_assets_shareholders_equity,onChange:t=>r("net_assets_shareholders_equity",t),indent:!0,isBold:!0}),e.jsx(n,{label:i?"純資産の部合計":"元入金・所得等の合計",value:s.net_assets_total,onChange:t=>r("net_assets_total",t),isBold:!0}),e.jsx(n,{label:i?"負債及び純資産の部合計":"負債及び元入金・所得等の合計",value:s.liabilities_and_net_assets_total,onChange:t=>r("liabilities_and_net_assets_total",t),isBold:!0,isTotal:!0})]})]})]}),J&&e.jsxs("div",{className:"mt-6 p-3 bg-red-500/10 border border-red-500/20 rounded-lg flex items-center gap-2 text-red-600 dark:text-red-400 text-xs font-bold",children:[e.jsx(ae,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:["資産合計と負債・純資産合計が一致していません（差額: ¥",(s.assets_total-s.liabilities_and_net_assets_total).toLocaleString(),"）"]})]})]})]}),c===3&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full py-12",children:[e.jsx("div",{className:"w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mb-6",children:e.jsx(P,{className:"w-10 h-10 text-green-500"})}),e.jsx("h3",{className:"text-2xl font-bold text-text-main mb-2",children:"インポート完了"}),e.jsxs("p",{className:"text-text-muted mb-8 text-center max-w-md",children:["貸借対照表データの保存が完了しました。",e.jsx("br",{}),"経営分析の比較データとして利用されます。"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:z,className:"btn-ghost",children:"閉じる"}),e.jsx("button",{onClick:T,className:"btn-primary",children:"続けてインポートする"})]})]})]}),c===2&&e.jsxs("div",{className:"px-6 py-4 border-t border-border flex items-center justify-between bg-surface-highlight/30",children:[e.jsxs("button",{onClick:()=>x(1),className:"flex items-center text-text-muted hover:text-text-main transition-colors",children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("button",{onClick:G,disabled:k,className:"btn-primary min-w-[140px]",children:k?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"保存して完了"]})})]})]})})};export{be as B};
