import{c as R,r as m,s as F,b as X,d as Y,u as Z,j as e,L as ee,P as te,T as re}from"./index-B-if9VQJ.js";import{A as se}from"./arrow-left-DjU9I1l2.js";import{S as ae}from"./square-CbyoZEwl.js";import{S as ne}from"./send-Blhapy4o.js";import{C as P}from"./circle-check-big-Bu7tQ_Co.js";import{D as oe}from"./download-2FUm49l-.js";import{S as ce}from"./save-DAhON3Mo.js";import{P as ie}from"./pen-line-C_BCqA4b.js";/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],I=R("circle",le);/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],me=R("mic",de),xe=p=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(p),ue=(p,h)=>{const[k,w]=m.useState([]),[x,b]=m.useState(!1),u=m.useCallback(()=>h==="corporation"?"corporation_transactions":"individual_transactions",[h]),T=m.useCallback(async()=>{if(!p||!h){b(!1);return}b(!0);const l=u();try{const{data:a,error:c}=await F.from(l).select("*").eq("creator",p).order("date",{ascending:!1});if(c)throw c;w(a||[]),b(!1)}catch(a){console.error(`取引データの取得に失敗しました: ${a}`),w([]),b(!1)}},[p,h,u]),g=async l=>{if(!p||!h)return{data:null,error:new Error("ユーザーIDと業態形態が必要です")};try{xe(l.creator)||(console.warn("無効なcreator IDが検出されました。匿名ユーザーとして処理します。"),l.creator="00000000-0000-0000-0000-000000000000");const a={...l,creator:l.creator||"00000000-0000-0000-0000-000000000000"},c=u(),{data:f,error:i}=await F.from(c).insert(a).select().single();if(i)throw i;const N=f;return w(C=>[N,...C]),{data:N,error:null}}catch(a){return console.error("取引の作成に失敗しました:",a),a.message&&a.message.includes("Failed to fetch")?{data:null,error:new Error("ネットワークエラーが発生しました。インターネット接続を確認してください。")}:{data:null,error:a}}},v=async(l,a)=>{if(!p||!h)return{data:null,error:new Error("ユーザーIDと業態形態が必要です")};try{const c=u(),{data:f,error:i}=await F.from(c).update(a).eq("id",l).select().single();if(i)throw i;const N=f;return w(C=>C.map(L=>L.id===l?N:L)),{data:N,error:null}}catch(c){return console.error("取引の更新に失敗しました:",c),{data:null,error:c}}},D=async l=>{if(!p||!h)return{error:new Error("ユーザーIDと業態形態が必要です")};try{const a=u(),{error:c}=await F.from(a).delete().eq("id",l);if(c)throw c;return w(f=>f.filter(i=>i.id!==l)),{error:null}}catch(a){return console.error("取引の削除に失敗しました:",a),{error:a}}};return m.useEffect(()=>{T()},[T]),{transactions:k,loading:x,fetchTransactions:T,createTransaction:g,updateTransaction:v,deleteTransaction:D}},ve=()=>{const[p,h]=m.useState(!1),[k,w]=m.useState(""),[x,b]=m.useState([]),[u,T]=m.useState(null),[g,v]=m.useState({}),[D,l]=m.useState(!1),[a,c]=m.useState([]),f=m.useRef(null),{user:i}=X(),{currentBusinessType:N}=Y(i==null?void 0:i.id),{transactions:C,createTransaction:L,updateTransaction:A,deleteTransaction:O}=ue(i==null?void 0:i.id,N==null?void 0:N.business_type),_=Z();m.useEffect(()=>{if(!("webkitSpeechRecognition"in window)){console.log("Web Speech API is not supported in this browser.");return}const t=new window.webkitSpeechRecognition;return t.continuous=!1,t.interimResults=!0,t.lang="ja-JP",t.onresult=r=>{for(let s=r.resultIndex;s<r.results.length;s++){const o=r.results[s][0].transcript;r.results[s].isFinal&&w(d=>d+o+" ")}},t.onerror=r=>{console.error("音声認識エラー:",r.error),h(!1)},t.onend=()=>{h(!1)},f.current=t,()=>{f.current&&f.current.stop()}},[]),m.useEffect(()=>{b(C.map(t=>({id:t.id,date:t.date,description:t.description||t.item||"",amount:t.amount,category:t.category,type:t.type,created_at:t.created_at,updated_at:t.updated_at})))},[C]);const B=()=>{f.current&&(f.current.start(),h(!0))},q=()=>{f.current&&(f.current.stop(),h(!1))},M=t=>{const r=/(\d+(?:万)?(?:千)?(?:円)?)/g,s=t.match(r),o=[{keywords:["売上"],category:"売上",type:"income",priority:10},{keywords:["給与"],category:"給与",type:"income",priority:9},{keywords:["交通費","電車","バス","タクシー"],category:"交通費",type:"expense",priority:7},{keywords:["食費","ランチ","ディナー","コーヒー"],category:"食費",type:"expense",priority:6},{keywords:["消耗品","文具","コピー"],category:"消耗品費",type:"expense",priority:5},{keywords:["接待","会食"],category:"接待交際費",type:"expense",priority:5},{keywords:["通信費","電話料金"],category:"通信費",type:"expense",priority:4},{keywords:["光熱費","電気","ガス","水道"],category:"水道光熱費",type:"expense",priority:4},{keywords:["費用","費"],category:"雑費",type:"expense",priority:1}];let d="未分類",E="expense",n=0;for(const j of o)for(const S of j.keywords)t.includes(S)&&j.priority>n&&(d=j.category,E=j.type,n=j.priority);let y=0;if(s&&s.length>0){const j=s[0];if(j.includes("万")){const S=parseFloat(j.replace("万",""));y=isNaN(S)?0:S*1e4}else if(j.includes("千")){const S=parseFloat(j.replace("千",""));y=isNaN(S)?0:S*1e3}else y=parseFloat(j.replace(/[^\d]/g,""))||0}return{date:new Date().toISOString().split("T")[0],description:t,amount:y,category:d,type:E}},U=()=>{k.trim()&&(l(!0),setTimeout(()=>{const t=M(k),r={id:Date.now().toString(),...t};b(s=>[r,...s]),w(""),l(!1)},1e3))},V=t=>{T(t.id),v(t)},W=async()=>{if(u&&g)try{const t=await A(u,{date:g.date||"",item:g.description||"",amount:g.amount||0,category:g.category||"未分類",type:g.type||"expense"});if(t.error)throw t.error;b(r=>r.map(s=>s.id===u?{...s,...g}:s)),T(null),v({})}catch(t){console.error("取引の更新に失敗しました:",t),alert("取引の更新に失敗しました: "+t.message)}},H=async t=>{try{const r=await O(t);if(r.error)throw r.error;b(s=>s.filter(o=>o.id!==t)),c(s=>s.filter(o=>o!==t))}catch(r){console.error("取引の削除に失敗しました:",r),alert("取引の削除に失敗しました: "+r.message)}},$=async t=>{var r;try{if(!i)throw new Error("ユーザーがログインしていません。ログインしてください。");const s={item:t.description,amount:t.amount,date:t.date,category:t.category,type:t.type,description:t.description,creator:i.id},o=await L(s);if(o.error)throw o.error;return(r=o.data)==null?void 0:r.id}catch(s){throw console.error("取引の保存中にエラーが発生しました:",s),s.message.includes("Failed to fetch")?new Error("ネットワークエラーが発生しました。インターネット接続を確認してください。"):s}},J=async t=>{try{await $(t),b(r=>r.filter(s=>s.id!==t.id)),alert("取引が正常に記録されました")}catch(r){if(console.error("取引の記録に失敗しました:",r),r.message.includes("認証セッションが切れました")){alert("認証セッションが切れました。ログインページにリダイレクトします。"),_("/login");return}alert("取引の記録に失敗しました: "+r.message)}},K=async()=>{const t=x.filter(r=>a.includes(r.id));if(t.length===0){alert("記録する取引を選択してください");return}try{const r=t.map(n=>$(n)),s=await Promise.allSettled(r),o=s.filter(n=>n.status==="fulfilled").length,d=s.filter(n=>n.status==="rejected").length;s.forEach((n,y)=>{if(n.status==="rejected"&&(console.error(`取引記録失敗 (${y+1}):`,n.reason),n.reason.message.includes("認証セッションが切れました"))){alert("認証セッションが切れました。ログインページにリダイレクトします。"),_("/login");return}}),d>0?alert(`${o}件の取引が正常に記録されましたが、${d}件の取引の記録に失敗しました。詳細はコンソールを確認してください。`):alert(`${o}件の取引が正常に記録されました`);const E=s.map((n,y)=>({result:n,index:y})).filter(({result:n})=>n.status==="fulfilled").map(({index:n})=>t[n].id);b(n=>n.filter(y=>!E.includes(y.id))),c(n=>n.filter(y=>!E.includes(y)))}catch(r){console.error("取引の一括記録中にエラーが発生しました:",r),alert("取引の一括記録に失敗しました: "+r.message)}},z=t=>{c(r=>r.includes(t)?r.filter(s=>s!==t):[...r,t])},G=()=>{a.length===x.length&&x.length>0?c([]):c(x.map(t=>t.id))},Q=()=>{const t=[["日付","説明","金額","カテゴリ","タイプ"],...x.map(d=>[d.date,`"${d.description}"`,d.amount.toString(),d.category,d.type])].map(d=>d.join(",")).join(`
`),r=new Blob(["\uFEFF",t],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(r),o=document.createElement("a");o.setAttribute("href",s),o.setAttribute("download",`取引データ_${new Date().toISOString().split("T")[0]}.csv`),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)};return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(ee,{to:"/dashboard",className:"mr-4",children:e.jsx(se,{className:"w-6 h-6 text-text-muted hover:text-text-main"})}),e.jsx("h1",{className:"text-2xl font-bold text-text-main",children:"CHAT-TO-BOOK"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-surface rounded-xl shadow-sm border border-border p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-text-main mb-4",children:"音声入力"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("button",{onClick:p?q:B,className:`flex items-center justify-center w-16 h-16 rounded-full ${p?"bg-red-500 hover:bg-red-600":"bg-primary hover:bg-primary/90"} text-white transition-colors shadow-lg shadow-primary/25`,children:p?e.jsx(ae,{className:"w-8 h-8"}):e.jsx(me,{className:"w-8 h-8"})})}),e.jsx("div",{className:"text-center mb-4",children:e.jsx("p",{className:"text-sm text-text-muted",children:p?"音声認識中...":"マイクボタンをクリックして開始"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-text-muted mb-2",children:"認識テキスト"}),e.jsx("textarea",{value:k,onChange:t=>w(t.target.value),rows:4,className:"w-full px-3 py-2 bg-background border border-border rounded-md text-text-main focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"音声認識されたテキストがここに表示されます..."})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:U,disabled:!k.trim()||D,className:`flex items-center px-4 py-2 rounded-md transition-colors ${!k.trim()||D?"bg-surface-highlight text-text-muted cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700"}`,children:D?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"処理中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"取引に変換"]})})})]}),e.jsxs("div",{className:"bg-surface rounded-xl shadow-sm border border-border p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-text-main mb-4",children:"取引一覧"}),e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("p",{className:"text-sm text-text-muted",children:[x.length,"件の取引"]}),a.length>0&&e.jsxs("span",{className:"text-sm text-primary",children:[a.length,"件選択中"]})]}),e.jsxs("div",{className:"flex space-x-2",children:[a.length>0&&e.jsxs("button",{onClick:K,className:"flex items-center px-3 py-1 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 transition-colors",children:[e.jsx(P,{className:"w-4 h-4 mr-1"}),"一括記録 (",a.length,")"]}),e.jsxs("button",{onClick:Q,disabled:x.length===0,className:`flex items-center px-3 py-1 rounded-md text-sm transition-colors ${x.length===0?"bg-surface-highlight text-text-muted cursor-not-allowed":"bg-primary text-white hover:bg-primary/90"}`,children:[e.jsx(oe,{className:"w-4 h-4 mr-1"}),"CSVエクスポート"]})]})]}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-surface-highlight",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:e.jsx("button",{onClick:G,className:"flex items-center",children:a.length===x.length&&x.length>0?e.jsx(P,{className:"w-4 h-4 text-primary"}):e.jsx(I,{className:"w-4 h-4 text-text-muted"})})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"日付"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"説明"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"金額"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"カテゴリ"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider",children:"操作"})]})}),e.jsx("tbody",{className:"bg-surface divide-y divide-border",children:x.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("button",{onClick:()=>z(t.id),className:"flex items-center",children:a.includes(t.id)?e.jsx(P,{className:"w-5 h-5 text-primary"}):e.jsx(I,{className:"w-5 h-5 text-text-muted"})})}),e.jsx("td",{className:"px-4 py-3 text-sm text-text-main",children:u===t.id?e.jsx("input",{type:"date",value:g.date||t.date,onChange:r=>v(s=>({...s,date:r.target.value})),className:"w-full px-2 py-1 bg-background border border-border rounded text-sm text-text-main"}):t.date}),e.jsx("td",{className:"px-4 py-3 text-sm text-text-main max-w-xs",children:u===t.id?e.jsx("input",{type:"text",value:g.description||t.description,onChange:r=>v(s=>({...s,description:r.target.value})),className:"w-full px-2 py-1 bg-background border border-border rounded text-sm text-text-main"}):t.description}),e.jsx("td",{className:"px-4 py-3 text-sm text-text-main",children:u===t.id?e.jsx("input",{type:"number",value:g.amount||t.amount,onChange:r=>v(s=>({...s,amount:Number(r.target.value)})),className:"w-full px-2 py-1 bg-background border border-border rounded text-sm text-text-main"}):e.jsxs("span",{className:t.type==="income"?"text-green-500":"text-red-500",children:[t.type==="income"?"+":"-","¥",t.amount.toLocaleString()]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-text-main",children:u===t.id?e.jsxs("select",{value:g.category||t.category,onChange:r=>v(s=>({...s,category:r.target.value})),className:"w-full px-2 py-1 bg-background border border-border rounded text-sm text-text-main",children:[e.jsx("option",{value:"売上",children:"売上"}),e.jsx("option",{value:"給与",children:"給与"}),e.jsx("option",{value:"交通費",children:"交通費"}),e.jsx("option",{value:"食費",children:"食費"}),e.jsx("option",{value:"消耗品費",children:"消耗品費"}),e.jsx("option",{value:"接待交際費",children:"接待交際費"}),e.jsx("option",{value:"通信費",children:"通信費"}),e.jsx("option",{value:"水道光熱費",children:"水道光熱費"}),e.jsx("option",{value:"雑費",children:"雑費"}),e.jsx("option",{value:"未分類",children:"未分類"})]}):t.category}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium",children:u===t.id?e.jsx("button",{onClick:W,className:"text-green-500 hover:text-green-600 mr-2",children:e.jsx(ce,{className:"w-4 h-4"})}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>J(t),className:"text-green-500 hover:text-green-600 mr-2",children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>V(t),className:"text-primary hover:text-primary/80 mr-2",children:e.jsx(ie,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>H(t.id),className:"text-red-500 hover:text-red-600",children:e.jsx(re,{className:"w-4 h-4"})})]})})]},t.id))})]}),x.length===0&&e.jsxs("div",{className:"text-center py-8 text-text-muted",children:[e.jsx("p",{children:"まだ取引がありません"}),e.jsx("p",{className:"text-sm mt-2",children:"音声入力で取引を追加してください"})]})]})]})]}),e.jsxs("div",{className:"bg-surface rounded-xl shadow-sm border border-border p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-text-main mb-4",children:"使い方"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"border border-border rounded-lg p-4",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center mb-3",children:e.jsx("span",{className:"text-primary font-bold",children:"1"})}),e.jsx("h3",{className:"font-medium text-text-main mb-2",children:"音声入力開始"}),e.jsx("p",{className:"text-sm text-text-muted",children:"マイクボタンをクリックして、取引内容を話してください。"})]}),e.jsxs("div",{className:"border border-border rounded-lg p-4",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center mb-3",children:e.jsx("span",{className:"text-primary font-bold",children:"2"})}),e.jsx("h3",{className:"font-medium text-text-main mb-2",children:"テキスト確認"}),e.jsx("p",{className:"text-sm text-text-muted",children:"認識されたテキストを確認・編集してください。"})]}),e.jsxs("div",{className:"border border-border rounded-lg p-4",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center mb-3",children:e.jsx("span",{className:"text-primary font-bold",children:"3"})}),e.jsx("h3",{className:"font-medium text-text-main mb-2",children:"取引に変換"}),e.jsx("p",{className:"text-sm text-text-muted",children:"「取引に変換」ボタンをクリックして、取引を登録してください。"})]})]})]})]})})};export{ve as default};
